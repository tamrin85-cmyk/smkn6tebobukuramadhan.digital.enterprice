<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buku Ramadhan SMKN 6 Tebo Digital Enterprise</title>
  
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  
<style>
    /* =========================================
       BASE STYLES
       ========================================= */
    * {
      font-family: 'Inter', sans-serif;
      box-sizing: border-box;
    }
    
    body {
        /* BACKGROUND TEMA RAMADHAN */
        background: linear-gradient(rgba(13, 148, 136, 0.4), rgba(0, 0, 0, 0.8)), 
                    url('https://marketplace.canva.com/EAGhR7WT9hs/1/0/1600w/canva-wallpaper-desktop-ramadan-ornamental-elegan-hijau-emas-g55LAMTtJE4.jpg');
        
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-attachment: fixed;
        min-height: 100vh;
        margin: 0;
        padding: 0;
    }
    
    /* =========================================
       COMPONENTS
       ========================================= */
    .glass-effect {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .card-hover {
      transition: all 0.3s ease;
    }
    
    .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      transform: scale(1.02);
      box-shadow: 0 10px 20px rgba(16, 185, 129, 0.4);
    }

    /* =========================================
       SIDEBAR & LAYOUT
       ========================================= */
    .sidebar {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 50;
    }
    
    /* Desktop Collapsed State */
    .sidebar.collapsed {
      width: 80px !important;
    }
    
    .sidebar-text {
      transition: opacity 0.2s ease;
      white-space: nowrap;
    }
    
    .sidebar.collapsed .sidebar-text {
      opacity: 0;
      width: 0;
      overflow: hidden;
      display: none;
    }

    /* Main Content Transition */
    #mainContent {
      transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* =========================================
       UTILITIES (Loading, Toast, Scrollbar)
       ========================================= */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      min-width: 300px;
      animation: slideIn 0.3s ease;
      background: white;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(2px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9998;
    }
    
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid #10b981;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f1f1; 
    }
    ::-webkit-scrollbar-thumb {
      background: #cbd5e1; 
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8; 
    }

    /* =========================================
       MOBILE RESPONSIVE (@MEDIA QUERY)
       ========================================= */
    @media (max-width: 768px) {
      /* 1. Sidebar Default Hidden di Mobile */
      #sidebar {
        transform: translateX(-100%); /* Geser keluar layar kiri */
        width: 280px !important;      /* Lebar tetap saat muncul */
      }

      /* 2. Sidebar saat menu dibuka (Class ini ditoggle via JS) */
      #sidebar.mobile-open {
        transform: translateX(0);     /* Geser masuk layar */
        box-shadow: 5px 0 25px rgba(0,0,0,0.5);
      }

      /* 3. Main Content Full Width */
      #mainContent {
        margin-left: 0 !important;    /* Hapus margin kiri desktop */
        width: 100%;
        padding-bottom: 80px;         /* Tambah padding bawah agar scroll enak */
      }

      /* 4. Login Page Adjustments */
      #loginPage {
        padding: 1rem;
      }
      
      .glass-effect {
        padding: 1.5rem;
      }

      /* 5. Mobile Overlay (Latar gelap saat menu buka) */
      .mobile-overlay {
        display: none; /* Default hidden */
      }
      
      .mobile-overlay.show {
        display: block; /* Show via JS */
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      /* 6. Typography Adjustments */
      h1#pageTitle {
        font-size: 1.25rem; /* Perkecil judul halaman */
      }
      
      .card-hover:hover {
        transform: none; /* Matikan efek hover naik di HP */
      }
    }

/* ANIMASI BADGE & STREAK */
    @keyframes bounce-in {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); opacity: 1; }
    }
    
    .badge-icon {
      animation: bounce-in 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }
    
    .streak-fire {
      filter: drop-shadow(0 0 5px rgba(249, 115, 22, 0.6));
      animation: pulse-fire 2s infinite;
    }
    
    @keyframes pulse-fire {
      0% { transform: scale(1); filter: drop-shadow(0 0 2px rgba(249, 115, 22, 0.4)); }
      50% { transform: scale(1.1); filter: drop-shadow(0 0 10px rgba(249, 115, 22, 0.8)); }
      100% { transform: scale(1); filter: drop-shadow(0 0 2px rgba(249, 115, 22, 0.4)); }
    }
</style>
</head>
<body>
  
  <div id="loginPage" class="min-h-screen flex items-center justify-center p-4 relative z-10 transition-all duration-500">
    
    <div class="max-w-md w-full bg-white/10 backdrop-blur-md rounded-3xl shadow-2xl border border-white/20 p-8 relative overflow-hidden animate-fade-in-up">
      
      <div class="absolute -top-20 -left-20 w-40 h-40 bg-emerald-500/20 rounded-full blur-3xl animate-pulse"></div>
      <div class="absolute -bottom-20 -right-20 w-40 h-40 bg-teal-500/20 rounded-full blur-3xl animate-pulse delay-700"></div>

      <div class="text-center mb-8 relative z-10">
        
        <div class="w-24 h-24 mx-auto mb-4 flex items-center justify-center relative group">
           
           <? var logoUrl = initialData.superLogo; ?>
           <? var hasLogo = (logoUrl && logoUrl !== ''); ?>

           <div id="defaultLogo" class="w-20 h-20 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl flex items-center justify-center shadow-lg ring-4 ring-white/10 transform group-hover:scale-105 transition-all duration-300 <? if(hasLogo) { ?> hidden <? } ?>">
              <i class="fas fa-mosque text-white text-3xl"></i>
           </div>

           <img id="schoolLogoImg" src="<?= hasLogo ? logoUrl : '' ?>" alt="Logo Sekolah" 
                class="w-full h-full object-contain drop-shadow-xl transition-transform duration-300 hover:scale-105 <? if(!hasLogo) { ?> hidden <? } ?>"
                onerror="this.classList.add('hidden'); document.getElementById('defaultLogo').classList.remove('hidden');">
        
        </div>
        
        <h1 id="dynamicAppTitle" class="text-2xl font-extrabold text-white tracking-tight mb-1 drop-shadow-sm">
          <?= initialData.appTitle ?>
        </h1>
        <p id="dynamicAppSubtitle" class="text-emerald-100 text-xs font-medium tracking-widest uppercase opacity-80">
          <?= initialData.appSubtitle ?>
        </p>
      </div>

      <form id="loginForm" class="space-y-5 relative z-10">
        
        <div class="space-y-1">
          <label class="text-xs font-semibold text-emerald-50 ml-1 uppercase tracking-wider">Sekolah</label>
          <div class="relative group">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
              <i class="fas fa-school text-emerald-200 group-focus-within:text-emerald-400 transition-colors"></i>
            </div>
            <select id="schoolSelect" 
              class="w-full bg-black/20 text-white pl-12 pr-4 py-3.5 rounded-xl border border-white/10 focus:border-emerald-400 focus:ring-2 focus:ring-emerald-400/50 outline-none transition-all placeholder-emerald-100/50 appearance-none cursor-pointer">
              <option value="" class="text-slate-300">-- Memuat Data... --</option>
            </select>
            <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none">
              <i class="fas fa-chevron-down text-emerald-200/70 text-xs"></i>
            </div>
          </div>
        </div>

        <div class="space-y-1">
          <label class="text-xs font-semibold text-emerald-50 ml-1 uppercase tracking-wider">ID Pengguna / NIS</label>
          <div class="relative group">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
              <i class="fas fa-user text-emerald-200 group-focus-within:text-emerald-400 transition-colors"></i>
            </div>
            <input type="text" id="usernameInput" placeholder="Masukkan ID atau NIS" required
              class="w-full bg-black/20 text-white pl-12 pr-4 py-3.5 rounded-xl border border-white/10 focus:border-emerald-400 focus:ring-2 focus:ring-emerald-400/50 outline-none transition-all placeholder-emerald-100/30">
          </div>
        </div>

        <div class="space-y-1">
          <label class="text-xs font-semibold text-emerald-50 ml-1 uppercase tracking-wider">Password</label>
          <div class="relative group">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
              <i class="fas fa-lock text-emerald-200 group-focus-within:text-emerald-400 transition-colors"></i>
            </div>
            <input type="password" id="passwordInput" placeholder="Masukkan Password" required
              class="w-full bg-black/20 text-white pl-12 pr-12 py-3.5 rounded-xl border border-white/10 focus:border-emerald-400 focus:ring-2 focus:ring-emerald-400/50 outline-none transition-all placeholder-emerald-100/30">
            
            <div class="absolute inset-y-0 right-0 pr-4 flex items-center cursor-pointer z-20" id="togglePassword">
               <i class="fas fa-eye text-emerald-200 hover:text-white transition-colors" id="eyeIcon"></i>
            </div>
          </div>
        </div>

        <button type="submit" 
          class="w-full bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-400 hover:to-emerald-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-emerald-900/20 transform transition-all duration-300 hover:scale-[1.02] active:scale-[0.98] mt-4 flex items-center justify-center space-x-2 group">
          <span>Masuk Sekarang</span>
          <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
        </button>

      </form>

      <div class="text-center mt-8">
        <p class="text-emerald-100/60 text-xs">
          &copy; 2026 Platform Pendidikan Digital SMKN 6 Tebo
        </p>
      </div>

    </div>
  </div>

  <div id="appContainer" class="hidden">
    
    <div id="mobileOverlay" class="mobile-overlay fixed inset-0 bg-black/50 z-40 hidden backdrop-blur-sm transition-opacity" onclick="toggleSidebar()"></div>

    <div id="sidebar" class="sidebar fixed left-0 top-0 h-full bg-slate-900 text-white shadow-2xl z-50 transform transition-transform duration-300" style="width: 280px;">
      <div class="p-6 border-b border-slate-700 flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-emerald-500 rounded-xl flex items-center justify-center">
            <i class="fas fa-mosque text-white"></i>
          </div>
          <div class="sidebar-text">
            <h2 class="font-bold text-lg">Ramadhan</h2>
            <p class="text-xs text-slate-400">Enterprise</p>
          </div>
        </div>
        <button onclick="toggleSidebar()" class="text-slate-400 hover:text-white focus:outline-none">
          <i class="fas fa-bars"></i>
        </button>
      </div>
      
      <div class="p-4">
        <div class="bg-emerald-500/20 rounded-xl p-4 mb-4 border border-emerald-500/30">
          <div class="flex items-center space-x-3">
            <div class="w-12 h-12 bg-emerald-500 rounded-full flex items-center justify-center text-white font-bold text-lg">
              <span id="userInitial">U</span>
            </div>
            <div class="sidebar-text flex-1 min-w-0">
              <p id="userName" class="font-semibold text-sm truncate">User</p>
              <p id="userRole" class="text-xs text-emerald-300">Role</p>
            </div>
          </div>
        </div>
        
        <nav id="sidebarNav" class="space-y-2">
          </nav>
        
        <button onclick="handleLogout()" class="w-full mt-4 bg-red-500/20 hover:bg-red-500/30 text-red-300 rounded-xl py-3 px-4 flex items-center justify-center space-x-2 transition">
          <i class="fas fa-sign-out-alt"></i>
          <span class="sidebar-text">Logout</span>
        </button>
      </div>
    </div>

    <div id="mainContent" class="transition-all duration-300" style="margin-left: 280px; min-height: 100vh; background: #f1f5f9;">
      <div class="bg-white shadow-sm border-b border-slate-200 px-6 py-4 flex items-center justify-between sticky top-0 z-30">
        <div>
          <h1 id="pageTitle" class="text-2xl font-bold text-slate-800">Dashboard</h1>
          <p id="pageSubtitle" class="text-sm text-slate-500">Selamat datang kembali</p>
        </div>
        <div class="flex items-center space-x-4">
          <div class="text-right hidden md:block"> <p class="text-sm font-medium text-slate-700" id="schoolNameDisplay">-</p>
            <p class="text-xs text-slate-500">Ramadhan 1447 H</p>
          </div>
          <button onclick="toggleSidebar()" class="md:hidden text-slate-600 hover:text-emerald-600">
            <i class="fas fa-bars text-xl"></i>
          </button>
        </div>
      </div>

      <div id="contentArea" class="p-4 md:p-6">
        </div>
    </div>
  </div>

  <div id="loadingOverlay" class="loading-overlay hidden">
    <div class="text-center">
      <div class="spinner mx-auto"></div>
      <p class="text-white mt-4 font-medium">Memuat...</p>
    </div>
  </div>

  <div id="toastContainer"></div>

  <div id="schoolModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeSchoolModal()"></div>
    
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg relative z-10 overflow-hidden transform transition-all scale-100 p-0 animate-fade-in-up">
      <div class="bg-emerald-600 p-4 flex justify-between items-center">
        <h3 id="schoolModalTitle" class="text-white font-bold text-lg">
          <i class="fas fa-school mr-2"></i>Form Sekolah
        </h3>
        <button onclick="closeSchoolModal()" class="text-white/70 hover:text-white transition">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <form id="schoolForm" class="p-6 space-y-4">
        <input type="hidden" id="modal_schoolId">
        <input type="hidden" id="modal_mode"> 
        
        <div>
          <label class="block text-slate-600 font-bold text-sm mb-1">Nama Sekolah</label>
          <input type="text" id="modal_schoolName" required 
            class="w-full px-4 py-2 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500"
            placeholder="Contoh: SMA Negeri 1 Jakarta">
        </div>

        <div>
          <label class="block text-slate-600 font-bold text-sm mb-1">Alamat Lengkap</label>
          <textarea id="modal_schoolAddress" required rows="3"
            class="w-full px-4 py-2 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500"
            placeholder="Jalan..."></textarea>
        </div>

        <div id="modal_statusContainer" class="hidden">
          <label class="block text-slate-600 font-bold text-sm mb-1">Status</label>
          <select id="modal_schoolStatus" class="w-full px-4 py-2 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>

        <div class="flex justify-end space-x-3 pt-4 border-t border-slate-100">
          <button type="button" onclick="closeSchoolModal()" 
            class="px-4 py-2 rounded-xl text-slate-600 hover:bg-slate-100 font-medium transition">
            Batal
          </button>
          <button type="submit" 
            class="px-6 py-2 rounded-xl bg-emerald-600 text-white font-bold hover:bg-emerald-700 shadow-lg shadow-emerald-500/30 transition transform active:scale-95">
            Simpan Data
          </button>
        </div>
      </form>
    </div>
  </div>

<div id="adminModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeAdminModal()"></div>
    
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg relative z-10 overflow-hidden transform transition-all scale-100 p-0 animate-fade-in-up">
      
      <div class="bg-emerald-600 p-4 flex justify-between items-center">
        <h3 id="adminModalTitle" class="text-white font-bold text-lg">
          <i class="fas fa-user-shield mr-2"></i>Form Pengelola
        </h3>
        <button onclick="closeAdminModal()" class="text-white/70 hover:text-white transition">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <form id="adminForm" class="p-6 space-y-4">
        <input type="hidden" id="admin_mode">
        <input type="hidden" id="admin_userId">

        <div>
          <label class="block text-slate-600 font-bold text-sm mb-1">Username (Login ID)</label>
          <input type="text" id="admin_username" required 
            class="w-full px-4 py-2 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white"
            placeholder="Contoh: guru_pai">
          <p class="text-[10px] text-slate-400 mt-1">*Digunakan untuk login</p>
        </div>

        <div>
          <label class="block text-slate-600 font-bold text-sm mb-1">Nama Lengkap</label>
          <input type="text" id="admin_name" required 
            class="w-full px-4 py-2 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500"
            placeholder="Nama Lengkap...">
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-slate-600 font-bold text-sm mb-1">Role</label>
              <select id="admin_roleSelect" onchange="toggleAdminClassInput(this.value)" class="w-full px-4 py-2 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white">
                 <option value="admin">Admin Sekolah</option>
                 <option value="walikelas">Wali Kelas</option>
              </select>
            </div>
            
            <div id="admin_classContainer" class="hidden">
              <label class="block text-slate-600 font-bold text-sm mb-1">Pegang Kelas</label>
              <select id="admin_classSelect" class="w-full px-4 py-2 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white">
                 <option value="-">-- Pilih Kelas --</option>
              </select>
            </div>
        </div>

        <div>
          <label class="block text-slate-600 font-bold text-sm mb-1">Sekolah</label>
          <select id="admin_schoolSelect" required onchange="loadClassesForAdminModal(this.value)" class="w-full px-4 py-2 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white">
             <option value="">-- Pilih Sekolah --</option>
          </select>
        </div>

        <div>
          <label class="block text-slate-600 font-bold text-sm mb-1">Password</label>
          <input type="text" id="admin_password" 
            class="w-full px-4 py-2 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500"
            placeholder="Masukkan Password">
          <p id="admin_password_hint" class="text-[10px] text-slate-400 mt-1 hidden">*Kosongkan jika tidak ingin mengubah password</p>
        </div>

        <div id="admin_statusContainer" class="hidden">
          <label class="block text-slate-600 font-bold text-sm mb-1">Status Akun</label>
          <select id="admin_status" class="w-full px-4 py-2 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>

        <div class="flex justify-end space-x-3 pt-4 border-t border-slate-100">
          <button type="button" onclick="closeAdminModal()" 
            class="px-4 py-2 rounded-xl text-slate-600 hover:bg-slate-100 font-medium transition">
            Batal
          </button>
          <button type="submit" 
            class="px-6 py-2 rounded-xl bg-emerald-600 text-white font-bold hover:bg-emerald-700 shadow-lg shadow-emerald-500/30 transition transform active:scale-95">
            Simpan Data
          </button>
        </div>
      </form>
    </div>
  </div>

  <div id="classModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeClassModal()"></div>
    
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md relative z-10 overflow-hidden transform transition-all scale-100 p-0 animate-fade-in-up">
      <div class="bg-emerald-600 p-4 flex justify-between items-center">
        <h3 id="classModalTitle" class="text-white font-bold text-lg">
          <i class="fas fa-chalkboard mr-2"></i>Form Kelas
        </h3>
        <button onclick="closeClassModal()" class="text-white/70 hover:text-white transition">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <form id="classForm" class="p-6 space-y-4">
        <input type="hidden" id="class_mode">
        <input type="hidden" id="class_id">
        
        <div>
          <label class="block text-slate-600 font-bold text-sm mb-1">Nama Kelas</label>
          <input type="text" id="class_name" required 
            class="w-full px-4 py-2 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white"
            placeholder="Contoh: XII IPA 1">
        </div>

        <div class="flex justify-end space-x-3 pt-4 border-t border-slate-100">
          <button type="button" onclick="closeClassModal()" 
            class="px-4 py-2 rounded-xl text-slate-600 hover:bg-slate-100 font-medium transition">
            Batal
          </button>
          <button type="submit" 
            class="px-6 py-2 rounded-xl bg-emerald-600 text-white font-bold hover:bg-emerald-700 shadow-lg shadow-emerald-500/30 transition transform active:scale-95">
            Simpan
          </button>
        </div>
      </form>
    </div>
  </div>

  <div id="studentModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeStudentModal()"></div>
    
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg relative z-10 overflow-hidden transform transition-all scale-100 p-0 animate-fade-in-up">
      <div class="bg-emerald-600 p-4 flex justify-between items-center">
        <h3 id="studentModalTitle" class="text-white font-bold text-lg">
          <i class="fas fa-user-graduate mr-2"></i>Form Siswa
        </h3>
        <button onclick="closeStudentModal()" class="text-white/70 hover:text-white transition">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>

      <form id="studentForm" class="p-6 space-y-4">
        <input type="hidden" id="student_mode">
        <input type="hidden" id="student_userId">

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-slate-600 font-bold text-sm mb-1">NIS</label>
            <input type="text" id="student_nis" required 
              class="w-full px-4 py-2 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white"
              placeholder="Contoh: 2024001">
          </div>
          <div>
            <label class="block text-slate-600 font-bold text-sm mb-1">Kelas</label>
            <select id="student_classSelect" required class="w-full px-4 py-2 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white">
               <option value="">-- Memuat Kelas... --</option>
            </select>
          </div>
        </div>

        <div>
          <label class="block text-slate-600 font-bold text-sm mb-1">Nama Lengkap</label>
          <input type="text" id="student_name" required 
            class="w-full px-4 py-2 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white"
            placeholder="Nama Siswa">
        </div>

        <div>
          <label class="block text-slate-600 font-bold text-sm mb-1">Password</label>
          <input type="text" id="student_password" 
            class="w-full px-4 py-2 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white"
            placeholder="Password Login">
          <p id="student_password_hint" class="text-[10px] text-slate-400 mt-1 hidden">*Kosongkan jika tidak ingin mengubah password</p>
        </div>

        <div id="student_statusContainer" class="hidden">
          <label class="block text-slate-600 font-bold text-sm mb-1">Status Akun</label>
          <select id="student_status" class="w-full px-4 py-2 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>

        <div class="flex justify-end space-x-3 pt-4 border-t border-slate-100">
          <button type="button" onclick="closeStudentModal()" 
            class="px-4 py-2 rounded-xl text-slate-600 hover:bg-slate-100 font-medium transition">
            Batal
          </button>
          <button type="submit" 
            class="px-6 py-2 rounded-xl bg-emerald-600 text-white font-bold hover:bg-emerald-700 shadow-lg shadow-emerald-500/30 transition transform active:scale-95">
            Simpan Data
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ============================================
    // GLOBAL STATE
    // ============================================
    let schoolDataList = [];
    let systemDefaultLogo = '';
    let currentUser = null;
    let authToken = null;
    let sidebarCollapsed = false;
    let currentPage = 'dashboard';

    // STATE UNTUK MANAJEMEN SISWA
    let globalStudentList = [];
    let currentStudentPage = 1;
    let studentRowsPerPage = 10;
    let studentSearchQuery = '';

    // STATE UNTUK RANKING SEKOLAH
    let globalSchoolRankingList = [];
    let currentSchoolPage = 1;
    let schoolRowsPerPage = 10;
    let schoolSearchQuery = '';

// STATE UNTUK MANAJEMEN ADMIN (BARU)
    let globalAdminList = [];
    let currentAdminPage = 1;
    let adminRowsPerPage = 10;
    let adminSearchQuery = '';

// STATE UNTUK RANKING GLOBAL
    let globalRankingList = [];
    let currentGlobalPage = 1;
    let globalRowsPerPage = 10;
    let globalSearchQuery = '';

// STATE UNTUK LOG AKTIVITAS
    let globalLogList = [];
    let currentLogPage = 1;
    let logRowsPerPage = 10;
    let logSearchQuery = '';

  // === STATE RIWAYAT IBADAH ===
  let globalHistoryList = [];
  let globalMasterData = []; // Untuk menyimpan referensi warna/icon badge
  let currentHistoryPage = 1;
  let historyRowsPerPage = 10;
  let historySearchQuery = '';

  let appCache = {};
    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    function showLoading() {
      document.getElementById('loadingOverlay').classList.remove('hidden');
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.add('hidden');
    }

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast bg-white rounded-xl shadow-2xl p-4 flex items-center space-x-3 border-l-4 ${type === 'success' ? 'border-emerald-500' : 'border-red-500'}`;
      
      const icon = type === 'success' ? 
        '<i class="fas fa-check-circle text-emerald-500 text-2xl"></i>' :
        '<i class="fas fa-exclamation-circle text-red-500 text-2xl"></i>';
      
      toast.innerHTML = `
        ${icon}
        <div class="flex-1">
          <p class="font-semibold text-slate-800">${type === 'success' ? 'Berhasil' : 'Error'}</p>
          <p class="text-sm text-slate-600">${message}</p>
        </div>
        <button onclick="this.parentElement.remove()" class="text-slate-400 hover:text-slate-600">
          <i class="fas fa-times"></i>
        </button>
      `;
      
      document.getElementById('toastContainer').appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 5000);
    }

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('mainContent');
      const overlay = document.getElementById('mobileOverlay');
      const isMobile = window.innerWidth <= 768;

      if (isMobile) {
        // === LOGIKA MOBILE ===
        // Toggle class untuk animasi slide-in/slide-out
        sidebar.classList.toggle('mobile-open');
        overlay.classList.toggle('show');
        
        // Pastikan style inline width/margin tidak mengganggu CSS mobile
        sidebar.style.width = ''; 
        mainContent.style.marginLeft = '';
        
      } else {
        // === LOGIKA DESKTOP (Laptop/PC) ===
        sidebarCollapsed = !sidebarCollapsed;
        
        if (sidebarCollapsed) {
          sidebar.classList.add('collapsed');
          sidebar.style.width = '80px';
          mainContent.style.marginLeft = '80px';
        } else {
          sidebar.classList.remove('collapsed');
          sidebar.style.width = '280px';
          mainContent.style.marginLeft = '280px';
        }
      }
    }

    // ============================================
    // GOOGLE APPS SCRIPT API CALLS
    // ============================================
    function callServerFunction(functionName, ...args) {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          [functionName](...args);
      });
    }

    // ============================================
    // AUTHENTICATION
    // ============================================
    async function initializeLogin() {
      try {
        const result = await callServerFunction('getSchoolsForLogin');
        if (result.success) {
          schoolDataList = result.data;
          
          // Simpan Default Global ke variabel agar bisa di-reset
          systemDefaultLogo = result.superLogo || ''; 
          const defaultTitle = result.appTitle;
          const defaultSubtitle = result.appSubtitle;
          
          const select = document.getElementById('schoolSelect');
          select.innerHTML = '<option value="">-- Pilih Sekolah --</option>';
          
          schoolDataList.forEach(school => {
            const option = document.createElement('option');
            option.value = school.schoolId;
            option.textContent = school.name;
            select.appendChild(option);
          });

          // === LOGIKA GANTI LOGO & TEKS SAAT PILIH SEKOLAH ===
          select.addEventListener('change', function() {
            const selectedId = this.value;
            const selectedSchool = schoolDataList.find(s => s.schoolId === selectedId);
            
            // 1. Update Logo
            const schoolLogo = selectedSchool ? selectedSchool.logo : '';
            updateDisplayLogo(schoolLogo);

            // 2. Update Judul & Subjudul
            const titleEl = document.getElementById('dynamicAppTitle');
            const subtitleEl = document.getElementById('dynamicAppSubtitle');

            if (selectedSchool) {
                // Jika sekolah punya judul khusus, pakai itu. Jika kosong, pakai Default Global.
                titleEl.textContent = selectedSchool.appTitle || defaultTitle;
                subtitleEl.textContent = selectedSchool.appSubtitle || defaultSubtitle;
            } else {
                // Jika pilihan kembali ke "-- Pilih Sekolah --", reset ke Default Global
                titleEl.textContent = defaultTitle;
                subtitleEl.textContent = defaultSubtitle;
            }
          });
          
          // Set tampilan awal
          updateDisplayLogo('');
        }
      } catch (error) {
        console.error('Error loading schools:', error);
      }
    }
    // Fungsi Helper Baru: Mengatur Logika Logo
    function updateDisplayLogo(specificUrl) {
        const imgEl = document.getElementById('schoolLogoImg');
        const iconEl = document.getElementById('defaultLogo');
        
        // LOGIKA PRIORITAS:
        // 1. Jika ada specificUrl (Logo Sekolah terpilih) -> Pakai itu
        // 2. Jika tidak ada, pakai systemDefaultLogo (Logo Super Admin)
        // 3. Jika Super Admin juga tidak punya logo -> null
        const logoToShow = specificUrl || systemDefaultLogo;

        if (logoToShow) {
            // Tampilkan Gambar
            imgEl.src = logoToShow;
            imgEl.classList.remove('hidden');
            iconEl.classList.add('hidden'); // Sembunyikan ikon masjid
        } else {
            // Tampilkan Ikon Masjid (Default jika semua logo kosong)
            imgEl.src = '';
            imgEl.classList.add('hidden');
            iconEl.classList.remove('hidden');
        }
    }

  document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Pastikan ID sesuai: 'usernameInput' sesuai dengan elemen HTML Anda
    const nis = document.getElementById('usernameInput').value; 
    const password = document.getElementById('passwordInput').value;
    let schoolId = document.getElementById('schoolSelect').value;
    
    // LOGIKA PERBAIKAN:
    // Jika NIS adalah superadmin, jangan paksa pilih sekolah
    if (nis.toLowerCase() === 'superadmin') {
      schoolId = 'SUPER'; 
    } else if (!schoolId) {
      // Hanya siswa/admin sekolah yang wajib pilih sekolah
      showToast('Pilih sekolah terlebih dahulu', 'error');
      return;
    }
    
    showLoading();
    
    try {
      const result = await callServerFunction('login', nis, password, schoolId);
      
      if (result.success) {
        authToken = result.token;
        currentUser = result.user;
        
        sessionStorage.setItem('authToken', authToken);
        sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
        
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('appContainer').classList.remove('hidden');
        
        initializeApp();
        showToast('Login berhasil!');
      } else {
        showToast(result.error, 'error');
      }
    } catch (error) {
      showToast('Terjadi kesalahan: ' + error, 'error');
    } finally {
      hideLoading();
    }
  });


function handleLogout() {
    Swal.fire({
      title: 'Yakin ingin logout?',
      text: "Sesi Anda saat ini akan diakhiri.",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#10b981',
      cancelButtonColor: '#ef4444',
      confirmButtonText: 'Ya, Keluar',
      cancelButtonText: 'Batal',
      background: '#fff',
      borderRadius: '1rem'
    }).then((result) => {
      if (result.isConfirmed) {
        
        // 1. Panggil Logout di Server (Opsional, untuk log activity)
        callServerFunction('logout', authToken);
        
        // ============================================
        // [PENTING] BERSIHKAN WIDGET FLOATING
        // ============================================
        // Pastikan widget dihapus sebelum pindah halaman
        if (typeof removeFloatingAnnouncements === 'function') {
            removeFloatingAnnouncements();
        }
        
        // 2. Hapus Sesi Lokal
        sessionStorage.clear();
        authToken = null;
        currentUser = null;
        
        // 3. Update UI (Sembunyikan App, Tampilkan Login)
        document.getElementById('appContainer').classList.add('hidden');
        document.getElementById('loginPage').classList.remove('hidden');

        // 4. Reset Form Login (Agar kosong untuk user berikutnya)
        const loginForm = document.getElementById('loginForm');
        if (loginForm) loginForm.reset();

        // 5. Inisialisasi Ulang Halaman Login
        // (Memastikan dropdown sekolah ter-load ulang dengan benar)
        if (typeof initializeLogin === 'function') {
            initializeLogin(); 
        }
        
        // 6. Tampilkan Pesan Sukses
        Swal.fire({
          title: 'Berhasil Keluar!',
          text: 'Sampai jumpa lagi.',
          icon: 'success',
          timer: 1500,
          showConfirmButton: false,
          confirmButtonColor: '#10b981'
        });
      }
    });
}

    // ============================================
    // APP INITIALIZATION
    // ============================================
    function initializeApp() {
      // Set user info
      document.getElementById('userName').textContent = currentUser.name;
      document.getElementById('userRole').textContent = currentUser.role.toUpperCase();
      document.getElementById('userInitial').textContent = currentUser.name.charAt(0).toUpperCase();
      
      if (currentUser.schoolName) {
        document.getElementById('schoolNameDisplay').textContent = currentUser.schoolName;
      }
      
      // Build menu based on role
      buildMenu();
      
      // Load dashboard
      loadDashboard();
    }

function buildMenu() {
  const nav = document.getElementById('sidebarNav');
  let menuItems = [];
  
  // ============================================
  // 1. MENU UNTUK SUPERADMIN
  // ============================================
  if (currentUser.role === 'superadmin') {
    menuItems = [
      { icon: 'fa-chart-line', text: 'Dashboard Global', page: 'dashboard' },
      { icon: 'fa-bullhorn', text: 'Pengumuman', page: 'announcements' }, // <--- BARU
      { icon: 'fa-school', text: 'Kelola Sekolah', page: 'schools' },
      { icon: 'fa-users-cog', text: 'Kelola Admin', page: 'admins' },
      { icon: 'fa-list-check', text: 'Master Ibadah', page: 'master-ibadah' }, 
      { icon: 'fa-trophy', text: 'Ranking Global', page: 'ranking-global' },
      { icon: 'fa-history', text: 'Log Aktivitas', page: 'logs' }
    ];
  } 
  // ============================================
  // 2. MENU UNTUK ADMIN SEKOLAH
  // ============================================
  else if (currentUser.role === 'admin') {
    menuItems = [
      { icon: 'fa-chart-line', text: 'Dashboard', page: 'dashboard' },
      { icon: 'fa-bullhorn', text: 'Pengumuman', page: 'announcements' }, // <--- BARU
      { icon: 'fa-chalkboard', text: 'Kelola Kelas', page: 'classes' },
      { icon: 'fa-user-graduate', text: 'Kelola Siswa', page: 'students' },
      { icon: 'fa-list-check', text: 'Master Ibadah', page: 'master-ibadah' },
      { icon: 'fa-trophy', text: 'Ranking Sekolah', page: 'ranking-school' },
      { icon: 'fa-file-download', text: 'Download Laporan', page: 'reports' }
    ];
  } 
  // ============================================
  // 3. MENU UNTUK WALI KELAS
  // ============================================
  else if (currentUser.role === 'walikelas') {
    menuItems = [
      { icon: 'fa-chalkboard-user', text: 'Dashboard Kelas', page: 'dashboard' },
      { icon: 'fa-bullhorn', text: 'Pengumuman', page: 'announcements' }, // <--- BARU
      { icon: 'fa-user-graduate', text: 'Kelola Siswa', page: 'students' },
      { icon: 'fa-trophy', text: 'Ranking Kelas', page: 'ranking-class' },
      { icon: 'fa-file-pdf', text: 'Laporan Kelas', page: 'reports' }
    ];
  }
  // ============================================
  // 4. MENU UNTUK SISWA
  // ============================================
  else if (currentUser.role === 'siswa') {
    // Siswa tidak perlu menu Pengumuman karena sudah tampil di Dashboard
    menuItems = [
      { icon: 'fa-home', text: 'Dashboard', page: 'dashboard' },
      { icon: 'fa-check-double', text: 'Checklist Ibadah', page: 'input-ibadah' },
      { icon: 'fa-microphone-alt', text: 'Jurnal Kultum', page: 'input-kultum' },
      { icon: 'fa-history', text: 'Riwayat', page: 'history' },
      { icon: 'fa-trophy', text: 'Ranking Kelas', page: 'ranking-class' }
    ];
  }
  
  // ============================================
  // RENDER HTML MENU
  // ============================================
  nav.innerHTML = menuItems.map(item => `
    <button onclick="navigateTo('${item.page}')" 
      class="nav-item w-full text-left px-4 py-3 rounded-xl hover:bg-slate-800 transition flex items-center space-x-3 group ${currentPage === item.page ? 'bg-emerald-500 text-white shadow-lg shadow-emerald-500/30' : 'text-slate-300'}">
      <div class="w-6 flex justify-center">
        <i class="fas ${item.icon} ${currentPage === item.page ? 'text-white' : 'text-slate-400 group-hover:text-white'} transition-colors"></i>
      </div>
      <span class="sidebar-text font-medium">${item.text}</span>
    </button>
  `).join('');
}

function navigateTo(page) {
  // 1. Update State Halaman
  currentPage = page;
  
  // 2. Refresh Menu (Agar highlight pindah ke menu yang aktif)
  buildMenu(); 
  
  // 3. Mapping Judul Halaman
  const titles = {
    'dashboard': 'Dashboard',
    'announcements': 'Pengumuman', // <--- ITEM BARU
    'input-ibadah': 'Checklist Ibadah', 
    'input-kultum': 'Jurnal Kultum',    
    'history': 'Riwayat Ibadah',
    'ranking-class': 'Ranking Kelas',
    'ranking-school': 'Ranking Sekolah',
    'ranking-global': 'Ranking Global',
    'classes': 'Kelola Kelas',
    'students': 'Kelola Siswa',
    'schools': 'Kelola Sekolah',
    'admins': 'Kelola Admin',
    'master-ibadah': 'Master Data Ibadah',
    'reports': 'Laporan',
    'logs': 'Log Aktivitas'
  };
  
  // Set Judul di Header
  const titleElement = document.getElementById('pageTitle');
  if (titleElement) {
    titleElement.textContent = titles[page] || 'Aplikasi Ramadhan';
  }
  
  // 4. Routing Logic
  switch(page) {
    case 'dashboard':
      loadDashboard(); 
      break;

    // --- FITUR PENGUMUMAN (BARU) ---
    case 'announcements':
      if (typeof loadAnnouncementPage === 'function') loadAnnouncementPage();
      else console.error('Fungsi loadAnnouncementPage belum didefinisikan');
      break;
      
    // --- FITUR SISWA ---
    case 'input-ibadah':
      if (typeof loadInputIbadah === 'function') loadInputIbadah(); 
      else console.error('Fungsi loadInputIbadah belum didefinisikan');
      break;

    case 'input-kultum':
      if (typeof loadInputKultum === 'function') loadInputKultum();
      else console.error('Fungsi loadInputKultum belum didefinisikan');
      break;

    case 'history':
      loadHistory();
      break;
      
    // --- FITUR RANKING ---
    case 'ranking-class':
      loadRankingClass(); 
      break;
    case 'ranking-school':
      loadRankingSchool();
      break;
    case 'ranking-global':
      loadRankingGlobal();
      break;
      
    // --- MANAJEMEN ---
    case 'classes':
      loadClassManagement();
      break;
    case 'students':
      loadStudentManagement(); 
      break;
    case 'schools':
      loadSchoolManagement();
      break;
    case 'admins':
      loadAdminManagement();
      break;
      
    // --- FITUR DATA & LAPORAN ---
    case 'master-ibadah': 
      loadMasterIbadahPage(); 
      break;
    case 'reports':
      loadReports(); 
      break;
    case 'logs':
      if (typeof loadLogs === 'function') loadLogs(); 
      else console.error('Fungsi loadLogs belum didefinisikan');
      break;
      
    default:
      console.warn('Halaman tidak ditemukan:', page);
      loadDashboard(); // Fallback ke dashboard
      break;
  }

  // 5. UX Mobile: Tutup sidebar otomatis setelah navigasi
  if (window.innerWidth <= 768) {
    const sidebar = document.getElementById('sidebar');
    // Jika sidebar sedang terbuka (tidak collapsed logic-nya), tutup
    if (!sidebarCollapsed) { 
       toggleSidebar(); 
    }
  }
}

// ============================================
    // [BARU] FUNGSI PRELOAD DATA (Agar Menu Lain Instan)
    // ============================================
    async function preloadAllData() {
       console.log("Mulai preloading data...");
       
       try {
          const promises = [];
          const role = currentUser.role;

          // 1. DATA UMUM (Master Ibadah) - Semua butuh
          promises.push(callServerFunction('getMasterIbadahList', authToken)
             .then(res => { if(res.success) appCache.masterIbadah = res.data; }));

          // 2. DATA KHUSUS SISWA
          if (role === 'siswa') {
             // Preload History
             promises.push(callServerFunction('getIbadahHistory', authToken, currentUser.userId)
                .then(res => { if(res.success) appCache.history = res.data; }));
             
             // Preload Ranking Kelas
             promises.push(callServerFunction('getRankingClass', authToken, currentUser.classId)
                .then(res => { if(res.success) appCache.rankingClass = res.data; }));

             // Preload Input Ibadah Hari Ini
             const today = new Date().toISOString().split('T')[0];
             promises.push(callServerFunction('getChecklistData', authToken, today)
                .then(res => { if(res.success) appCache.checklistToday = res; }));
             
             promises.push(callServerFunction('getKultumData', authToken, today)
                .then(res => { if(res.success) appCache.kultumToday = res; }));
          }

          // 3. DATA KHUSUS ADMIN
          if (role === 'admin') {
             // Preload Daftar Siswa
             promises.push(callServerFunction('getUsers', authToken, currentUser.schoolId, null)
                .then(res => { if(res.success) appCache.students = res.data.filter(u => u.role === 'siswa'); }));
             
             // Preload Daftar Kelas
             promises.push(callServerFunction('getClasses', authToken, currentUser.schoolId)
                .then(res => { if(res.success) appCache.classes = res.data; }));
             
             // Preload Ranking Sekolah
             promises.push(callServerFunction('getRankingSchool', authToken, currentUser.schoolId)
                .then(res => { if(res.success) appCache.rankingSchool = res.data; }));
          }
          
          // 4. DATA KHUSUS WALI KELAS
          if (role === 'walikelas') {
             // Preload Siswa Kelasnya
             promises.push(callServerFunction('getUsers', authToken, currentUser.schoolId, currentUser.classId)
                .then(res => { if(res.success) appCache.students = res.data.filter(u => u.role === 'siswa'); }));
             
             // Preload Ranking Kelas
             promises.push(callServerFunction('getRankingClass', authToken, currentUser.classId)
                .then(res => { if(res.success) appCache.rankingClass = res.data; }));
          }

          // 5. DATA KHUSUS SUPERADMIN
          if (role === 'superadmin') {
             promises.push(callServerFunction('getSchools', authToken)
                .then(res => { if(res.success) appCache.schools = res.data; }));
             
             promises.push(callServerFunction('getUsers', authToken, null, null)
                .then(res => { if(res.success) appCache.admins = res.data.filter(u => u.role === 'admin' || u.role === 'walikelas'); }));
             
             promises.push(callServerFunction('getRankingGlobal', authToken)
                .then(res => { if(res.success) appCache.rankingGlobal = res.data; }));
          }

          // Jalankan semua fetch secara paralel
          await Promise.all(promises);
          console.log("Preloading selesai! Data tersimpan di appCache.", appCache);

       } catch (e) {
          console.error("Gagal preloading:", e);
       }
    }
    // ============================================
    // DASHBOARD PAGES
    // ============================================
async function loadDashboard() {
      showLoading();
      const content = document.getElementById('contentArea');
      
      try {
        // 1. Muat Dashboard Utama sesuai Role (Menggunakan AWAIT agar selesai dulu)
        if (currentUser.role === 'siswa') {
          await loadSiswaDashboard();
        } else if (currentUser.role === 'admin') {
          await loadAdminDashboard();
        } else if (currentUser.role === 'superadmin') {
          await loadSuperAdminDashboard();
        } else if (currentUser.role === 'walikelas') { 
          await loadWaliKelasDashboard();
        }

        // 2. [BARU] Panggil Preload Data di Background
        // Kita TIDAK menggunakan 'await' di sini. 
        // Tujuannya agar fungsi loadDashboard segera selesai, hideLoading() berjalan,
        // dan user bisa langsung melihat dashboard sementara data lain ditarik di background.
        if (typeof preloadAllData === 'function') {
            preloadAllData(); 
        }

      } catch (error) {
        content.innerHTML = `<div class="text-center text-red-500">Error: ${error}</div>`;
      } finally {
        hideLoading();
      }
    }
async function loadSiswaDashboard() {
  showLoading();

  try {
    // 1. Ambil Data Dashboard, Tanggal Start Ramadhan, dan PENGUMUMAN dari Server (Parallel)
    const [dashboardRes, dateRes, annRes] = await Promise.all([
      callServerFunction('getDashboardData', authToken),
      callServerFunction('getRamadhanStartDate', authToken),
      callServerFunction('getStudentAnnouncements', authToken) // <--- Fetch Pengumuman
    ]);

    if (!dashboardRes.success) {
      showToast(dashboardRes.error, 'error');
      return;
    }

    const data = dashboardRes.data;
    const masterList = data.masterList || []; // List definisi ibadah
    const chartCounts = data.chartData || {}; // Hasil hitungan
    
    // [BARU] Ambil data gamifikasi dari response
    const streak = data.streak || 0;
    const myBadges = data.badges || [];

    // 2. Hitung "Hari Ke-Berapa" Ramadhan
    // Default tanggal hari ini jika admin belum set
    const startDateStr = dateRes.success ? dateRes.date : new Date().toISOString().split('T')[0];

    const start = new Date(startDateStr);
    const now = new Date();

    // Reset jam agar hitungan murni hari (00:00:00)
    start.setHours(0, 0, 0, 0);
    now.setHours(0, 0, 0, 0);

    // Hitung selisih hari
    const diffTime = now - start;
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 karena hari H = hari ke-1

    // Logic teks tampilan & progress bar
    let hariText = "";
    let progressVal = 0;

    if (diffDays < 1) {
      hariText = `Menuju Ramadhan (${Math.abs(diffDays - 1)} hari lagi)`;
      progressVal = 0;
    } else if (diffDays > 30) {
      hariText = `Ramadhan Selesai (Hari ke-${diffDays})`;
      progressVal = 100;
    } else {
      hariText = `Ramadhan Hari ke-${diffDays}`;
      progressVal = Math.min((diffDays / 30) * 100, 100);
    }

    // ============================================
    // 3. GENERATE KARTU STATISTIK KECIL (DINAMIS)
    // ============================================
    let statsCardsHtml = '';
    if (masterList.length > 0) {
      statsCardsHtml = masterList.map(item => {
        const count = chartCounts[item.key] || 0;
        const bgClass = `bg-${item.color}-50`;
        const borderClass = `border-${item.color}-200`;
        const textClass = `text-${item.color}-600`;

        return `
            <div class="${bgClass} rounded-xl p-4 border ${borderClass} flex flex-col items-center justify-center text-center transition hover:scale-105">
              <p class="text-2xl font-bold ${textClass}">${count}</p>
              <p class="text-xs text-slate-600 font-medium truncate w-full">${item.name}</p>
            </div>
          `;
      }).join('');
    } else {
      statsCardsHtml = '<p class="text-slate-500 text-sm col-span-2">Belum ada Master Ibadah.</p>';
    }

    // ============================================
    // 4. GENERATE PENGUMUMAN (FLOATING WIDGET)
    // ============================================
    const announcements = (annRes.success) ? annRes.data : [];
    renderFloatingAnnouncements(announcements);

    // ============================================
    // [BARU] 4.5. GENERATE BADGES HTML
    // ============================================
    const badgeMaster = {
       'early_bird': { name: 'Early Bird', icon: 'fa-dove', color: 'text-sky-500', bg: 'bg-sky-100' },
       'full_fasting': { name: 'Full Fasting', icon: 'fa-medal', color: 'text-yellow-500', bg: 'bg-yellow-100' }
    };

    let badgesHtml = '';
    if (myBadges.length > 0) {
       badgesHtml = myBadges.map(key => {
          const info = badgeMaster[key] || { name: 'Award', icon: 'fa-star', color: 'text-gray-500', bg: 'bg-gray-100' };
          return `
             <div class="flex flex-col items-center p-3 rounded-xl ${info.bg} border border-white shadow-sm badge-icon transform hover:scale-105 transition" title="${info.name}">
                <i class="fas ${info.icon} ${info.color} text-2xl mb-1"></i>
                <span class="text-[10px] font-bold text-slate-600 text-center leading-tight line-clamp-2">${info.name}</span>
             </div>
          `;
       }).join('');
    } else {
       badgesHtml = `<p class="text-xs text-slate-400 italic col-span-full text-center py-4 flex flex-col items-center justify-center w-full">
         <i class="fas fa-award text-slate-300 text-2xl mb-1"></i>
         Belum ada badge. Terus semangat!
       </p>`;
    }

    // ============================================
    // 5. PREPARE CHART DATA
    // ============================================
    const colorMap = {
      'emerald': 'rgba(16, 185, 129, 0.7)',
      'blue': 'rgba(59, 130, 246, 0.7)',
      'purple': 'rgba(168, 85, 247, 0.7)',
      'orange': 'rgba(249, 115, 22, 0.7)',
      'pink': 'rgba(236, 72, 153, 0.7)',
      'red': 'rgba(239, 68, 68, 0.7)',
      'yellow': 'rgba(234, 179, 8, 0.7)',
      'teal': 'rgba(20, 184, 166, 0.7)',
      'cyan': 'rgba(6, 182, 212, 0.7)',
      'indigo': 'rgba(99, 102, 241, 0.7)'
    };

    const chartLabels = masterList.map(m => m.name);
    const chartValues = masterList.map(m => chartCounts[m.key] || 0);
    const chartColors = masterList.map(m => colorMap[m.color] || 'rgba(148, 163, 184, 0.7)');

    // ============================================
    // 6. RENDER KONTEN UTAMA
    // ============================================
    const content = document.getElementById('contentArea');
    content.innerHTML = `
        <div id="prayerTimesContainer" class="mb-6 animate-fade-in-up">
           <div class="bg-white rounded-2xl p-6 shadow-lg flex items-center justify-center">
              <div class="spinner border-t-emerald-500 border-4 w-8 h-8 rounded-full animate-spin"></div>
              <span class="ml-3 text-slate-500 text-sm">Memuat Jadwal Sholat...</span>
           </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
           <div class="bg-gradient-to-br from-orange-500 to-red-600 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden flex items-center justify-between card-hover">
              <div class="absolute -right-6 -bottom-6 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
              
              <div>
                 <p class="text-orange-100 text-sm font-medium mb-1 uppercase tracking-wider">Ibadah Streak</p>
                 <div class="flex items-end gap-2">
                    <span class="text-5xl font-extrabold">${streak}</span>
                    <span class="text-lg font-medium mb-2 opacity-90">Hari</span>
                 </div>
                 <p class="text-xs mt-2 text-white/80 font-medium">
                    ${streak > 0 ? 'Pertahankan semangatmu! ' : 'Ayo mulai checklist hari ini!'}
                 </p>
              </div>

              <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm shadow-inner streak-fire">
                 <i class="fas fa-fire text-3xl text-yellow-300"></i>
              </div>
           </div>

           <div class="lg:col-span-2 bg-white rounded-2xl p-5 shadow-lg border border-slate-100 flex flex-col h-full">
              <div class="flex justify-between items-center mb-3">
                 <h3 class="font-bold text-slate-800 flex items-center">
                    <i class="fas fa-award text-yellow-500 mr-2"></i>Koleksi Badge
                 </h3>
                 <span class="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded-full border border-slate-200">${myBadges.length} Terkumpul</span>
              </div>
              
              <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-3 overflow-y-auto max-h-[120px] custom-scrollbar pr-1">
                 ${badgesHtml}
                 
                 ${!myBadges.includes('full_fasting') ? `
                    <div class="flex flex-col items-center p-3 rounded-xl bg-slate-50 border border-slate-200 border-dashed grayscale opacity-60 relative group cursor-help hover:bg-slate-100 transition">
                       <i class="fas fa-medal text-slate-400 text-2xl mb-1"></i>
                       <span class="text-[10px] font-bold text-slate-400 text-center">Full Fasting</span>
                       <div class="absolute bottom-full mb-2 hidden group-hover:block w-32 bg-slate-800 text-white text-[10px] p-2 rounded z-10 text-center shadow-lg">
                          Misi: Puasa penuh 30 hari
                       </div>
                    </div>
                 ` : ''}
                 
                 ${!myBadges.includes('early_bird') ? `
                    <div class="flex flex-col items-center p-3 rounded-xl bg-slate-50 border border-slate-200 border-dashed grayscale opacity-60 relative group cursor-help hover:bg-slate-100 transition">
                       <i class="fas fa-dove text-slate-400 text-2xl mb-1"></i>
                       <span class="text-[10px] font-bold text-slate-400 text-center">Early Bird</span>
                       <div class="absolute bottom-full mb-2 hidden group-hover:block w-32 bg-slate-800 text-white text-[10px] p-2 rounded z-10 text-center shadow-lg">
                          Misi: Sholat Subuh 7 hari berturut-turut
                       </div>
                    </div>
                 ` : ''}
              </div>
           </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
          <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-6 text-white shadow-lg card-hover">
            <div class="flex items-center justify-between mb-4">
              <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                <i class="fas fa-star text-2xl"></i>
              </div>
              <span class="text-3xl font-bold">${data.totalPoin}</span>
            </div>
            <p class="text-emerald-100">Total Poin</p>
          </div>
          
          <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-6 text-white shadow-lg card-hover">
            <div class="flex items-center justify-between mb-4">
              <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                <i class="fas fa-calendar-check text-2xl"></i>
              </div>
              <span class="text-3xl font-bold">${data.ibadahCount}</span>
            </div>
            <p class="text-blue-100">Hari Terinput</p>
          </div>
          
          <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl p-6 text-white shadow-lg card-hover">
            <div class="flex items-center justify-between mb-4">
              <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                <i class="fas fa-trophy text-2xl"></i>
              </div>
              <span class="text-3xl font-bold">#${data.rank || '-'}</span>
            </div>
            <p class="text-purple-100">Ranking Kelas</p>
          </div>
          
          <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl p-6 text-white shadow-lg card-hover">
            <div class="flex items-center justify-between mb-4">
              <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                <i class="fas fa-hourglass-half text-2xl"></i>
              </div>
              <span class="text-3xl font-bold">${diffDays > 0 ? diffDays : '-'}</span>
            </div>
            <p class="text-orange-100">Hari Ramadhan</p>
          </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          
          <div class="bg-white rounded-2xl p-6 shadow-lg">
            <h3 class="text-lg font-bold text-slate-800 mb-4">
              <i class="fas fa-chart-bar text-emerald-500 mr-2"></i>Frekuensi Ibadah
            </h3>
            <div class="relative h-64 w-full">
               <canvas id="ibadahChart"></canvas>
            </div>
          </div>
          
          <div class="bg-white rounded-2xl p-6 shadow-lg">
            <h3 class="text-lg font-bold text-slate-800 mb-4">
              <i class="fas fa-calendar-alt text-emerald-500 mr-2"></i>Rincian Progress
            </h3>
            
            <div class="mb-6">
              <div class="flex justify-between text-sm text-slate-600 mb-2">
                <span class="font-bold text-emerald-600">${hariText}</span>
                <span>${Math.round(progressVal)}%</span>
              </div>
              <div class="w-full bg-slate-200 rounded-full h-4">
                <div class="bg-gradient-to-r from-emerald-500 to-emerald-600 h-4 rounded-full transition-all duration-500" style="width: ${progressVal}%"></div>
              </div>
            </div>

            <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 max-h-60 overflow-y-auto pr-1 custom-scrollbar">
               ${statsCardsHtml}
            </div>
          </div>
        </div>
        
        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-8 text-white shadow-lg text-center">
          <i class="fas fa-moon text-6xl mb-4 opacity-80"></i>
          <h2 class="text-3xl font-bold mb-2">Ramadhan Mubarak!</h2>
          <p class="text-emerald-100 text-lg">Semangat beribadah, kumpulkan poin pahala sebanyak-banyaknya.</p>
        </div>
      `;

    // 7. RENDER CHART
    const ctx = document.getElementById('ibadahChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: chartLabels,
        datasets: [{
          label: 'Jumlah Hari',
          data: chartValues,
          backgroundColor: chartColors,
          borderRadius: 6,
          borderWidth: 0,
          barPercentage: 0.6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function (context) {
                return context.parsed.y + ' Hari';
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { stepSize: 1 },
            grid: { color: '#f1f5f9' }
          },
          x: {
            grid: { display: false },
            ticks: {
              autoSkip: false,
              maxRotation: 45,
              minRotation: 0,
              font: { size: 10 }
            }
          }
        }
      }
    });

    // 8. Inisialisasi Widget Jadwal Sholat
    if (typeof initPrayerWidget === 'function') {
      initPrayerWidget();
    } else {
      console.warn("Fungsi initPrayerWidget belum dimuat.");
    }

  } catch (error) {
    // Error Handling
    const content = document.getElementById('contentArea');
    content.innerHTML = `<div class="text-center text-red-500 p-8">Gagal memuat dashboard: ${error}</div>`;
  } finally {
    hideLoading();
  }
}

// Fungsi untuk menghapus widget dari layar (Cleanup)
function removeFloatingAnnouncements() {
    const existingBtn = document.getElementById('floatingAnnounceBtn');
    const existingPanel = document.getElementById('floatingAnnouncePanel');
    
    if (existingBtn) existingBtn.remove();
    if (existingPanel) existingPanel.remove();
}

// ============================================
// HELPER: FLOATING ANNOUNCEMENT WIDGET (UPDATED)
// ============================================

// Variabel Global untuk menyimpan ID yang belum dibaca saat ini
let pendingReadIds = [];

function renderFloatingAnnouncements(announcements) {
    // ============================================================
    // [GUARD CLAUSE] CEK ROLE
    // Hanya tampilkan jika user sudah login DAN role-nya adalah 'siswa'
    // ============================================================
    if (!currentUser || currentUser.role !== 'siswa') {
        // Jika bukan siswa, pastikan widget dihapus dari layar
        const btn = document.getElementById('floatingAnnounceBtn');
        const pnl = document.getElementById('floatingAnnouncePanel');
        if (btn) btn.remove();
        if (pnl) pnl.remove();
        return; // Hentikan fungsi di sini
    }

    // 1. Bersihkan widget lama (Cleanup sebelum render baru)
    const existingBtn = document.getElementById('floatingAnnounceBtn');
    const existingPanel = document.getElementById('floatingAnnouncePanel');
    if (existingBtn) existingBtn.remove();
    if (existingPanel) existingPanel.remove();

    // 2. Hitung Badge (Hanya yang belum dibaca / isRead === false)
    const unreadItems = announcements.filter(a => !a.isRead);
    pendingReadIds = unreadItems.map(a => a.id); // Simpan ID untuk dikirim nanti
    const badgeCount = unreadItems.length;

    // 3. Generate Item HTML
    let itemsHtml = '';
    if(announcements.length > 0) {
        itemsHtml = announcements.map(ann => `
            <div class="p-3 rounded-lg border-l-4 mb-2 transition shadow-sm relative ${ann.isRead ? 'bg-slate-50 border-slate-300' : 'bg-orange-50 border-orange-500 hover:bg-orange-100'}">
                ${!ann.isRead ? '<span class="absolute top-2 right-2 w-2 h-2 bg-orange-500 rounded-full animate-pulse" title="Belum Dibaca"></span>' : ''}
                
                <div class="flex justify-between items-start pr-4">
                    <h5 class="font-bold ${ann.isRead ? 'text-slate-700' : 'text-orange-900'} text-sm leading-tight">${ann.title}</h5>
                    <span class="text-[10px] text-slate-400 font-mono whitespace-nowrap ml-2">${ann.date}</span>
                </div>
                <p class="text-xs ${ann.isRead ? 'text-slate-500' : 'text-slate-700'} mt-1 line-clamp-3">${ann.content}</p>
                <div class="mt-2 text-[10px] ${ann.isRead ? 'text-slate-400' : 'text-orange-500 font-semibold'} flex items-center">
                    <i class="fas fa-bullhorn mr-1"></i> ${ann.sender}
                </div>
            </div>
        `).join('');
    } else {
        itemsHtml = `
            <div class="text-center py-8 text-slate-400">
                <i class="fas fa-bell-slash text-3xl mb-2 opacity-50"></i>
                <p class="text-xs">Tidak ada pengumuman</p>
            </div>
        `;
    }

    // 4. Widget HTML
    const widgetHtml = `
        <button id="floatingAnnounceBtn" onclick="toggleAnnouncePanel()" 
            class="fixed bottom-6 right-6 z-[9999] w-14 h-14 bg-gradient-to-br from-orange-500 to-orange-600 rounded-full shadow-2xl flex items-center justify-center text-white hover:scale-110 transition-transform duration-300 border-2 border-white group">
            <i class="fas fa-bullhorn text-xl group-hover:-rotate-12 transition-transform"></i>
            
            <span id="announceBadge" class="${badgeCount > 0 ? '' : 'hidden'} absolute -top-1 -right-1 w-5 h-5 bg-red-600 border-2 border-white rounded-full text-[10px] flex items-center justify-center font-bold animate-pulse shadow-sm">
                ${badgeCount}
            </span>
        </button>

        <div id="floatingAnnouncePanel" class="fixed bottom-24 right-6 z-[9999] w-80 md:w-96 bg-white rounded-2xl shadow-2xl border border-slate-200 transform translate-y-10 opacity-0 pointer-events-none transition-all duration-300 origin-bottom-right flex flex-col max-h-[500px]">
            
            <div class="bg-gradient-to-r from-orange-500 to-orange-600 p-4 rounded-t-2xl flex justify-between items-center shrink-0 shadow-sm">
                <div class="text-white">
                    <h3 class="font-bold text-base flex items-center">
                        <i class="fas fa-bell mr-2"></i>Papan Pengumuman
                    </h3>
                    <p class="text-xs text-orange-100 opacity-90">Info sekolah terbaru</p>
                </div>
                <button onclick="toggleAnnouncePanel()" class="w-8 h-8 rounded-full bg-white/20 text-white flex items-center justify-center hover:bg-white/30 transition backdrop-blur-sm">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="p-4 overflow-y-auto custom-scrollbar grow bg-white">
                ${itemsHtml}
            </div>
            
            <div class="p-3 border-t border-slate-100 text-center bg-slate-50 rounded-b-2xl shrink-0">
               <p class="text-[10px] text-slate-400 font-medium">Klik X untuk menutup</p>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', widgetHtml);
}

// Fungsi Toggle Buka/Tutup & Trigger Read
window.toggleAnnouncePanel = async function() {
    const panel = document.getElementById('floatingAnnouncePanel');
    const badge = document.getElementById('announceBadge');
    
    // Safety check jika panel belum ter-render
    if (!panel) return;

    const isHidden = panel.classList.contains('opacity-0');

    if (isHidden) {
        // === BUKA PANEL ===
        panel.classList.remove('translate-y-10', 'opacity-0', 'pointer-events-none');
        
        // 1. Hilangkan Badge Merah Secara Visual (Langsung)
        if(badge) badge.classList.add('hidden');

        // 2. Kirim sinyal ke server: Tandai sebagai terbaca
        // Kita cek apakah ada ID yang pending (belum dibaca)
        if (pendingReadIds.length > 0) {
            // Panggil API di background (tanpa await loading screen agar tidak mengganggu UX)
            // Clone array biar aman
            const idsToMark = [...pendingReadIds];
            pendingReadIds = []; // Kosongkan lokal segera

            try {
                // Panggil server function
                await callServerFunction('markAnnouncementsAsRead', authToken, idsToMark);
                console.log('Status terbaca dikirim ke server.');
                
                // Opsional: Refresh daftar jika ingin mengubah warna background dari orange ke putih saat itu juga
            } catch(e) {
                console.error('Gagal update status baca:', e);
            }
        }

    } else {
        // === TUTUP PANEL ===
        panel.classList.add('translate-y-10', 'opacity-0', 'pointer-events-none');
    }
}
// ============================================
// FITUR JADWAL SHOLAT REAL-TIME
// ============================================

async function initPrayerWidget() {
  const container = document.getElementById('prayerTimesContainer');
  if(!container) return;

  const todayStr = new Date().toISOString().split('T')[0]; // Format: YYYY-MM-DD
  const cachedData = localStorage.getItem('prayer_cache');

  // 1. CEK CACHE DULU (Agar Instan saat dashboard dibuka kembali)
  if (cachedData) {
      try {
          const parsed = JSON.parse(cachedData);
          
          // Jika data cache adalah untuk hari ini, langsung pakai!
          if (parsed.date === todayStr) {
              // console.log("Jadwal Sholat: Memuat dari Cache (Instan)");
              renderPrayerUI(parsed.timings, parsed.hijri, parsed.locationName);
              startPrayerCountdown(parsed.timings);
              return; // Stop, tidak perlu internet/GPS lagi
          }
      } catch (e) {
          console.error("Cache Error:", e);
          localStorage.removeItem('prayer_cache'); // Bersihkan jika korup
      }
  }

  // 2. JIKA CACHE KOSONG/KADALUARSA, BARU AMBIL DARI INTERNET
  // Cek apakah ada koordinat terakhir yang tersimpan? (Biar gak nunggu loading GPS)
  const lastLat = localStorage.getItem('last_lat');
  const lastLng = localStorage.getItem('last_lng');

  if (lastLat && lastLng) {
      // Pakai lokasi terakhir (cepat)
      // Note: Parameter ke-3 dikosongkan agar fetchPrayerTimes melakukan Reverse Geocoding
      fetchPrayerTimes(lastLat, lastLng);
      
  } else if (navigator.geolocation) {
      // Jika user baru pertama kali buka, scan GPS (butuh izin user)
      navigator.geolocation.getCurrentPosition(
        (position) => {
          // Sukses dapat GPS
          // Parameter ke-3 KOSONG agar sistem mencari nama kecamatan/kota sendiri
          fetchPrayerTimes(position.coords.latitude, position.coords.longitude);
        },
        (error) => {
          console.warn("GPS Error/Blocked, using default Jakarta:", error);
          // Jika GPS error/ditolak, pakai Default Jakarta
          fetchPrayerTimes(-6.2088, 106.8456, "Jakarta (Default)"); 
        }
      );
  } else {
      // Browser tidak support GPS
      fetchPrayerTimes(-6.2088, 106.8456, "Jakarta (Default)");
  }
}

async function fetchPrayerTimes(lat, lng, manualOverrideName = null) {
  const dateObj = new Date();
  const todayStr = dateObj.toISOString().split('T')[0];
  
  // Simpan koordinat terakhir
  localStorage.setItem('last_lat', lat);
  localStorage.setItem('last_lng', lng);

  // URL API Jadwal Sholat
  const urlSholat = `https://api.aladhan.com/v1/timings/${dateObj.getDate()}-${dateObj.getMonth() + 1}-${dateObj.getFullYear()}?latitude=${lat}&longitude=${lng}&method=20`;
  
  // URL API Nama Lokasi (Reverse Geocoding)
  const urlLokasi = `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=id`;

  try {
    // Ambil Data Sholat & Data Lokasi secara Parallel (Biar cepat)
    const [sholatRes, lokasiRes] = await Promise.all([
        fetch(urlSholat),
        fetch(urlLokasi).catch(() => null) // Kalau gagal load nama lokasi, jangan error
    ]);

    const sholatData = await sholatRes.json();
    const timings = sholatData.data.timings;
    const hijri = sholatData.data.date.hijri;

    // Tentukan Nama Lokasi
    let finalLocationName = "Lokasi Terdeteksi";
    
    if (manualOverrideName) {
        // Jika ada nama manual (misal: "Jakarta (Default)"), pakai itu
        finalLocationName = manualOverrideName;
    } else if (lokasiRes && lokasiRes.ok) {
        // Jika berhasil ambil nama dari API
        const lokasiData = await lokasiRes.json();
        // Prioritas: Kecamatan -> Kota -> Provinsi
        const kecamatan = lokasiData.locality || '';
        const kota = lokasiData.city || lokasiData.principalSubdivision || '';
        
        if (kecamatan && kota) {
            finalLocationName = `${kecamatan}, ${kota}`;
        } else {
            finalLocationName = kota || kecamatan || "Lokasi Saya";
        }
    } else {
        // Fallback jika API lokasi gagal
        finalLocationName = `GPS: ${lat.toFixed(2)}, ${lng.toFixed(2)}`;
    }

    // 3. RENDER UI
    renderPrayerUI(timings, hijri, finalLocationName);
    
    // 4. SIMPAN KE CACHE
    const cachePayload = {
        date: todayStr,
        timings: timings,
        hijri: hijri,
        locationName: finalLocationName
    };
    localStorage.setItem('prayer_cache', JSON.stringify(cachePayload));

    // Mulai Countdown
    startPrayerCountdown(timings);

  } catch (error) {
    console.error(error);
    document.getElementById('prayerTimesContainer').innerHTML = `
      <div class="bg-red-50 text-red-600 p-4 rounded-xl text-center border border-red-200">
        <i class="fas fa-wifi mb-1"></i><br>Gagal memuat jadwal. Periksa koneksi internet.
      </div>
    `;
  }
}

function renderPrayerUI(timings, hijri, locationName) {
  const container = document.getElementById('prayerTimesContainer');
  
  // Mapping nama waktu agar sesuai UI Indonesia
  const schedules = [
    { name: 'Imsak', time: timings.Imsak, icon: 'fa-cloud-moon' },
    { name: 'Subuh', time: timings.Fajr, icon: 'fa-sun' },
    { name: 'Dzuhur', time: timings.Dhuhr, icon: 'fa-sun' },
    { name: 'Ashar', time: timings.Asr, icon: 'fa-cloud-sun' },
    { name: 'Maghrib', time: timings.Maghrib, icon: 'fa-moon' },
    { name: 'Isya', time: timings.Isha, icon: 'fa-star' }
  ];

  // Cari waktu sholat aktif (Next Prayer)
  const now = new Date();
  const currentTime = now.getHours() * 60 + now.getMinutes();
  
  let nextPrayerName = 'Besok';
  
  for (let s of schedules) {
      const [h, m] = s.time.split(':').map(Number);
      const sTime = h * 60 + m;
      if (sTime > currentTime) {
          nextPrayerName = s.name;
          break;
      }
  }
  
  // Jika lewat Isya, targetnya Imsak besok
  if(nextPrayerName === 'Besok') nextPrayerName = schedules[0].name;

  // Generate HTML Kartu Waktu
  let cardsHtml = schedules.map(s => {
      const isNext = s.name === nextPrayerName;
      const bgClass = isNext ? 'bg-gradient-to-br from-orange-500 to-orange-600 text-white shadow-lg transform scale-105 ring-2 ring-orange-200' : 'bg-white text-slate-700 hover:bg-slate-50 border border-slate-100';
      const timeClass = isNext ? 'text-white' : 'text-slate-800';

      return `
        <div class="flex flex-col items-center justify-center p-3 rounded-xl transition-all duration-300 ${bgClass}">
           <p class="text-xs font-bold uppercase tracking-wider mb-1 opacity-80">${s.name}</p>
           <p class="text-lg font-bold font-mono ${timeClass}">${s.time}</p>
        </div>
      `;
  }).join('');

  container.innerHTML = `
    <div class="bg-white rounded-2xl shadow-lg overflow-hidden relative border-t-4 border-emerald-500">
        <div class="absolute top-0 right-0 opacity-5">
            <i class="fas fa-mosque text-9xl transform translate-x-10 -translate-y-10"></i>
        </div>

        <div class="p-6">
            <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
                <div>
                    <h3 class="text-xl font-bold text-slate-800 flex items-center">
                        <i class="fas fa-kaaba text-emerald-600 mr-2"></i> Jadwal Sholat
                    </h3>
                    
                    <div class="flex items-center flex-wrap gap-3 mt-2">
                        <p class="text-sm text-slate-500 flex items-center">
                            <i class="fas fa-map-marker-alt text-red-500 mr-1.5"></i> ${locationName} 
                        </p>
                        
                        <button onclick="refreshPrayerLocation()" 
                            class="text-[10px] font-bold bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded-lg border border-emerald-100 hover:bg-emerald-100 transition flex items-center shadow-sm" 
                            title="Klik jika Anda pindah kota/lokasi">
                           <i class="fas fa-sync-alt mr-1.5"></i> Update Lokasi
                        </button>
                    </div>

                    <p class="text-xs text-slate-400 mt-1 ml-1">
                        ${hijri.day} ${hijri.month.en} ${hijri.year}
                    </p>
                </div>
                
                <div class="mt-4 md:mt-0 text-right">
                     <p class="text-xs text-slate-400 uppercase tracking-widest font-bold">Menuju ${nextPrayerName}</p>
                     <p id="prayerCountdown" class="text-2xl font-bold text-emerald-600 font-mono">--:--:--</p>
                </div>
            </div>

            <div class="grid grid-cols-3 md:grid-cols-6 gap-3 md:gap-4">
                ${cardsHtml}
            </div>
        </div>
    </div>
  `;
}

// Fungsi untuk memaksa update lokasi (Manual Refresh)
// Fungsi untuk memaksa update lokasi (Manual Refresh)
function refreshPrayerLocation() {
    // 1. Konfirmasi & Loading UI
    Swal.fire({
        title: 'Perbarui Lokasi?',
        text: "Jadwal sholat akan disesuaikan dengan koordinat GPS Anda saat ini.",
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Ya, Perbarui',
        confirmButtonColor: '#10b981',
        cancelButtonText: 'Batal',
        reverseButtons: true
    }).then((result) => {
        if (result.isConfirmed) {
            
            // Tampilkan Loading
            Swal.fire({
                title: 'Mencari Lokasi...',
                html: 'Mohon izinkan akses lokasi jika diminta browser.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // 2. Hapus Cache Lama
            localStorage.removeItem('prayer_cache');
            localStorage.removeItem('last_lat');
            localStorage.removeItem('last_lng');

            // 3. Request Posisi Baru
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        // [PERBAIKAN DI SINI]
                        // Parameter ke-3 kita set NULL agar dia mencari nama kota sendiri (Reverse Geocoding)
                        fetchPrayerTimes(position.coords.latitude, position.coords.longitude, null)
                        .then(() => {
                            Swal.fire({
                                icon: 'success',
                                title: 'Berhasil!',
                                text: 'Jadwal sholat diperbarui sesuai lokasi deteksi.',
                                timer: 1500,
                                showConfirmButton: false
                            });
                        });
                    },
                    (error) => {
                        console.error(error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Gagal',
                            text: 'Gagal mendeteksi lokasi. Pastikan GPS aktif.',
                        });
                        // Fallback ke Jakarta
                        fetchPrayerTimes(-6.2088, 106.8456, "Jakarta (Default)");
                    },
                    { 
                        enableHighAccuracy: true, 
                        timeout: 10000, 
                        maximumAge: 0 
                    }
                );
            } else {
                Swal.fire('Error', 'Browser tidak mendukung fitur lokasi.', 'error');
            }
        }
    });
}

// Logic Countdown Sederhana
let prayerInterval;
function startPrayerCountdown(timings) {
    if(prayerInterval) clearInterval(prayerInterval);

    // Cari target waktu dalam object Date
    const now = new Date();
    const timeKeys = ['Imsak', 'Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
    let targetDate = null;

    // Loop cari waktu yang belum lewat
    for (let key of timeKeys) {
        const [h, m] = timings[key].split(':');
        let tDate = new Date();
        tDate.setHours(h, m, 0, 0);
        
        if (tDate > now) {
            targetDate = tDate;
            break;
        }
    }

    // Jika lewat Isya, target Imsak besok
    if (!targetDate) {
        const [h, m] = timings['Imsak'].split(':');
        targetDate = new Date();
        targetDate.setDate(targetDate.getDate() + 1);
        targetDate.setHours(h, m, 0, 0);
    }

    const el = document.getElementById('prayerCountdown');
    
    prayerInterval = setInterval(() => {
        const current = new Date();
        const diff = targetDate - current;

        if (diff <= 0) {
            clearInterval(prayerInterval);
            el.innerText = "Sekarang";
            // Refresh jadwal jika waktu habis (masuk waktu sholat)
            setTimeout(() => initPrayerWidget(), 2000); 
            return;
        }

        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);

        el.innerText = `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
    }, 1000);
}

async function loadAdminDashboard() {
  showLoading();
  
  try {
    const result = await callServerFunction('getSchoolDashboard', authToken);
  
    if (!result.success) {
      showToast(result.error, 'error');
      return;
    }
  
    const data = result.data;
  
    const content = document.getElementById('contentArea');
    content.innerHTML = `
      <div id="prayerTimesContainer" class="mb-6 animate-fade-in-up">
         <div class="bg-white rounded-2xl p-6 shadow-lg flex items-center justify-center">
            <div class="spinner border-t-emerald-500 border-4 w-8 h-8 rounded-full animate-spin"></div>
            <span class="ml-3 text-slate-500 text-sm">Memuat Jadwal Sholat...</span>
         </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-6 text-white shadow-lg card-hover">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
              <i class="fas fa-user-graduate text-2xl"></i>
            </div>
            <span class="text-4xl font-bold">${data.totalStudents}</span>
          </div>
          <p class="text-blue-100">Total Siswa Aktif</p>
        </div>
        
        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl p-6 text-white shadow-lg card-hover">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
              <i class="fas fa-chalkboard text-2xl"></i>
            </div>
            <span class="text-4xl font-bold">${data.totalClasses}</span>
          </div>
          <p class="text-purple-100">Total Kelas</p>
        </div>
        
        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-6 text-white shadow-lg card-hover">
          <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
              <i class="fas fa-star text-2xl"></i>
            </div>
            <span class="text-4xl font-bold">${data.totalPoin}</span>
          </div>
          <p class="text-emerald-100">Total Poin Sekolah</p>
        </div>
      </div>
      
      <div class="bg-white rounded-2xl p-6 shadow-lg">
        <h3 class="text-lg font-bold text-slate-800 mb-4">
          <i class="fas fa-trophy text-emerald-500 mr-2"></i>Top 10 Siswa Terbaik
        </h3>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr class="border-b border-slate-200">
                <th class="text-left py-3 px-4 text-slate-600 font-semibold">Rank</th>
                <th class="text-left py-3 px-4 text-slate-600 font-semibold">NIS</th>
                <th class="text-left py-3 px-4 text-slate-600 font-semibold">Nama</th>
                <th class="text-left py-3 px-4 text-slate-600 font-semibold">Kelas</th>
                <th class="text-right py-3 px-4 text-slate-600 font-semibold">Poin</th>
              </tr>
            </thead>
            <tbody>
              ${data.top10.length > 0 ? data.top10.map((student, index) => `
                <tr class="border-b border-slate-100 hover:bg-slate-50">
                  <td class="py-3 px-4">
                    <span class="inline-flex items-center justify-center w-8 h-8 rounded-full ${index < 3 ? 'bg-emerald-100 text-emerald-600 font-bold' : 'bg-slate-100 text-slate-600'}">
                      ${index + 1}
                    </span>
                  </td>
                  <td class="py-3 px-4 text-slate-600">${student.nis}</td>
                  <td class="py-3 px-4 font-medium text-slate-800">${student.name}</td>
                  <td class="py-3 px-4 text-slate-600">${student.className || '-'}</td>
                  <td class="py-3 px-4 text-right">
                    <span class="inline-flex items-center px-3 py-1 rounded-full bg-emerald-100 text-emerald-600 font-semibold">
                      ${student.totalPoin}
                    </span>
                  </td>
                </tr>
              `).join('') : '<tr><td colspan="5" class="text-center py-8 text-slate-500">Belum ada data</td></tr>'}
            </tbody>
          </table>
        </div>
      </div>
    `;

    // [PENTING] Panggil Widget Sholat Global (yang sudah dimodifikasi)
    if (typeof initPrayerWidget === 'function') {
        initPrayerWidget();
    }

  } catch (error) {
    showToast('Terjadi kesalahan: ' + error, 'error');
  } finally {
    hideLoading();
  }
}

async function loadSuperAdminDashboard() {
      showLoading();
      const content = document.getElementById('contentArea');

      try {
        // 1. Ambil Data Dashboard Global & Data Tanggal Ramadhan (Parallel Request)
        const [dashboardRes, dateRes] = await Promise.all([
           callServerFunction('getGlobalDashboard', authToken),
           callServerFunction('getRamadhanStartDate', authToken)
        ]);

        if (!dashboardRes.success) {
          showToast(dashboardRes.error, 'error');
          return;
        }

        const data = dashboardRes.data;
        const currentDateVal = dateRes.success ? dateRes.date : '';

        // 2. Render HTML
        content.innerHTML = `
          <div class="bg-white rounded-2xl p-6 shadow-lg mb-6 border-l-4 border-indigo-500">
            <h3 class="text-lg font-bold text-slate-800 mb-4">
               <i class="fas fa-cog text-indigo-500 mr-2"></i>Pengaturan Sistem
            </h3>
            <form id="settingForm" class="flex flex-col md:flex-row items-end gap-4">
               <div class="w-full md:w-1/3">
                  <label class="block text-slate-600 font-medium mb-2 text-sm">Tetapkan Tanggal 1 Ramadhan</label>
                  <input type="date" id="setting_startDate" value="${currentDateVal}" class="w-full px-4 py-2 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
               </div>
               <button type="submit" class="btn-primary bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2.5 rounded-xl text-sm font-bold shadow-md transition-all transform active:scale-95">
                  Simpan Pengaturan
               </button>
            </form>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-6 text-white shadow-lg card-hover">
              <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                  <i class="fas fa-school text-2xl"></i>
                </div>
                <span class="text-4xl font-bold">${data.totalSchools}</span>
              </div>
              <p class="text-blue-100">Total Sekolah</p>
            </div>
            
            <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl p-6 text-white shadow-lg card-hover">
              <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                  <i class="fas fa-user-graduate text-2xl"></i>
                </div>
                <span class="text-4xl font-bold">${data.totalStudents}</span>
              </div>
              <p class="text-purple-100">Total Siswa Global</p>
            </div>
            
            <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-6 text-white shadow-lg card-hover">
              <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                  <i class="fas fa-star text-2xl"></i>
                </div>
                <span class="text-4xl font-bold">${data.totalPoin}</span>
              </div>
              <p class="text-emerald-100">Total Poin Global</p>
            </div>
          </div>
          
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-white rounded-2xl p-6 shadow-lg">
              <h3 class="text-lg font-bold text-slate-800 mb-4">
                <i class="fas fa-medal text-yellow-500 mr-2"></i>Ranking Sekolah Terbaik
              </h3>
              <div class="space-y-3">
                ${data.schoolRanking.slice(0, 5).map((school, index) => `
                  <div class="flex items-center justify-between p-4 bg-slate-50 rounded-xl hover:bg-slate-100 transition">
                    <div class="flex items-center space-x-3">
                      <span class="inline-flex items-center justify-center w-10 h-10 rounded-full ${index < 3 ? 'bg-yellow-100 text-yellow-600 font-bold' : 'bg-slate-200 text-slate-600'} text-lg">
                        ${index + 1}
                      </span>
                      <div>
                        <p class="font-semibold text-slate-800">${school.schoolName}</p>
                        <p class="text-sm text-slate-500">${school.schoolId}</p>
                      </div>
                    </div>
                    <span class="text-lg font-bold text-emerald-600">${school.totalPoin}</span>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <div class="bg-white rounded-2xl p-6 shadow-lg">
              <h3 class="text-lg font-bold text-slate-800 mb-4">
                <i class="fas fa-trophy text-emerald-500 mr-2"></i>Top 10 Siswa Global
              </h3>
              <div class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar">
                ${data.top10Global.map((student, index) => `
                  <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition">
                    <div class="flex items-center space-x-3">
                      <span class="inline-flex items-center justify-center w-8 h-8 rounded-full ${index < 3 ? 'bg-emerald-100 text-emerald-600 font-bold' : 'bg-slate-200 text-slate-600'}">
                        ${index + 1}
                      </span>
                      <div>
                        <p class="font-medium text-slate-800">${student.name}</p>
                        <p class="text-xs text-slate-500">${student.schoolName} - ${student.className}</p>
                      </div>
                    </div>
                    <span class="font-bold text-emerald-600">${student.totalPoin}</span>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        `;

        // 3. Tambahkan Event Listener untuk Form Setting (Setelah HTML di-render)
        document.getElementById('settingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newDate = document.getElementById('setting_startDate').value;
            
            if(!newDate) {
              showToast('Silakan pilih tanggal terlebih dahulu', 'error');
              return;
            }
            
            showLoading();
            try {
              const res = await callServerFunction('setRamadhanStartDate', authToken, newDate);
              if(res.success) {
                 showToast(res.message);
              } else {
                 showToast(res.error, 'error');
              }
            } catch(err) {
              showToast('Gagal menyimpan: ' + err, 'error');
            } finally {
              hideLoading();
            }
        });

      } catch (error) {
        content.innerHTML = `<div class="text-center text-red-500 p-8">Error: ${error}</div>`;
      } finally {
        hideLoading();
      }
    }

    // 1. HALAMAN CHECKLIST IBADAH (FIXED DISPLAY)
    // ============================================
async function loadInputIbadah() {
    showLoading();
    const content = document.getElementById('contentArea');
    const today = new Date().toISOString().split('T')[0];
    
    try {
      let masterData, savedData, savedCatatan, isKultumDone;

      // 1. LOGIKA CACHE VS SERVER
      // Cek apakah data tersedia di cache DAN user sedang membuka inputan hari ini
      const currentDateInput = document.getElementById('tanggalInput')?.value || today;

      if (appCache.masterIbadah && appCache.checklistToday && appCache.kultumToday && currentDateInput === today) {
          // console.log("Menggunakan data Input Ibadah dari Cache...");
          masterData = appCache.masterIbadah;
          
          // Data Checklist
          const checklistRes = appCache.checklistToday;
          savedData = checklistRes.data || {};
          savedCatatan = checklistRes.catatan || '';
          
          // Data Kultum
          const kultumRes = appCache.kultumToday;
          isKultumDone = kultumRes.success && kultumRes.found;

      } else {
          // Fallback: Ambil dari server (jika cache kosong atau bukan hari ini)
          const [masterRes, savedRes, kultumRes] = await Promise.all([
             callServerFunction('getMasterIbadahList', authToken),
             callServerFunction('getChecklistData', authToken, today),
             callServerFunction('getKultumData', authToken, today)
          ]);

          if (!masterRes.success) throw new Error(masterRes.error);
          masterData = masterRes.data;
          savedData = savedRes.data || {};
          savedCatatan = savedRes.catatan || '';
          isKultumDone = kultumRes.success && kultumRes.found;
      }
      
      // 2. Hitung Poin Awal (Kultum)
      const kultumPoin = isKultumDone ? 10 : 0; 
      
      // 3. Render HTML Form
      content.innerHTML = `
        <div class="max-w-2xl mx-auto pb-20">
          <div class="bg-white rounded-2xl p-6 md:p-8 shadow-lg border-t-4 border-emerald-500">
            
            <div class="text-center mb-8">
              <div class="w-16 h-16 bg-emerald-100 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-sm">
                <i class="fas fa-check-double text-emerald-600 text-3xl"></i>
              </div>
              <h2 class="text-2xl font-bold text-slate-800">Checklist Ibadah</h2>
              <p class="text-slate-500 text-sm">Isi target ibadah harianmu</p>
            </div>
            
            <form id="checklistForm" class="space-y-6">
              
              <div>
                <label class="block text-slate-700 font-bold mb-2 text-xs uppercase tracking-wider">Tanggal</label>
                <div class="relative">
                  <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-calendar-day text-slate-400"></i>
                  </span>
                  <input type="date" id="tanggalInput" value="${today}" required class="w-full pl-10 px-4 py-3 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-shadow">
                </div>
              </div>

              <div class="grid grid-cols-1 gap-3" id="dynamicChecklistContainer">
                </div>
              
              <div>
                <label class="block text-slate-700 font-medium mb-2 text-sm">Catatan (Opsional)</label>
                <textarea id="catatanInput" rows="2" class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Catatan tambahan...">${savedCatatan}</textarea>
              </div>

              <div class="bg-slate-50 rounded-xl p-4 border border-slate-200 flex items-center justify-between">
                <div>
                    <span class="text-slate-700 font-bold text-sm block">Total Poin Hari Ini:</span>
                    ${isKultumDone ? 
                      `<span class="text-[10px] text-emerald-600 font-medium bg-emerald-50 px-2 py-0.5 rounded-full border border-emerald-100 mt-1 inline-block">
                        <i class="fas fa-plus-circle mr-1"></i>Termasuk 10 Poin Kultum
                      </span>` : 
                      `<span class="text-[10px] text-slate-400 font-medium mt-1 inline-block">
                        Belum termasuk poin kultum
                      </span>`
                    }
                </div>
                <span id="totalPoinDisplay" class="text-3xl font-extrabold text-emerald-600">0</span>
              </div>

              <button type="submit" class="w-full btn-primary text-white font-bold text-lg py-3.5 rounded-xl shadow-lg hover:shadow-emerald-500/30 transition-all transform active:scale-95 flex items-center justify-center space-x-2">
                <i class="fas fa-save"></i>
                <span>Simpan Perubahan</span>
              </button>
            </form>
          </div>
        </div>
      `;

      // 4. Render Item Checkbox (Dinamis dari Master Data)
      const container = document.getElementById('dynamicChecklistContainer');
      
      if (masterData.length === 0) {
          container.innerHTML = '<p class="text-center text-slate-500 italic">Belum ada daftar ibadah yang diatur admin.</p>';
      } else {
          masterData.forEach(item => {
             const bgClass = `bg-${item.color}-50/80`;
             const borderClass = `border-${item.color}-100`;
             const iconBgClass = `bg-${item.color}-200 text-${item.color}-700`;
             const focusRingClass = `focus:ring-${item.color}-500`;
             
             // Cek status checkbox dari database
             const isChecked = savedData[item.key] === true ? 'checked' : '';

             const htmlItem = `
              <div class="${bgClass} rounded-xl p-3 border ${borderClass} flex items-center justify-between cursor-pointer hover:bg-${item.color}-100 transition" 
                   onclick="document.getElementById('${item.key}').click()">
                <div class="flex items-center space-x-4">
                  <div class="w-10 h-10 ${iconBgClass} rounded-full flex items-center justify-center">
                    <i class="fas ${item.icon}"></i>
                  </div>
                  <div>
                    <p class="font-bold text-slate-800 text-sm">${item.name}</p>
                    <p class="text-[11px] text-${item.color}-600 font-bold">+${item.poin} Poin</p>
                  </div>
                </div>
                <input type="checkbox" id="${item.key}" name="ibadahCheck" 
                       data-poin="${item.poin}" ${isChecked} 
                       class="w-5 h-5 text-${item.color}-600 rounded ${focusRingClass}" 
                       onclick="event.stopPropagation()">
              </div>
             `;
             container.insertAdjacentHTML('beforeend', htmlItem);
          });
      }

      // 5. Logika Hitung Poin Live
      const checkboxes = document.querySelectorAll('input[name="ibadahCheck"]');
      
      const calculateTotal = () => {
          let total = kultumPoin; // Base poin dari status kultum
          checkboxes.forEach(cb => {
              if(cb.checked) {
                  total += parseInt(cb.getAttribute('data-poin') || 0);
              }
          });
          document.getElementById('totalPoinDisplay').textContent = total;
      };
      
      // Pasang Listener Change
      checkboxes.forEach(box => box.addEventListener('change', calculateTotal));
      
      // Hitung saat pertama load
      calculateTotal(); 

      // 6. Handle Ganti Tanggal (Fetch Ulang ke Server)
      document.getElementById('tanggalInput').addEventListener('change', async function() {
         const newDate = this.value;
         
         showLoading();
         
         // Reset UI
         checkboxes.forEach(cb => cb.checked = false);
         document.getElementById('catatanInput').value = '';
         document.getElementById('totalPoinDisplay').textContent = '0';

         try {
           // Fetch data tanggal baru
           const [newCheck, newKultum] = await Promise.all([
               callServerFunction('getChecklistData', authToken, newDate),
               callServerFunction('getKultumData', authToken, newDate)
           ]);
           
           if(newCheck.success) {
              const newData = newCheck.data || {};
              
              // Isi UI Checkbox
              checkboxes.forEach(cb => {
                 cb.checked = newData[cb.id] === true;
              });
              document.getElementById('catatanInput').value = newCheck.catatan || '';
              
              // Update Poin Kultum untuk tanggal baru
              const newKultumPoin = (newKultum.success && newKultum.found) ? 10 : 0;
              
              // Override fungsi hitung poin agar pakai base poin tanggal baru
              const updatePoinBaru = () => {
                 let total = newKultumPoin;
                 checkboxes.forEach(cb => {
                     if(cb.checked) total += parseInt(cb.getAttribute('data-poin') || 0);
                 });
                 document.getElementById('totalPoinDisplay').textContent = total;
              };
              
              // Hitung ulang & pasang listener baru
              updatePoinBaru();
              checkboxes.forEach(box => {
                 box.onchange = updatePoinBaru;
              });
           }
         } catch(e) {
            showToast('Gagal memuat data tanggal ini: ' + e, 'error');
         } finally { 
            hideLoading(); 
         }
      });

      // 7. Handle Submit Form
      document.getElementById('checklistForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const tanggal = document.getElementById('tanggalInput').value;
        const catatan = document.getElementById('catatanInput').value;
        const checklistPayload = {};
        checkboxes.forEach(cb => checklistPayload[cb.id] = cb.checked);
        
        showLoading();
        
        try {
          // Kirim ke server
          const result = await callServerFunction('saveChecklistData', authToken, tanggal, JSON.stringify(checklistPayload), catatan);
          
          if (result.success) {
              // Note: Poin di UI sudah terupdate, kita pakai itu untuk feedback user
              const currentTotal = document.getElementById('totalPoinDisplay').textContent;
              
              // [GAMIFIKASI] Cek Badges Baru
              if (result.newBadges && result.newBadges.length > 0) {
                  // Render Badge Popup
                  let badgeHtml = result.newBadges.map(b => `
                      <div class="flex flex-col items-center p-4 bg-yellow-50 rounded-xl border border-yellow-200 mb-2 transform transition hover:scale-105">
                          <i class="fas fa-medal text-5xl text-yellow-500 mb-3 animate-bounce shadow-sm rounded-full"></i>
                          <h4 class="font-bold text-yellow-800 text-lg">${b.title}</h4>
                          <p class="text-xs text-yellow-600 mt-1">Selamat! Anda hebat!</p>
                      </div>
                  `).join('');

                  Swal.fire({
                      title: ' Badge Terbuka!',
                      html: badgeHtml,
                      icon: null,
                      confirmButtonText: 'Keren!',
                      confirmButtonColor: '#10b981',
                      background: '#fff'
                  });
              } else {
                  // Toast Biasa
                  showToast(`Data tersimpan! Total Poin: ${currentTotal}`);
                  
                  // Update cache jika kita menyimpan data hari ini
                  if (tanggal === today && appCache.checklistToday) {
                      appCache.checklistToday.data = checklistPayload;
                      appCache.checklistToday.catatan = catatan;
                  }
              }

          } else {
              // [UPDATE] TANGANI ERROR KHUSUS 'AKSES DIKUNCI' DENGAN SWEETALERT
              if (result.error && result.error.includes("Akses Dikunci")) {
                  Swal.fire({
                      icon: 'error',
                      title: 'Akses Ditolak',
                      text: result.error,
                      confirmButtonText: 'Mengerti',
                      confirmButtonColor: '#ef4444',
                      background: '#fff',
                      iconColor: '#ef4444',
                      customClass: {
                          popup: 'rounded-2xl',
                          title: 'text-slate-800 font-bold',
                          confirmButton: 'rounded-xl px-6 py-2'
                      },
                      showClass: { popup: 'animate__animated animate__shakeX' }
                  });
              } else {
                  showToast(result.error, 'error');
              }
          }
        } catch (error) {
          showToast('Terjadi kesalahan: ' + error, 'error');
        } finally {
          hideLoading();
        }
      });

    } catch (error) {
       // Error Handling Utama
       content.innerHTML = `<div class="p-6 text-center text-red-500">Gagal: ${error}</div>`;
    } finally {
      hideLoading();
    }
}

async function loadMasterIbadahPage() {
      showLoading();
      try {
        const result = await callServerFunction('getMasterIbadahList', authToken);
        if(!result.success) throw new Error(result.error);
        const data = result.data;

        const content = document.getElementById('contentArea');
        content.innerHTML = `
          <div class="bg-white rounded-2xl p-6 shadow-lg">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-lg font-bold text-slate-800">
                <i class="fas fa-list-check text-emerald-500 mr-2"></i>Master Data Ibadah
              </h3>
              <button onclick="showMasterModal()" class="btn-primary text-white px-4 py-2 rounded-xl text-sm">
                <i class="fas fa-plus mr-2"></i>Tambah Baru
              </button>
            </div>
            
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead>
                  <tr class="bg-slate-50 border-b border-slate-200">
                    <th class="text-left py-3 px-4">Nama Ibadah</th>
                    <th class="text-left py-3 px-4">Key (Unique)</th>
                    <th class="text-center py-3 px-4">Poin</th>
                    <th class="text-center py-3 px-4">Icon/Warna</th>
                    <th class="text-center py-3 px-4">Aksi</th>
                  </tr>
                </thead>
                <tbody>
                  ${data.map(item => `
                    <tr class="border-b border-slate-100 hover:bg-slate-50">
                      <td class="py-3 px-4 font-medium">${item.name}</td>
                      <td class="py-3 px-4 text-slate-500 font-mono text-xs">${item.key}</td>
                      <td class="py-3 px-4 text-center">
                        <span class="bg-emerald-100 text-emerald-700 px-2 py-1 rounded-lg font-bold">${item.poin}</span>
                      </td>
                      <td class="py-3 px-4 text-center">
                         <div class="w-8 h-8 rounded-full bg-${item.color}-100 text-${item.color}-600 mx-auto flex items-center justify-center">
                            <i class="fas ${item.icon}"></i>
                         </div>
                         <div class="text-[10px] text-slate-400 mt-1">${item.color}</div>
                      </td>
                      <td class="py-3 px-4 text-center">
                        <button onclick="showMasterModal('${item.id}', '${item.name}', '${item.poin}', '${item.icon}', '${item.color}', '${item.key}')" class="text-blue-600 hover:text-blue-800 mx-1">
                          <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteMasterItem('${item.id}')" class="text-red-600 hover:text-red-800 mx-1">
                          <i class="fas fa-trash"></i>
                        </button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
      } catch (err) {
         showToast(err, 'error');
      } finally {
         hideLoading();
      }
    }

    function showMasterModal(id='', name='', poin='10', icon='fa-star', color='emerald', key='') {
       // Simple Prompt Implementation (Bisa diganti Modal UI Bagus jika mau)
       // Agar cepat, kita gunakan prompt berantai atau custom HTML modal sederhana
       
       // Sederhana: Form HTML string di dalam SweetAlert atau Custom Modal.
       // Disini saya buat modal element temporary
       const modalHtml = `
         <div id="masterModal" class="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center backdrop-blur-sm">
            <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl animate-fade-in">
               <h3 class="text-lg font-bold mb-4">${id ? 'Edit' : 'Tambah'} Ibadah</h3>
               <form id="masterForm" class="space-y-3">
                  <input type="hidden" id="m_id" value="${id}">
                  <div>
                    <label class="text-xs font-bold text-slate-600">Nama Ibadah</label>
                    <input type="text" id="m_name" value="${name}" class="w-full border rounded p-2 text-sm" required>
                  </div>
                  <div class="grid grid-cols-2 gap-2">
                     <div>
                        <label class="text-xs font-bold text-slate-600">Key (Huruf Kecil, tanpa spasi)</label>
                        <input type="text" id="m_key" value="${key}" ${id ? 'readonly' : ''} class="w-full border rounded p-2 text-sm bg-slate-50" placeholder="misal: tahajud" required>
                     </div>
                     <div>
                        <label class="text-xs font-bold text-slate-600">Poin</label>
                        <input type="number" id="m_poin" value="${poin}" class="w-full border rounded p-2 text-sm" required>
                     </div>
                  </div>
                  <div class="grid grid-cols-2 gap-2">
                     <div>
                        <label class="text-xs font-bold text-slate-600">Icon (FontAwesome)</label>
                        <input type="text" id="m_icon" value="${icon}" class="w-full border rounded p-2 text-sm" placeholder="fa-star">
                     </div>
                     <div>
                        <label class="text-xs font-bold text-slate-600">Warna (Tailwind)</label>
                        <select id="m_color" class="w-full border rounded p-2 text-sm">
                           <option value="emerald" ${color==='emerald'?'selected':''}>Hijau</option>
                           <option value="blue" ${color==='blue'?'selected':''}>Biru</option>
                           <option value="purple" ${color==='purple'?'selected':''}>Ungu</option>
                           <option value="orange" ${color==='orange'?'selected':''}>Orange</option>
                           <option value="pink" ${color==='pink'?'selected':''}>Pink</option>
                           <option value="red" ${color==='red'?'selected':''}>Merah</option>
                        </select>
                     </div>
                  </div>
                  <div class="flex justify-end space-x-2 mt-4">
                     <button type="button" onclick="document.getElementById('masterModal').remove()" class="px-4 py-2 bg-slate-200 rounded text-slate-700 text-sm">Batal</button>
                     <button type="submit" class="px-4 py-2 bg-emerald-600 text-white rounded text-sm">Simpan</button>
                  </div>
               </form>
            </div>
         </div>
       `;
       document.body.insertAdjacentHTML('beforeend', modalHtml);
       
       document.getElementById('masterForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const newId = document.getElementById('m_id').value;
          const newName = document.getElementById('m_name').value;
          const newKey = document.getElementById('m_key').value;
          const newPoin = document.getElementById('m_poin').value;
          const newIcon = document.getElementById('m_icon').value;
          const newColor = document.getElementById('m_color').value;
          
          showLoading();
          try {
             const res = await callServerFunction('saveMasterIbadahItem', authToken, newId, newName, newPoin, newIcon, newColor, newKey);
             if(res.success) {
                showToast('Data tersimpan');
                document.getElementById('masterModal').remove();
                loadMasterIbadahPage();
             } else {
                showToast(res.error, 'error');
             }
          } catch(err) { showToast(err, 'error'); }
          finally { hideLoading(); }
       });
    }

// ============================================
// HAPUS MASTER IBADAH (DENGAN SWEET ALERT)
// ============================================

function deleteMasterItem(id) {
  Swal.fire({
    title: 'Hapus Item Ini?',
    text: "Data ibadah lama siswa tidak akan hilang, tapi item ini tidak muncul lagi di form.",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#ef4444', // Merah
    cancelButtonColor: '#64748b',  // Abu-abu
    confirmButtonText: '<i class="fas fa-trash mr-1"></i> Ya, Hapus',
    cancelButtonText: 'Batal',
    background: '#fff',
    customClass: {
      popup: 'rounded-2xl',
      title: 'text-slate-800 font-bold',
      confirmButton: 'rounded-xl px-4 py-2 font-bold shadow-lg shadow-red-500/30',
      cancelButton: 'rounded-xl px-4 py-2 font-medium hover:bg-slate-100'
    }
  }).then((result) => {
    if (result.isConfirmed) {
      processDeleteMasterItem(id);
    }
  });
}

async function processDeleteMasterItem(id) {
  showLoading();
  try {
    const res = await callServerFunction('deleteMasterIbadahItem', authToken, id);
    
    // Sembunyikan loading sebelum menampilkan alert sukses
    hideLoading();

    if(res.success) {
       await Swal.fire({
         title: 'Terhapus!',
         text: 'Item ibadah berhasil dihapus.',
         icon: 'success',
         confirmButtonColor: '#10b981', // Emerald
         timer: 1500,
         showConfirmButton: false,
         customClass: { popup: 'rounded-2xl' }
       });
       
       // Refresh Halaman
       loadMasterIbadahPage();
    } else {
       showToast(res.error, 'error');
    }
  } catch(err) { 
     hideLoading();
     showToast(err, 'error'); 
  }
}
// ============================================
    // 2. HALAMAN JURNAL KULTUM (BARU)
    // ============================================
async function loadInputKultum() {
      showLoading();
      const content = document.getElementById('contentArea');
      
      try {
        const today = new Date().toISOString().split('T')[0];
        
        // 1. Render Form HTML Terlebih Dahulu
        content.innerHTML = `
          <div class="max-w-2xl mx-auto pb-20">
            <div class="bg-white rounded-2xl p-6 md:p-8 shadow-lg border-t-4 border-purple-500">
              
              <div class="text-center mb-8">
                <div class="w-16 h-16 bg-purple-100 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-sm">
                  <i class="fas fa-microphone-alt text-purple-600 text-3xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-800">Jurnal Kultum</h2>
                <p class="text-slate-500 text-sm">Catat ringkasan ceramah/kultum harian</p>
              </div>
              
              <form id="kultumForm" class="space-y-5">
                
                <div>
                  <label class="block text-slate-700 font-bold mb-2 text-xs uppercase tracking-wider">Tanggal</label>
                  <div class="relative">
                     <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-calendar-day text-slate-400"></i>
                     </span>
                     <input type="date" id="k_tanggal" value="${today}" required class="w-full pl-10 px-4 py-3 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-shadow">
                  </div>
                </div>

                <div>
                  <label class="block text-slate-700 font-medium mb-2 text-sm">Nama Penceramah</label>
                  <input type="text" id="k_penceramah" required class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Contoh: Ust. Abdul Somad">
                </div>

                <div>
                  <label class="block text-slate-700 font-medium mb-2 text-sm">Judul / Topik</label>
                  <input type="text" id="k_judul" required class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Contoh: Keutamaan Bulan Ramadhan">
                </div>

                <div>
                  <label class="block text-slate-700 font-medium mb-2 text-sm">Nama Masjid / Lokasi</label>
                  <input type="text" id="k_masjid" required class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Contoh: Masjid Al-Falah">
                </div>

                <div>
                  <label class="block text-slate-700 font-medium mb-2 text-sm">Ringkasan Materi</label>
                  <textarea id="k_ringkasan" rows="4" required class="w-full px-4 py-3 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Tuliskan poin-poin penting ceramah..."></textarea>
                </div>

                <div class="bg-purple-50 rounded-xl p-4 border border-purple-100 flex items-center justify-between">
                  <span class="text-purple-700 font-bold text-sm"><i class="fas fa-star mr-2"></i>Reward:</span>
                  <span class="font-bold text-purple-700">+10 Poin</span>
                </div>

                <button type="submit" class="w-full btn-primary bg-purple-600 hover:bg-purple-700 text-white font-bold text-lg py-3.5 rounded-xl shadow-lg shadow-purple-500/30 transition-all transform active:scale-95 flex items-center justify-center space-x-2">
                  <i class="fas fa-save"></i>
                  <span id="btnText">Simpan Jurnal</span>
                </button>
              </form>
            </div>
          </div>
        `;

        // 2. Definisi Fungsi Pengisi Form (Reusable)
        const populateForm = (data) => {
            if (data.success && data.found) {
                document.getElementById('k_penceramah').value = data.data.penceramah || '';
                document.getElementById('k_judul').value = data.data.judul || '';
                document.getElementById('k_masjid').value = data.data.masjid || '';
                document.getElementById('k_ringkasan').value = data.data.ringkasan || '';
                document.getElementById('btnText').textContent = 'Update Jurnal';
            } else {
                // Reset form kecuali tanggal
                document.getElementById('k_penceramah').value = '';
                document.getElementById('k_judul').value = '';
                document.getElementById('k_masjid').value = '';
                document.getElementById('k_ringkasan').value = '';
                document.getElementById('btnText').textContent = 'Simpan Jurnal';
            }
        };

        // 3. Logika Load Data (Cache vs Server)
        let initialData = null;

        // [CEK CACHE] Jika data hari ini ada di appCache (dari preload dashboard), pakai itu
        if (appCache && appCache.kultumToday && document.getElementById('k_tanggal').value === today) {
            // console.log("Menggunakan data Kultum dari Cache...");
            initialData = appCache.kultumToday;
        } else {
            // Fallback ke server
            initialData = await callServerFunction('getKultumData', authToken, today);
        }

        // Isi form dengan data awal
        populateForm(initialData);


        // 4. Event Listener: Ganti Tanggal
        document.getElementById('k_tanggal').addEventListener('change', async function() {
            const selectedDate = this.value;
            showLoading(); // Tampilkan loading overlay

            try {
                // Reset form dulu agar bersih
                document.getElementById('k_penceramah').value = '';
                document.getElementById('k_judul').value = '';
                document.getElementById('k_masjid').value = '';
                document.getElementById('k_ringkasan').value = '';

                // Fetch data tanggal baru dari server
                const res = await callServerFunction('getKultumData', authToken, selectedDate);
                populateForm(res);
                
            } catch(e) {
                showToast('Gagal memuat tanggal ini: ' + e, 'error');
            } finally {
                hideLoading(); // Pastikan loading hilang setelah fetch tanggal baru
            }
        });


        // 5. Event Listener: Submit Form
        document.getElementById('kultumForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const tanggal = document.getElementById('k_tanggal').value;
          const penceramah = document.getElementById('k_penceramah').value;
          const judul = document.getElementById('k_judul').value;
          const masjid = document.getElementById('k_masjid').value;
          const ringkasan = document.getElementById('k_ringkasan').value;
          
          showLoading();
          
          try {
            const result = await callServerFunction('saveKultumData', authToken, tanggal, penceramah, judul, masjid, ringkasan);
            
            if (result.success) {
              showToast(result.message);
              
              // Update Cache jika kita mengedit data hari ini
              if (tanggal === today && appCache) {
                  appCache.kultumToday = {
                      success: true,
                      found: true,
                      data: { penceramah, judul, masjid, ringkasan }
                  };
              }
              
              window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
              showToast(result.error, 'error');
            }
          } catch (error) {
            showToast('Gagal menyimpan: ' + error, 'error');
          } finally {
            hideLoading();
          }
        });

      } catch (error) {
         // Jika ada error fatal saat inisialisasi awal
         content.innerHTML = `<div class="p-8 text-center text-red-500">
            <i class="fas fa-exclamation-triangle text-3xl mb-2"></i><br>
            Gagal memuat Jurnal Kultum: ${error}
         </div>`;
      } finally {
         // [PENTING] Ini menjamin loading hilang setelah fungsi selesai (sukses/gagal)
         hideLoading();
      }
    }
    
    function toggleCheckbox(id) {
      const checkbox = document.getElementById(id);
      checkbox.checked = !checkbox.checked;
      calculateTotalPoin();
    }

    function calculateTotalPoin() {
      const points = {
        puasa: 20,
        sholat: 25,
        tarawih: 15,
        tadarus: 10,
        sedekah: 10,
        dzikir: 5
      };
      
      let total = 0;
      for (const id in points) {
        if (document.getElementById(id).checked) {
          total += points[id];
        }
      }
      
      document.getElementById('totalPoinDisplay').textContent = total;
    }

    // ============================================
    // HISTORY PAGE
    // ============================================
async function loadHistory() {
  showLoading();
  
  try {
    // 1. [BARU] Logika Cek Cache vs Server
    // Kita cek apakah data history dan master ibadah sudah tersedia di cache
    if (appCache.history && appCache.masterIbadah) {
        // console.log("Menggunakan data History dari Cache..."); // Opsional: untuk debug
        globalHistoryList = appCache.history;
        globalMasterData = appCache.masterIbadah;
    } else {
        // Jika cache kosong, ambil dari Server (Fallback)
        const [historyRes, masterRes] = await Promise.all([
           callServerFunction('getIbadahHistory', authToken, currentUser.userId),
           callServerFunction('getMasterIbadahList', authToken)
        ]);
        
        if (!historyRes.success) throw new Error(historyRes.error);
        if (!masterRes.success) throw new Error(masterRes.error);
        
        globalHistoryList = historyRes.data;
        globalMasterData = masterRes.data;
    }
    
    // 2. Reset State Halaman
    currentHistoryPage = 1;
    historySearchQuery = '';
    
    // 3. Render Kerangka UI
    const content = document.getElementById('contentArea');
    content.innerHTML = `
      <div class="bg-white rounded-2xl p-6 shadow-lg pb-10 min-h-[80vh]">
        
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
          <div>
            <h3 class="text-lg font-bold text-slate-800">
              <i class="fas fa-history text-emerald-500 mr-2"></i>Riwayat Ibadah
            </h3>
            <p class="text-sm text-slate-500">Total: <span id="historyTotalCount">${globalHistoryList.length}</span> Catatan</p>
          </div>
        </div>

        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 bg-slate-50 p-4 rounded-xl border border-slate-100">
          
          <div class="flex items-center space-x-2 text-sm text-slate-600 w-full md:w-auto">
            <span>Tampilkan</span>
            <select onchange="handleHistoryRowsChange(this.value)" class="border border-slate-300 rounded-lg px-2 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white">
              <option value="10">10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
              <option value="all">Semua</option>
            </select>
            <span>data</span>
          </div>

          <div class="relative w-full md:w-72">
            <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-search text-slate-400"></i>
            </span>
            <input type="text" oninput="handleHistorySearch(this.value)" 
              class="w-full pl-10 pr-4 py-2 text-sm border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-shadow" 
              placeholder="Cari Tanggal, Catatan, Kultum...">
          </div>
        </div>
        
        <div id="historyListContainer" class="space-y-4">
           </div>

        <div id="historyPagination" class="flex flex-col md:flex-row justify-between items-center mt-8 gap-4 text-sm text-slate-600 border-t border-slate-100 pt-4">
           </div>

      </div>
    `;

    // 4. Render Data Pertama Kali
    renderHistoryList();

  } catch (error) {
    const content = document.getElementById('contentArea');
    content.innerHTML = `
        <div class="p-6 text-center text-red-500">
            <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
            <p>Gagal memuat riwayat: ${error}</p>
            <button onclick="loadHistory()" class="mt-4 text-sm text-blue-600 underline">Coba Lagi</button>
        </div>
    `;
  } finally {
    hideLoading();
  }
}
    // ============================================
    // RANKING PAGES
    // ============================================
async function loadRankingClass() {
      showLoading();
      
      try {
        let ranking;

        // [BARU] LOGIKA CEK CACHE
        // Jika data ranking sudah tersedia di variabel global appCache, gunakan itu.
        if (appCache.rankingClass) {
            // console.log("Mengambil ranking dari cache..."); // Debugging
            ranking = appCache.rankingClass;
        } else {
            // Jika tidak ada di cache, ambil dari server
            const result = await callServerFunction('getRankingClass', authToken, currentUser.classId);
            
            if (!result.success) {
                showToast(result.error, 'error');
                return;
            }
            ranking = result.data;
        }
        
        // Render HTML
        const content = document.getElementById('contentArea');
        content.innerHTML = `
          <div class="bg-white rounded-2xl p-6 shadow-lg">
            <h3 class="text-lg font-bold text-slate-800 mb-4">
              <i class="fas fa-trophy text-yellow-500 mr-2"></i>Ranking Kelas
            </h3>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead>
                  <tr class="border-b border-slate-200">
                    <th class="text-left py-3 px-4 text-slate-600 font-semibold">Rank</th>
                    <th class="text-left py-3 px-4 text-slate-600 font-semibold">NIS</th>
                    <th class="text-left py-3 px-4 text-slate-600 font-semibold">Nama</th>
                    <th class="text-right py-3 px-4 text-slate-600 font-semibold">Total Poin</th>
                  </tr>
                </thead>
                <tbody>
                  ${ranking.map((student, index) => {
                    // Logic untuk styling baris user yang sedang login
                    const isMe = student.userId === currentUser.userId;
                    const rowClass = isMe ? 'bg-emerald-50' : '';
                    
                    // Logic ikon medali vs nomor biasa
                    let rankDisplay;
                    if (index === 0) {
                        rankDisplay = '<i class="fas fa-medal text-2xl text-yellow-500"></i>';
                    } else if (index === 1) {
                        rankDisplay = '<i class="fas fa-medal text-2xl text-slate-400"></i>';
                    } else if (index === 2) {
                        rankDisplay = '<i class="fas fa-medal text-2xl text-orange-600"></i>';
                    } else {
                        rankDisplay = `<span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-slate-100 text-slate-600 text-sm font-bold">${index + 1}</span>`;
                    }

                    return `
                    <tr class="border-b border-slate-100 hover:bg-slate-50 ${rowClass}">
                      <td class="py-3 px-4">
                        ${rankDisplay}
                      </td>
                      <td class="py-3 px-4 text-slate-600 font-mono text-sm">${student.nis}</td>
                      <td class="py-3 px-4">
                        <div class="flex items-center">
                            <span class="font-medium text-slate-800">${student.name}</span>
                            ${isMe ? '<span class="ml-2 text-[10px] bg-emerald-100 text-emerald-600 px-2 py-0.5 rounded-full font-bold uppercase tracking-wide">Anda</span>' : ''}
                        </div>
                      </td>
                      <td class="py-3 px-4 text-right">
                        <span class="inline-flex items-center px-3 py-1 rounded-full bg-emerald-100 text-emerald-600 font-bold text-sm">
                          ${student.totalPoin} Poin
                        </span>
                      </td>
                    </tr>
                  `}).join('')}
                </tbody>
              </table>
            </div>
            
            ${ranking.length === 0 ? 
                `<div class="text-center py-8 text-slate-400 italic">Belum ada data ranking untuk kelas ini.</div>` 
                : ''}

          </div>
        `;

      } catch (error) {
        showToast('Terjadi kesalahan: ' + error, 'error');
        const content = document.getElementById('contentArea');
        content.innerHTML = `<div class="p-6 text-center text-red-500">Gagal memuat ranking.</div>`;
      } finally {
        hideLoading();
      }
    }

async function loadRankingSchool() {
      showLoading();
      
      try {
        // Ambil data ranking dari server
        const result = await callServerFunction('getRankingSchool', authToken, currentUser.schoolId);
        
        if (!result.success) {
          showToast(result.error, 'error');
          return;
        }
        
        // Simpan data ke variable global
        // PENTING: Kita tambahkan properti 'originalRank' agar nomor ranking tidak berubah saat difilter/search
        globalSchoolRankingList = result.data.map((item, index) => ({
            ...item,
            originalRank: index + 1
        }));
        
        // Reset state
        currentSchoolPage = 1;
        schoolSearchQuery = '';
        
        const content = document.getElementById('contentArea');
        content.innerHTML = `
          <div class="bg-white rounded-2xl p-6 shadow-lg">
            <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
              <div>
                <h3 class="text-lg font-bold text-slate-800">
                  <i class="fas fa-trophy text-yellow-500 mr-2"></i>Ranking Sekolah
                </h3>
                <p class="text-sm text-slate-500">Total: ${globalSchoolRankingList.length} Siswa</p>
              </div>
            </div>
            
            <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
              
              <div class="flex items-center space-x-2 text-sm text-slate-600">
                <span>Tampilkan</span>
                <select id="schoolRowsSelect" onchange="handleSchoolRowsChange(this.value)" class="border border-slate-300 rounded-lg px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white">
                  <option value="10">10</option>
                  <option value="25">25</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                  <option value="all">Semua</option>
                </select>
                <span>data</span>
              </div>

              <div class="relative w-full md:w-64">
                <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i class="fas fa-search text-slate-400"></i>
                </span>
                <input type="text" id="schoolSearchInput" oninput="handleSchoolSearch(this.value)" 
                  class="w-full pl-10 pr-4 py-2 text-sm border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-shadow" 
                  placeholder="Cari Nama, NIS, atau Kelas...">
              </div>
            </div>
            
            <div class="overflow-x-auto rounded-xl border border-slate-200">
              <table class="w-full text-sm">
                <thead>
                  <tr class="bg-slate-50 border-b border-slate-200 text-slate-600 uppercase tracking-wider text-xs">
                    <th class="text-left py-3 px-4 font-bold">Rank</th>
                    <th class="text-left py-3 px-4 font-bold">NIS</th>
                    <th class="text-left py-3 px-4 font-bold">Nama</th>
                    <th class="text-left py-3 px-4 font-bold">Kelas</th>
                    <th class="text-right py-3 px-4 font-bold">Total Poin</th>
                  </tr>
                </thead>
                <tbody id="schoolRankingTableBody" class="divide-y divide-slate-100">
                   </tbody>
              </table>
            </div>

            <div id="schoolPagination" class="flex flex-col md:flex-row justify-between items-center mt-4 gap-4 text-sm text-slate-600">
               </div>

          </div>
        `;

        // Render Data Awal
        renderSchoolRankingTable();

      } catch (error) {
        showToast('Terjadi kesalahan: ' + error, 'error');
      } finally {
        hideLoading();
      }
    }

async function loadRankingGlobal() {
      showLoading();
      
      try {
        const result = await callServerFunction('getRankingGlobal', authToken);
        
        if (!result.success) {
          showToast(result.error, 'error');
          return;
        }
        
        // 1. Simpan data ke Global State
        // Tambahkan properti originalRank agar ranking tetap sesuai urutan asli saat di-search
        globalRankingList = result.data.map((item, index) => ({
            ...item,
            originalRank: index + 1
        }));
        
        // 2. Reset State Halaman
        currentGlobalPage = 1;
        globalSearchQuery = '';
        
        const content = document.getElementById('contentArea');
        content.innerHTML = `
          <div class="bg-white rounded-2xl p-6 shadow-lg">
            
            <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
              <div>
                <h3 class="text-lg font-bold text-slate-800">
                  <i class="fas fa-globe text-blue-500 mr-2"></i>Ranking Global
                </h3>
                <p class="text-sm text-slate-500">Total: ${globalRankingList.length} Siswa</p>
              </div>
            </div>
            
            <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
              
              <div class="flex items-center space-x-2 text-sm text-slate-600">
                <span>Tampilkan</span>
                <select id="globalRowsSelect" onchange="handleGlobalRowsChange(this.value)" class="border border-slate-300 rounded-lg px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white">
                  <option value="10">10</option>
                  <option value="25">25</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                  <option value="all">Semua</option>
                </select>
                <span>data</span>
              </div>

              <div class="relative w-full md:w-64">
                <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i class="fas fa-search text-slate-400"></i>
                </span>
                <input type="text" id="globalSearchInput" oninput="handleGlobalSearch(this.value)" 
                  class="w-full pl-10 pr-4 py-2 text-sm border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-shadow" 
                  placeholder="Cari Nama, Sekolah, Kelas...">
              </div>
            </div>
            
            <div class="overflow-x-auto rounded-xl border border-slate-200">
              <table class="w-full text-sm">
                <thead>
                  <tr class="bg-slate-50 border-b border-slate-200 text-slate-600 uppercase tracking-wider text-xs">
                    <th class="text-left py-3 px-4 font-bold">Rank</th>
                    <th class="text-left py-3 px-4 font-bold">NIS</th>
                    <th class="text-left py-3 px-4 font-bold">Nama</th>
                    <th class="text-left py-3 px-4 font-bold">Sekolah</th>
                    <th class="text-left py-3 px-4 font-bold">Kelas</th>
                    <th class="text-right py-3 px-4 font-bold">Total Poin</th>
                  </tr>
                </thead>
                <tbody id="globalRankingTableBody" class="divide-y divide-slate-100">
                   </tbody>
              </table>
            </div>

            <div id="globalPagination" class="flex flex-col md:flex-row justify-between items-center mt-4 gap-4 text-sm text-slate-600">
               </div>

          </div>
        `;

        // 3. Render Tabel Pertama Kali
        renderGlobalRankingTable();

      } catch (error) {
        showToast('Terjadi kesalahan: ' + error, 'error');
      } finally {
        hideLoading();
      }
    }

    // ============================================
    // CLASS MANAGEMENT (Admin)
    // ============================================
async function loadClassManagement() {
      showLoading();
      
      try {
        const result = await callServerFunction('getClasses', authToken, currentUser.schoolId);
        
        if (!result.success) {
          showToast(result.error, 'error');
          return;
        }
        
        const classes = result.data;
        
        const content = document.getElementById('contentArea');
        content.innerHTML = `
          <div class="bg-white rounded-2xl p-6 shadow-lg">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-lg font-bold text-slate-800">
                <i class="fas fa-chalkboard text-emerald-500 mr-2"></i>Daftar Kelas
              </h3>
              <button onclick="openClassModal('add')" class="btn-primary text-white px-6 py-2 rounded-xl shadow-md hover:shadow-lg transition transform hover:-translate-y-1">
                <i class="fas fa-plus mr-2"></i>Tambah Kelas
              </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              ${classes.map(cls => `
                <div class="border border-slate-200 rounded-xl p-4 hover:shadow-lg transition bg-slate-50/50 group">
                  <div class="flex items-center justify-between mb-3">
                    <h4 class="font-bold text-slate-800 text-lg">${cls.name}</h4>
                    <span class="text-xs ${cls.status === 'active' ? 'bg-emerald-100 text-emerald-600 border border-emerald-200' : 'bg-red-100 text-red-600 border border-red-200'} px-2 py-1 rounded-full font-bold uppercase">
                      ${cls.status}
                    </span>
                  </div>
                  <p class="text-xs text-slate-400 mb-4 font-mono">${cls.classId}</p>
                  
                  <div class="flex space-x-2 pt-2 border-t border-slate-200">
                    <button onclick="openClassModal('edit', '${cls.classId}', '${cls.name}')" 
                      class="flex-1 bg-white border border-blue-200 text-blue-600 px-3 py-2 rounded-lg hover:bg-blue-50 transition font-medium text-sm">
                      <i class="fas fa-edit mr-1"></i>Edit
                    </button>
                    
                    <button onclick="deleteClass('${cls.classId}')" 
                      class="flex-1 bg-white border border-red-200 text-red-600 px-3 py-2 rounded-lg hover:bg-red-50 transition font-medium text-sm">
                      <i class="fas fa-trash mr-1"></i>Hapus
                    </button>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      } catch (error) {
        showToast('Terjadi kesalahan: ' + error, 'error');
      } finally {
        hideLoading();
      }
    }

// ============================================
    // CLASS MODAL LOGIC (PENGGANTI PROMPT)
    // ============================================

    function openClassModal(mode, classId = '', className = '') {
      const modal = document.getElementById('classModal');
      const title = document.getElementById('classModalTitle');
      
      // Set Hidden Values
      document.getElementById('class_mode').value = mode;
      document.getElementById('class_id').value = classId;
      document.getElementById('class_name').value = className;
      
      // Ubah Judul Modal
      if (mode === 'add') {
        title.innerHTML = '<i class="fas fa-plus-circle mr-2"></i>Tambah Kelas Baru';
      } else {
        title.innerHTML = '<i class="fas fa-edit mr-2"></i>Edit Kelas';
      }
      
      // Tampilkan Modal
      modal.classList.remove('hidden');
      
      // Auto focus ke input
      setTimeout(() => document.getElementById('class_name').focus(), 100);
    }

    function closeClassModal() {
      document.getElementById('classModal').classList.add('hidden');
    }

    // HANDLE FORM SUBMIT
    document.getElementById('classForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const mode = document.getElementById('class_mode').value;
      const classId = document.getElementById('class_id').value;
      const name = document.getElementById('class_name').value;
      
      // Validasi sederhana
      if (!name) {
        showToast('Nama kelas tidak boleh kosong', 'error');
        return;
      }

      closeClassModal();
      showLoading();
      
      try {
        let result;
        
        if (mode === 'add') {
           // Panggil Backend: addClass(token, schoolId, name)
           result = await callServerFunction('addClass', authToken, currentUser.schoolId, name);
        } else {
           // Panggil Backend: updateClass(token, classId, name)
           result = await callServerFunction('updateClass', authToken, classId, name);
        }

        if (result.success) {
          showToast(mode === 'add' ? 'Kelas berhasil ditambahkan' : 'Kelas berhasil diperbarui');
          loadClassManagement(); // Refresh halaman
        } else {
          showToast(result.error, 'error');
        }
      } catch (error) {
        showToast('Gagal memproses: ' + error, 'error');
      } finally {
        hideLoading();
      }
    });

// ============================================
    // DELETE CLASS LOGIC (SWEET ALERT)
    // ============================================
    
    function deleteClass(classId) {
      Swal.fire({
        title: 'Hapus Kelas?',
        text: "Anda yakin ingin menghapus kelas ini? Data yang dihapus tidak dapat dikembalikan.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444', // Red-500
        cancelButtonColor: '#64748b', // Slate-500
        confirmButtonText: '<i class="fas fa-trash mr-1"></i> Ya, Hapus',
        cancelButtonText: 'Batal',
        background: '#fff',
        customClass: {
          popup: 'rounded-2xl',
          title: 'text-slate-800 font-bold',
          confirmButton: 'rounded-xl px-4 py-2 font-bold shadow-lg shadow-red-500/30',
          cancelButton: 'rounded-xl px-4 py-2 font-medium hover:bg-slate-100'
        }
      }).then((result) => {
        if (result.isConfirmed) {
          processDeleteClass(classId);
        }
      });
    }

    async function processDeleteClass(classId) {
      showLoading();
      
      try {
        // Panggil fungsi backend 'deleteClass'
        const result = await callServerFunction('deleteClass', authToken, classId);
        
        // Sembunyikan loading sebelum menampilkan alert sukses
        hideLoading();
        
        if (result.success) {
          // Tampilkan Sukses dengan SweetAlert
          await Swal.fire({
            title: 'Terhapus!',
            text: 'Kelas berhasil dihapus.',
            icon: 'success',
            confirmButtonColor: '#10b981', // Emerald-500
            confirmButtonText: 'Oke',
            timer: 1500,
            timerProgressBar: true,
            customClass: {
              popup: 'rounded-2xl',
              confirmButton: 'rounded-xl px-6 py-2'
            }
          });
          
          // Refresh Halaman/List Kelas
          loadClassManagement();
          
        } else {
          showToast(result.error, 'error');
        }
      } catch (error) {
        hideLoading();
        showToast('Terjadi kesalahan: ' + error, 'error');
      }
    }
    // ============================================
    // STUDENT MANAGEMENT (Admin)
    // ============================================
async function loadStudentManagement() {
  showLoading();
  
  try {
    // [OPTIMASI] Load Siswa DAN Kelas secara bersamaan agar cache siap
    const promises = [];
    
    // 1. Request Data Siswa (Jika belum ada di cache)
    if (appCache.students) {
        globalStudentList = appCache.students;
    } else {
        promises.push(
            callServerFunction('getUsers', authToken, currentUser.schoolId, null)
            .then(res => {
                if(res.success) {
                    globalStudentList = res.data.filter(u => u.role === 'siswa');
                    appCache.students = globalStudentList; // Simpan ke cache
                }
            })
        );
    }

    // 2. Request Data Kelas (Jika belum ada di cache)
    if (!appCache.classes) {
        promises.push(
            callServerFunction('getClasses', authToken, currentUser.schoolId)
            .then(res => {
                if(res.success) appCache.classes = res.data; // Simpan ke cache
            })
        );
    }

    // Tunggu semua request selesai
    if (promises.length > 0) {
        await Promise.all(promises);
    }
    
    // Reset state pencarian & pagination
    currentStudentPage = 1;
    studentSearchQuery = '';
    
    // Render HTML (Sama seperti sebelumnya...)
    const content = document.getElementById('contentArea');
    content.innerHTML = `
      <div class="bg-white rounded-2xl p-6 shadow-lg">
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
          <div>
            <h3 class="text-lg font-bold text-slate-800 flex items-center">
              <i class="fas fa-user-graduate text-emerald-500 mr-2"></i>Daftar Siswa
            </h3>
            <p class="text-sm text-slate-500 mt-1">Total: <span id="totalStudentsCount">${globalStudentList.length}</span> Siswa</p>
          </div>
          
          <button onclick="openStudentModal('add')" class="btn-primary text-white px-5 py-2.5 rounded-xl text-sm shadow-md hover:shadow-lg transition transform hover:-translate-y-0.5 flex items-center">
            <i class="fas fa-plus mr-2"></i>Tambah Siswa
          </button>
        </div>
        
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 bg-slate-50 p-4 rounded-xl border border-slate-100">
          <div class="flex items-center space-x-2 text-sm text-slate-600 w-full md:w-auto">
            <span>Tampilkan</span>
            <select id="studentRowsSelect" onchange="handleStudentRowsChange(this.value)" class="border border-slate-300 rounded-lg px-2 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white shadow-sm">
              <option value="10">10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
              <option value="all">Semua</option>
            </select>
            <span>data</span>
          </div>

          <div class="relative w-full md:w-72">
            <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-search text-slate-400"></i>
            </span>
            <input type="text" id="studentSearchInput" oninput="handleStudentSearch(this.value)" 
              class="w-full pl-10 pr-4 py-2 text-sm border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-shadow shadow-sm" 
              placeholder="Cari Nama atau NIS...">
          </div>
        </div>
        
        <div class="overflow-x-auto rounded-xl border border-slate-200 shadow-sm">
          <table class="w-full text-sm">
            <thead>
              <tr class="bg-slate-100 border-b border-slate-200 text-slate-600 uppercase tracking-wider text-xs">
                <th class="text-left py-3 px-4 font-bold">NIS</th>
                <th class="text-left py-3 px-4 font-bold">Nama Lengkap</th>
                <th class="text-left py-3 px-4 font-bold">Kelas</th>
                <th class="text-center py-3 px-4 font-bold">Status</th>
                <th class="text-center py-3 px-4 font-bold">Aksi</th>
              </tr>
            </thead>
            <tbody id="studentTableBody" class="divide-y divide-slate-100 bg-white">
            </tbody>
          </table>
        </div>

        <div id="studentPagination" class="flex flex-col md:flex-row justify-between items-center mt-6 gap-4 text-sm text-slate-600 border-t border-slate-100 pt-4">
        </div>
      </div>
    `;

    renderStudentTable();

  } catch (error) {
    showToast('Terjadi kesalahan: ' + error, 'error');
  } finally {
    hideLoading();
  }
}
// ============================================
    // LOGIKA PAGINATION & SEARCH SISWA
    // ============================================

    function handleStudentRowsChange(value) {
      studentRowsPerPage = value === 'all' ? globalStudentList.length : parseInt(value);
      currentStudentPage = 1; // Reset ke halaman 1
      renderStudentTable();
    }

    function handleStudentSearch(query) {
      studentSearchQuery = query.toLowerCase();
      currentStudentPage = 1; // Reset ke halaman 1 saat mencari
      renderStudentTable();
    }

    function changeStudentPage(newPage) {
      currentStudentPage = newPage;
      renderStudentTable();
    }

    function renderStudentTable() {
      const tbody = document.getElementById('studentTableBody');
      const paginationDiv = document.getElementById('studentPagination');
      
      // 1. FILTER DATA
      const filteredData = globalStudentList.filter(student => 
        student.name.toLowerCase().includes(studentSearchQuery) || 
        student.nis.toString().includes(studentSearchQuery)
      );

      // 2. HITUNG PAGINATION
      const totalItems = filteredData.length;
      const totalPages = Math.ceil(totalItems / studentRowsPerPage);
      
      // Validasi page agar tidak out of bound
      if (currentStudentPage < 1) currentStudentPage = 1;
      if (currentStudentPage > totalPages && totalPages > 0) currentStudentPage = totalPages;

      const startIndex = (currentStudentPage - 1) * studentRowsPerPage;
      const endIndex = Math.min(startIndex + studentRowsPerPage, totalItems);
      
      const pageData = filteredData.slice(startIndex, endIndex);

      // 3. RENDER TABEL
      if (totalItems === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="py-8 text-center text-slate-400 italic">
              <i class="fas fa-search mb-2 text-xl"></i><br>
              Data siswa tidak ditemukan
            </td>
          </tr>`;
} else {
        tbody.innerHTML = pageData.map(student => `
          <tr class="hover:bg-slate-50 transition duration-150">
            <td class="py-3 px-4 text-slate-600 font-mono">${student.nis}</td>
            <td class="py-3 px-4 font-medium text-slate-800">${student.name}</td>
            <td class="py-3 px-4 text-slate-600">
               <span class="bg-slate-100 text-slate-600 px-2 py-0.5 rounded text-xs border border-slate-200">
                 ${student.classId} </span>
            </td>
            <td class="py-3 px-4 text-center">
              <span class="text-xs ${student.status === 'active' ? 'bg-emerald-100 text-emerald-600 border border-emerald-200' : 'bg-red-100 text-red-600 border border-red-200'} px-2 py-1 rounded-full font-medium">
                ${student.status}
              </span>
            </td>
            <td class="py-3 px-4 text-center">
              <div class="flex items-center justify-center space-x-2">
                
                <button onclick="openStudentModal('edit', '${student.userId}', '${student.nis}', '${student.name}', '${student.classId}', '${student.status}')" 
                  class="w-8 h-8 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-100 hover:text-blue-700 transition flex items-center justify-center" title="Edit">
                  <i class="fas fa-edit"></i>
                </button>
                
                <button onclick="deleteStudent('${student.userId}')" 
                  class="w-8 h-8 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 hover:text-red-700 transition flex items-center justify-center" title="Hapus">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `).join('');
      }

      // 4. RENDER PAGINATION CONTROLS
      if (totalItems > 0) {
        paginationDiv.innerHTML = `
          <div>
            Menampilkan <span class="font-bold text-slate-800">${startIndex + 1}</span> 
            sampai <span class="font-bold text-slate-800">${endIndex}</span> 
            dari <span class="font-bold text-slate-800">${totalItems}</span> data
          </div>
          
          <div class="flex items-center space-x-1">
            <button onclick="changeStudentPage(${currentStudentPage - 1})" 
              class="px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition"
              ${currentStudentPage === 1 ? 'disabled' : ''}>
              <i class="fas fa-chevron-left text-xs"></i>
            </button>
            
            ${generatePageNumbers(currentStudentPage, totalPages)}
            
            <button onclick="changeStudentPage(${currentStudentPage + 1})" 
              class="px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition"
              ${currentStudentPage === totalPages ? 'disabled' : ''}>
              <i class="fas fa-chevron-right text-xs"></i>
            </button>
          </div>
        `;
      } else {
        paginationDiv.innerHTML = '';
      }
    }

    function generatePageNumbers(current, total) {
       // Logic sederhana untuk membatasi jumlah tombol halaman jika halaman sangat banyak
       let buttons = '';
       const maxButtons = 5; 
       let startPage = Math.max(1, current - 2);
       let endPage = Math.min(total, startPage + maxButtons - 1);
       
       if (endPage - startPage < maxButtons - 1) {
          startPage = Math.max(1, endPage - maxButtons + 1);
       }

       for (let i = startPage; i <= endPage; i++) {
          const activeClass = i === current 
             ? 'bg-emerald-500 text-white border-emerald-500 shadow-sm' 
             : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50';
          
          buttons += `
             <button onclick="changeStudentPage(${i})" 
               class="px-3 py-1.5 text-xs font-medium rounded-lg border transition ${activeClass}">
               ${i}
             </button>
          `;
       }
       return buttons;
    }

// ============================================
    // LOGIKA PAGINATION & SEARCH RANKING SEKOLAH
    // ============================================

    function handleSchoolRowsChange(value) {
      schoolRowsPerPage = value === 'all' ? globalSchoolRankingList.length : parseInt(value);
      currentSchoolPage = 1;
      renderSchoolRankingTable();
    }

    function handleSchoolSearch(query) {
      schoolSearchQuery = query.toLowerCase();
      currentSchoolPage = 1;
      renderSchoolRankingTable();
    }

    function changeSchoolPage(newPage) {
      currentSchoolPage = newPage;
      renderSchoolRankingTable();
    }

    function renderSchoolRankingTable() {
      const tbody = document.getElementById('schoolRankingTableBody');
      const paginationDiv = document.getElementById('schoolPagination');
      
      // 1. FILTER DATA
      // Kita mencari berdasarkan Nama, NIS, atau Kelas
      const filteredData = globalSchoolRankingList.filter(student => 
        student.name.toLowerCase().includes(schoolSearchQuery) || 
        student.nis.toString().includes(schoolSearchQuery) ||
        (student.className && student.className.toLowerCase().includes(schoolSearchQuery))
      );

      // 2. HITUNG PAGINATION
      const totalItems = filteredData.length;
      const totalPages = Math.ceil(totalItems / schoolRowsPerPage);
      
      if (currentSchoolPage < 1) currentSchoolPage = 1;
      if (currentSchoolPage > totalPages && totalPages > 0) currentSchoolPage = totalPages;

      const startIndex = (currentSchoolPage - 1) * schoolRowsPerPage;
      const endIndex = Math.min(startIndex + schoolRowsPerPage, totalItems);
      
      const pageData = filteredData.slice(startIndex, endIndex);

      // 3. RENDER TABEL
      if (totalItems === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="py-8 text-center text-slate-400 italic">
              <i class="fas fa-search mb-2 text-xl"></i><br>
              Data tidak ditemukan
            </td>
          </tr>`;
      } else {
        tbody.innerHTML = pageData.map(student => {
            // Logika UI untuk Trophy Top 3
            let rankDisplay = '';
            if (student.originalRank === 1) rankDisplay = '<i class="fas fa-medal text-2xl text-yellow-500"></i>';
            else if (student.originalRank === 2) rankDisplay = '<i class="fas fa-medal text-2xl text-slate-400"></i>';
            else if (student.originalRank === 3) rankDisplay = '<i class="fas fa-medal text-2xl text-orange-600"></i>';
            else rankDisplay = `<span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-slate-100 text-slate-600 font-bold">${student.originalRank}</span>`;

            return `
              <tr class="hover:bg-slate-50 transition duration-150">
                <td class="py-3 px-4">
                  ${rankDisplay}
                </td>
                <td class="py-3 px-4 text-slate-600 font-mono">${student.nis}</td>
                <td class="py-3 px-4 font-medium text-slate-800">${student.name}</td>
                <td class="py-3 px-4 text-slate-600">${student.className || '-'}</td>
                <td class="py-3 px-4 text-right">
                  <span class="inline-flex items-center px-3 py-1 rounded-full bg-emerald-100 text-emerald-600 font-semibold shadow-sm">
                    ${student.totalPoin}
                  </span>
                </td>
              </tr>
            `;
        }).join('');
      }

      // 4. RENDER PAGINATION CONTROLS
      if (totalItems > 0) {
        paginationDiv.innerHTML = `
          <div>
            Menampilkan <span class="font-bold text-slate-800">${startIndex + 1}</span> 
            sampai <span class="font-bold text-slate-800">${endIndex}</span> 
            dari <span class="font-bold text-slate-800">${totalItems}</span> data
          </div>
          
          <div class="flex items-center space-x-1">
            <button onclick="changeSchoolPage(${currentSchoolPage - 1})" 
              class="px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition"
              ${currentSchoolPage === 1 ? 'disabled' : ''}>
              <i class="fas fa-chevron-left text-xs"></i>
            </button>
            
            ${generatePageNumbers(currentSchoolPage, totalPages)}
            
            <button onclick="changeSchoolPage(${currentSchoolPage + 1})" 
              class="px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition"
              ${currentSchoolPage === totalPages ? 'disabled' : ''}>
              <i class="fas fa-chevron-right text-xs"></i>
            </button>
          </div>
        `;
      } else {
        paginationDiv.innerHTML = '';
      }
    }

// ============================================
    // LOGIKA PAGINATION & SEARCH ADMIN
    // ============================================

    function handleAdminRowsChange(value) {
      adminRowsPerPage = value === 'all' ? globalAdminList.length : parseInt(value);
      currentAdminPage = 1; // Reset ke halaman 1
      renderAdminTable();
    }

    function handleAdminSearch(query) {
      adminSearchQuery = query.toLowerCase();
      currentAdminPage = 1; // Reset ke halaman 1 saat mencari
      renderAdminTable();
    }

    function changeAdminPage(newPage) {
      currentAdminPage = newPage;
      renderAdminTable();
    }

function renderAdminTable() {
  const tbody = document.getElementById('adminTableBody');
  const paginationDiv = document.getElementById('adminPagination');
  
  // 1. FILTER DATA
  // Filter berdasarkan Nama, Username (NIS), atau Sekolah
  const filteredData = globalAdminList.filter(admin => 
    admin.name.toLowerCase().includes(adminSearchQuery) || 
    admin.nis.toString().toLowerCase().includes(adminSearchQuery) ||
    (admin.schoolId && admin.schoolId.toLowerCase().includes(adminSearchQuery))
  );

  // 2. HITUNG PAGINATION
  const totalItems = filteredData.length;
  const totalPages = Math.ceil(totalItems / adminRowsPerPage);
  
  // Validasi page agar tidak out of bound
  if (currentAdminPage < 1) currentAdminPage = 1;
  if (currentAdminPage > totalPages && totalPages > 0) currentAdminPage = totalPages;

  const startIndex = (currentAdminPage - 1) * adminRowsPerPage;
  const endIndex = Math.min(startIndex + adminRowsPerPage, totalItems);
  
  const pageData = filteredData.slice(startIndex, endIndex);

  // 3. RENDER TABEL
  if (totalItems === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="6" class="py-8 text-center text-slate-400 italic">
          <i class="fas fa-search mb-2 text-xl"></i><br>
          Data pengelola tidak ditemukan
        </td>
      </tr>`;
  } else {
    tbody.innerHTML = pageData.map(user => {
      // Logika Tampilan Berdasarkan Role
      let roleBadge = '';
      let detailInfo = '';

      if (user.role === 'walikelas') {
        // Tampilan untuk WALI KELAS (Ungu)
        roleBadge = `
          <span class="bg-purple-100 text-purple-700 px-2 py-0.5 rounded text-xs border border-purple-200 font-bold flex items-center w-fit">
            <i class="fas fa-chalkboard-teacher mr-1"></i> Wali Kelas
          </span>`;
        
        detailInfo = `
          <div class="flex flex-col space-y-1">
            <span class="text-xs text-slate-500 flex items-center">
              <i class="fas fa-school mr-1.5 w-4"></i> ${user.schoolId}
            </span>
            <span class="text-xs font-bold text-slate-700 flex items-center bg-slate-100 px-1.5 py-0.5 rounded w-fit">
              <i class="fas fa-users mr-1.5 w-4 text-purple-500"></i> Kelas: ${user.classId || '-'}
            </span>
          </div>`;
      } else {
        // Tampilan untuk ADMIN (Biru)
        roleBadge = `
          <span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs border border-blue-200 font-bold flex items-center w-fit">
            <i class="fas fa-user-shield mr-1"></i> Admin Sekolah
          </span>`;
        
        detailInfo = `
          <span class="text-xs text-slate-500 flex items-center">
            <i class="fas fa-school mr-1.5 w-4"></i> ${user.schoolId}
          </span>`;
      }

      // Pastikan classId tidak undefined saat dikirim ke fungsi edit
      const safeClassId = user.classId ? user.classId : '';

      return `
        <tr class="hover:bg-slate-50 transition duration-150">
          <td class="py-3 px-4 text-slate-600 font-mono text-xs">${user.nis}</td>
          
          <td class="py-3 px-4">
            <div class="font-medium text-slate-800">${user.name}</div>
          </td>
          
          <td class="py-3 px-4">
            ${roleBadge}
          </td>
          
          <td class="py-3 px-4">
             ${detailInfo}
          </td>
          
          <td class="py-3 px-4 text-center">
            <span class="text-xs ${user.status === 'active' ? 'bg-emerald-100 text-emerald-600 border border-emerald-200' : 'bg-red-100 text-red-600 border border-red-200'} px-2 py-1 rounded-full font-medium">
              ${user.status}
            </span>
          </td>
          
          <td class="py-3 px-4 text-center">
            <div class="flex items-center justify-center space-x-2">
              <button onclick="openAdminModal('edit', '${user.userId}', '${user.nis}', '${user.name}', '${user.schoolId}', '${user.status}', '${user.role}', '${safeClassId}')" 
                class="w-8 h-8 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-100 hover:text-blue-700 transition flex items-center justify-center" title="Edit Data">
                <i class="fas fa-edit"></i>
              </button>
              
              <button onclick="deleteUser('${user.userId}')" 
                class="w-8 h-8 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 hover:text-red-700 transition flex items-center justify-center" title="Hapus User">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `;
    }).join('');
  }

  // 4. RENDER PAGINATION CONTROLS
  if (totalItems > 0) {
    paginationDiv.innerHTML = `
      <div>
        Menampilkan <span class="font-bold text-slate-800">${startIndex + 1}</span> 
        sampai <span class="font-bold text-slate-800">${endIndex}</span> 
        dari <span class="font-bold text-slate-800">${totalItems}</span> data
      </div>
      
      <div class="flex items-center space-x-1">
        <button onclick="changeAdminPage(${currentAdminPage - 1})" 
          class="px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition"
          ${currentAdminPage === 1 ? 'disabled' : ''}>
          <i class="fas fa-chevron-left text-xs"></i>
        </button>
        
        ${generatePageNumbersAdmin(currentAdminPage, totalPages)}
        
        <button onclick="changeAdminPage(${currentAdminPage + 1})" 
          class="px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition"
          ${currentAdminPage === totalPages ? 'disabled' : ''}>
          <i class="fas fa-chevron-right text-xs"></i>
        </button>
      </div>
    `;
  } else {
    paginationDiv.innerHTML = '';
  }
}

// === MODAL LOGIC ===

// Helper: Load Kelas berdasarkan Sekolah yang dipilih di Modal
async function loadClassesForAdminModal(schoolId, selectedClassId = '') {
    const classSelect = document.getElementById('admin_classSelect');
    
    if(!schoolId) {
        classSelect.innerHTML = '<option value="-">-- Pilih Sekolah Dulu --</option>';
        return;
    }
    
    classSelect.innerHTML = '<option value="-">Memuat...</option>';
    
    try {
        const res = await callServerFunction('getClasses', authToken, schoolId);
        classSelect.innerHTML = '<option value="-">-- Pilih Kelas --</option>';
        
        if(res.success && res.data.length > 0) {
            res.data.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.classId;
                opt.textContent = c.name;
                if(c.classId === selectedClassId) opt.selected = true;
                classSelect.appendChild(opt);
            });
        } else {
            classSelect.innerHTML = '<option value="-">Tidak ada kelas</option>';
        }
    } catch(e) {
        classSelect.innerHTML = '<option value="-">Gagal memuat</option>';
    }
}

// Helper: Toggle tampilan dropdown Kelas berdasarkan Role
function toggleAdminClassInput(role) {
    const container = document.getElementById('admin_classContainer');
    if(role === 'walikelas') {
        container.classList.remove('hidden');
        // Trigger load kelas jika sekolah sudah dipilih
        const schoolId = document.getElementById('admin_schoolSelect').value;
        if(schoolId) loadClassesForAdminModal(schoolId);
    } else {
        container.classList.add('hidden');
    }
}

    // Fungsi untuk generate nomor halaman (mirip dengan siswa/sekolah)
    function generatePageNumbersAdmin(current, total) {
       let buttons = '';
       const maxButtons = 5; 
       let startPage = Math.max(1, current - 2);
       let endPage = Math.min(total, startPage + maxButtons - 1);
       
       if (endPage - startPage < maxButtons - 1) {
          startPage = Math.max(1, endPage - maxButtons + 1);
       }

       for (let i = startPage; i <= endPage; i++) {
          const activeClass = i === current 
             ? 'bg-emerald-500 text-white border-emerald-500 shadow-sm' 
             : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50';
          
          buttons += `
             <button onclick="changeAdminPage(${i})" 
               class="px-3 py-1.5 text-xs font-medium rounded-lg border transition ${activeClass}">
               ${i}
             </button>
          `;
       }
       return buttons;
    }


// ============================================
    // LOGIKA PAGINATION & SEARCH RANKING GLOBAL
    // ============================================

    function handleGlobalRowsChange(value) {
      globalRowsPerPage = value === 'all' ? globalRankingList.length : parseInt(value);
      currentGlobalPage = 1; // Reset ke halaman 1
      renderGlobalRankingTable();
    }

    function handleGlobalSearch(query) {
      globalSearchQuery = query.toLowerCase();
      currentGlobalPage = 1; // Reset ke halaman 1 saat mencari
      renderGlobalRankingTable();
    }

    function changeGlobalPage(newPage) {
      currentGlobalPage = newPage;
      renderGlobalRankingTable();
    }

    function renderGlobalRankingTable() {
      const tbody = document.getElementById('globalRankingTableBody');
      const paginationDiv = document.getElementById('globalPagination');
      
      // 1. FILTER DATA
      // Filter berdasarkan Nama, NIS, Sekolah, atau Kelas
      const filteredData = globalRankingList.filter(student => 
        student.name.toLowerCase().includes(globalSearchQuery) || 
        student.nis.toString().toLowerCase().includes(globalSearchQuery) ||
        (student.schoolName && student.schoolName.toLowerCase().includes(globalSearchQuery)) ||
        (student.className && student.className.toLowerCase().includes(globalSearchQuery))
      );

      // 2. HITUNG PAGINATION
      const totalItems = filteredData.length;
      const totalPages = Math.ceil(totalItems / globalRowsPerPage);
      
      // Validasi page
      if (currentGlobalPage < 1) currentGlobalPage = 1;
      if (currentGlobalPage > totalPages && totalPages > 0) currentGlobalPage = totalPages;

      const startIndex = (currentGlobalPage - 1) * globalRowsPerPage;
      const endIndex = Math.min(startIndex + globalRowsPerPage, totalItems);
      
      const pageData = filteredData.slice(startIndex, endIndex);

      // 3. RENDER TABEL
      if (totalItems === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="py-8 text-center text-slate-400 italic">
              <i class="fas fa-search mb-2 text-xl"></i><br>
              Data siswa tidak ditemukan
            </td>
          </tr>`;
      } else {
        tbody.innerHTML = pageData.map(student => `
          <tr class="hover:bg-slate-50 transition duration-150">
            <td class="py-3 px-4">
               ${
                 student.originalRank === 1 ? '<i class="fas fa-medal text-2xl text-yellow-500"></i>' :
                 student.originalRank === 2 ? '<i class="fas fa-medal text-2xl text-slate-400"></i>' :
                 student.originalRank === 3 ? '<i class="fas fa-medal text-2xl text-orange-600"></i>' :
                 `<span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-slate-100 text-slate-600 font-bold">${student.originalRank}</span>`
               }
            </td>
            <td class="py-3 px-4 text-slate-600 font-mono">${student.nis}</td>
            <td class="py-3 px-4 font-medium text-slate-800">${student.name}</td>
            <td class="py-3 px-4 text-slate-600">${student.schoolName}</td>
            <td class="py-3 px-4 text-slate-600">${student.className || '-'}</td>
            <td class="py-3 px-4 text-right">
              <span class="inline-flex items-center px-3 py-1 rounded-full bg-emerald-100 text-emerald-600 font-semibold shadow-sm">
                ${student.totalPoin}
              </span>
            </td>
          </tr>
        `).join('');
      }

      // 4. RENDER PAGINATION CONTROLS
      if (totalItems > 0) {
        paginationDiv.innerHTML = `
          <div>
            Menampilkan <span class="font-bold text-slate-800">${startIndex + 1}</span> 
            sampai <span class="font-bold text-slate-800">${endIndex}</span> 
            dari <span class="font-bold text-slate-800">${totalItems}</span> data
          </div>
          
          <div class="flex items-center space-x-1">
            <button onclick="changeGlobalPage(${currentGlobalPage - 1})" 
              class="px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition"
              ${currentGlobalPage === 1 ? 'disabled' : ''}>
              <i class="fas fa-chevron-left text-xs"></i>
            </button>
            
            ${generatePageNumbersGlobal(currentGlobalPage, totalPages)}
            
            <button onclick="changeGlobalPage(${currentGlobalPage + 1})" 
              class="px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition"
              ${currentGlobalPage === totalPages ? 'disabled' : ''}>
              <i class="fas fa-chevron-right text-xs"></i>
            </button>
          </div>
        `;
      } else {
        paginationDiv.innerHTML = '';
      }
    }

    // Fungsi untuk generate nomor halaman
    function generatePageNumbersGlobal(current, total) {
       let buttons = '';
       const maxButtons = 5; 
       let startPage = Math.max(1, current - 2);
       let endPage = Math.min(total, startPage + maxButtons - 1);
       
       if (endPage - startPage < maxButtons - 1) {
          startPage = Math.max(1, endPage - maxButtons + 1);
       }

       for (let i = startPage; i <= endPage; i++) {
          const activeClass = i === current 
             ? 'bg-emerald-500 text-white border-emerald-500 shadow-sm' 
             : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50';
          
          buttons += `
             <button onclick="changeGlobalPage(${i})" 
               class="px-3 py-1.5 text-xs font-medium rounded-lg border transition ${activeClass}">
               ${i}
             </button>
          `;
       }
       return buttons;
    }


// ============================================
    // LOGIKA PAGINATION & SEARCH LOG AKTIVITAS
    // ============================================

    function handleLogRowsChange(value) {
      logRowsPerPage = value === 'all' ? globalLogList.length : parseInt(value);
      currentLogPage = 1; 
      renderLogTable();
    }

    function handleLogSearch(query) {
      logSearchQuery = query.toLowerCase();
      currentLogPage = 1; 
      renderLogTable();
    }

    function changeLogPage(newPage) {
      currentLogPage = newPage;
      renderLogTable();
    }

    function renderLogTable() {
      const tbody = document.getElementById('logTableBody');
      const paginationDiv = document.getElementById('logPagination');
      
      // 1. FILTER DATA
      // Filter berdasarkan UserID, Aktivitas, atau Detail
      const filteredData = globalLogList.filter(log => 
        (log.userId && log.userId.toLowerCase().includes(logSearchQuery)) || 
        (log.aktivitas && log.aktivitas.toLowerCase().includes(logSearchQuery)) ||
        (log.details && log.details.toLowerCase().includes(logSearchQuery))
      );

      // 2. HITUNG PAGINATION
      const totalItems = filteredData.length;
      const totalPages = Math.ceil(totalItems / logRowsPerPage);
      
      // Validasi page
      if (currentLogPage < 1) currentLogPage = 1;
      if (currentLogPage > totalPages && totalPages > 0) currentLogPage = totalPages;

      const startIndex = (currentLogPage - 1) * logRowsPerPage;
      const endIndex = Math.min(startIndex + logRowsPerPage, totalItems);
      
      const pageData = filteredData.slice(startIndex, endIndex);

      // 3. RENDER TABEL
      if (totalItems === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="py-8 text-center text-slate-400 italic">
              <i class="fas fa-search mb-2 text-xl"></i><br>
              Log tidak ditemukan
            </td>
          </tr>`;
      } else {
        tbody.innerHTML = pageData.map(log => `
          <tr class="hover:bg-slate-50 transition duration-150">
            <td class="py-3 px-4 text-slate-500 whitespace-nowrap text-xs font-mono">
               ${new Date(log.timestamp).toLocaleString('id-ID')}
            </td>
            <td class="py-3 px-4">
               <div class="flex flex-col">
                 <span class="font-bold text-slate-700 text-xs">${log.userId}</span>
                 <span class="text-[10px] text-slate-400 uppercase">${log.role}</span>
               </div>
            </td>
            <td class="py-3 px-4">
               <span class="inline-block bg-slate-100 text-slate-700 px-2 py-1 rounded text-xs font-medium border border-slate-200">
                 ${log.aktivitas}
               </span>
            </td>
            <td class="py-3 px-4 text-slate-600 text-xs">
              ${log.details}
            </td>
          </tr>
        `).join('');
      }

      // 4. RENDER PAGINATION CONTROLS
      if (totalItems > 0) {
        paginationDiv.innerHTML = `
          <div>
            Menampilkan <span class="font-bold text-slate-800">${startIndex + 1}</span> 
            sampai <span class="font-bold text-slate-800">${endIndex}</span> 
            dari <span class="font-bold text-slate-800">${totalItems}</span> data
          </div>
          
          <div class="flex items-center space-x-1">
            <button onclick="changeLogPage(${currentLogPage - 1})" 
              class="px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition"
              ${currentLogPage === 1 ? 'disabled' : ''}>
              <i class="fas fa-chevron-left text-xs"></i>
            </button>
            
            ${generatePageNumbersLog(currentLogPage, totalPages)}
            
            <button onclick="changeLogPage(${currentLogPage + 1})" 
              class="px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition"
              ${currentLogPage === totalPages ? 'disabled' : ''}>
              <i class="fas fa-chevron-right text-xs"></i>
            </button>
          </div>
        `;
      } else {
        paginationDiv.innerHTML = '';
      }
    }

    function generatePageNumbersLog(current, total) {
       let buttons = '';
       const maxButtons = 5; 
       let startPage = Math.max(1, current - 2);
       let endPage = Math.min(total, startPage + maxButtons - 1);
       
       if (endPage - startPage < maxButtons - 1) {
          startPage = Math.max(1, endPage - maxButtons + 1);
       }

       for (let i = startPage; i <= endPage; i++) {
          const activeClass = i === current 
             ? 'bg-emerald-500 text-white border-emerald-500 shadow-sm' 
             : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50';
          
          buttons += `
             <button onclick="changeLogPage(${i})" 
               class="px-3 py-1.5 text-xs font-medium rounded-lg border transition ${activeClass}">
               ${i}
             </button>
          `;
       }
       return buttons;
    }


// ============================================
// LOGIKA PAGINATION & RENDER HISTORY
// ============================================

function handleHistoryRowsChange(value) {
  historyRowsPerPage = value === 'all' ? globalHistoryList.length : parseInt(value);
  currentHistoryPage = 1; // Reset ke halaman 1
  renderHistoryList();
}

function handleHistorySearch(query) {
  historySearchQuery = query.toLowerCase();
  currentHistoryPage = 1; // Reset ke halaman 1
  renderHistoryList();
}

function changeHistoryPage(newPage) {
  currentHistoryPage = newPage;
  renderHistoryList();
}

function renderHistoryList() {
  const container = document.getElementById('historyListContainer');
  const paginationDiv = document.getElementById('historyPagination');
  const countLabel = document.getElementById('historyTotalCount');
  
  // 1. FILTER DATA
  // Filter berdasarkan: Tanggal (String), Catatan, Judul Kultum, Penceramah
  const filteredData = globalHistoryList.filter(item => {
    const searchLower = historySearchQuery.toLowerCase();
    
    // Format tanggal ke string agar bisa dicari (misal: "Senin")
    const dateObj = new Date(item.tanggal);
    const dateStr = dateObj.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }).toLowerCase();
    
    return (
       dateStr.includes(searchLower) ||
       (item.catatan && item.catatan.toLowerCase().includes(searchLower)) ||
       (item.judul && item.judul.toLowerCase().includes(searchLower)) ||
       (item.penceramah && item.penceramah.toLowerCase().includes(searchLower))
    );
  });

  // Update total count label
  if(countLabel) countLabel.textContent = filteredData.length;

  // 2. HITUNG PAGINATION
  const totalItems = filteredData.length;
  const totalPages = Math.ceil(totalItems / historyRowsPerPage);
  
  if (currentHistoryPage < 1) currentHistoryPage = 1;
  if (currentHistoryPage > totalPages && totalPages > 0) currentHistoryPage = totalPages;

  const startIndex = (currentHistoryPage - 1) * historyRowsPerPage;
  const endIndex = Math.min(startIndex + historyRowsPerPage, totalItems);
  
  const pageData = filteredData.slice(startIndex, endIndex);

  // 3. RENDER ITEMS
  if (totalItems === 0) {
    container.innerHTML = `
      <div class="flex flex-col items-center justify-center py-12 text-center border-2 border-dashed border-slate-200 rounded-xl">
          <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-3">
              <i class="fas fa-search text-slate-300 text-2xl"></i>
          </div>
          <p class="text-slate-500 italic">Tidak ada data riwayat yang cocok.</p>
      </div>
    `;
    paginationDiv.innerHTML = '';
  } else {
    container.innerHTML = pageData.map(item => {
        // Format Tanggal
        const dateObj = new Date(item.tanggal);
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const tanggalFormatted = dateObj.toLocaleDateString('id-ID', options);
        
        // Generate Badges
        const ibadahBadges = globalMasterData.map(master => {
            if (item.checklist && item.checklist[master.key] === true) {
                return `
                  <span class="inline-flex items-center bg-${master.color}-50 text-${master.color}-600 border border-${master.color}-100 px-2 py-1 rounded-lg text-[10px] md:text-xs font-medium">
                    <i class="fas ${master.icon} mr-1.5"></i>${master.name}
                  </span>
                `;
            }
            return '';
        }).join('');

        return `
        <div class="border border-slate-200 rounded-xl p-5 hover:bg-slate-50 hover:shadow-md transition duration-200 group bg-white">
          <div class="flex flex-col md:flex-row md:items-center justify-between mb-3 gap-2">
            <span class="font-bold text-slate-800 text-sm md:text-base flex items-center">
               <i class="far fa-calendar-alt text-emerald-500 mr-2"></i> ${tanggalFormatted}
            </span>
            <span class="inline-flex items-center px-3 py-1 rounded-full bg-emerald-100 text-emerald-700 font-bold text-xs shadow-sm self-start md:self-auto">
              +${item.totalPoin} Poin
            </span>
          </div>
          
          <div class="flex flex-wrap gap-2 mb-3">
            ${ibadahBadges || '<span class="text-slate-400 text-xs italic">Tidak ada checklist ibadah</span>'}
          </div>
          
          ${item.hasKultum ? `
            <div class="mt-3 pt-3 border-t border-dashed border-slate-200 flex items-start space-x-3 bg-indigo-50/50 p-2.5 rounded-lg">
               <div class="mt-0.5 w-6 h-6 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0">
                  <i class="fas fa-microphone-alt text-indigo-500 text-xs"></i>
               </div>
               <div>
                 <p class="text-xs font-bold text-slate-700 line-clamp-1">${item.judul || 'Tanpa Judul'}</p>
                 <p class="text-[10px] text-slate-500">Oleh: ${item.penceramah || '-'}</p>
               </div>
            </div>
          ` : ''}
          
          ${item.catatan ? `
            <div class="mt-3 pt-2 border-t border-slate-100">
              <p class="text-xs text-slate-500 italic flex items-start">
                <i class="fas fa-sticky-note mr-2 mt-0.5 text-slate-300"></i> "${item.catatan}"
              </p>
            </div>
          ` : ''}
        </div>
      `;
    }).join('');

    // 4. RENDER PAGINATION BUTTONS
    paginationDiv.innerHTML = `
      <div>
        Menampilkan <span class="font-bold text-slate-800">${startIndex + 1}</span> 
        sampai <span class="font-bold text-slate-800">${endIndex}</span> 
        dari <span class="font-bold text-slate-800">${totalItems}</span> data
      </div>
      
      <div class="flex items-center space-x-1">
        <button onclick="changeHistoryPage(${currentHistoryPage - 1})" 
          class="px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition"
          ${currentHistoryPage === 1 ? 'disabled' : ''}>
          <i class="fas fa-chevron-left text-xs"></i>
        </button>
        
        ${generatePageNumbersHistory(currentHistoryPage, totalPages)}
        
        <button onclick="changeHistoryPage(${currentHistoryPage + 1})" 
          class="px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition"
          ${currentHistoryPage === totalPages ? 'disabled' : ''}>
          <i class="fas fa-chevron-right text-xs"></i>
        </button>
      </div>
    `;
  }
}

function generatePageNumbersHistory(current, total) {
   let buttons = '';
   const maxButtons = 5; 
   let startPage = Math.max(1, current - 2);
   let endPage = Math.min(total, startPage + maxButtons - 1);
   
   if (endPage - startPage < maxButtons - 1) {
      startPage = Math.max(1, endPage - maxButtons + 1);
   }

   for (let i = startPage; i <= endPage; i++) {
      const activeClass = i === current 
         ? 'bg-emerald-500 text-white border-emerald-500 shadow-sm' 
         : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50';
      
      buttons += `
         <button onclick="changeHistoryPage(${i})" 
           class="px-3 py-1.5 text-xs font-medium rounded-lg border transition ${activeClass}">
           ${i}
         </button>
      `;
   }
   return buttons;
}
// ============================================
    // LOGIKA MODAL SISWA (BARU)
    // ============================================
async function openStudentModal(mode, userId='', nis='', name='', classId='', status='active') {
  const modal = document.getElementById('studentModal');
  const title = document.getElementById('studentModalTitle');
  const selectClass = document.getElementById('student_classSelect');
  
  // 1. Reset Form & State
  document.getElementById('studentForm').reset();
  document.getElementById('student_mode').value = mode;
  document.getElementById('student_userId').value = userId;
  
  // 2. Load Data Kelas (Optimized with Cache)
  selectClass.innerHTML = '<option value="">-- Memuat Kelas... --</option>';
  
  try {
     let classesData = [];

     // [OPTIMASI] Cek Cache Dulu!
     if (appCache.classes && appCache.classes.length > 0) {
         classesData = appCache.classes;
     } else {
         // Jika cache kosong, baru panggil server (Fallback)
         const res = await callServerFunction('getClasses', authToken, currentUser.schoolId);
         if (res.success) {
             classesData = res.data;
             appCache.classes = res.data; // Simpan ke cache untuk berikutnya
         }
     }
     
     selectClass.innerHTML = '<option value="">-- Pilih Kelas --</option>';
     
     if (classesData.length > 0) {
        classesData.forEach(cls => {
           // LOGIKA KHUSUS WALI KELAS
           if (currentUser.role === 'walikelas' && cls.classId !== currentUser.classId) {
               return; 
           }

           const opt = document.createElement('option');
           opt.value = cls.classId;
           opt.textContent = cls.name;
           selectClass.appendChild(opt);
        });

        // Auto-select jika Wali Kelas
        if (currentUser.role === 'walikelas') {
            selectClass.value = currentUser.classId;
        }

     } else {
        selectClass.innerHTML = '<option value="">Belum ada kelas</option>';
     }
  } catch (e) {
     selectClass.innerHTML = '<option value="">Gagal memuat kelas</option>';
  } finally {
     if (currentUser.role === 'walikelas') {
        selectClass.disabled = true;
     } else {
        selectClass.disabled = false;
     }
  }

  // 3. Konfigurasi UI berdasarkan Mode
  if (mode === 'add') {
     title.innerHTML = '<i class="fas fa-plus-circle mr-2"></i>Tambah Siswa Baru';
     
     document.getElementById('student_nis').value = '';
     document.getElementById('student_nis').readOnly = false;
     document.getElementById('student_nis').classList.remove('bg-slate-100');
     
     document.getElementById('student_name').value = '';
     
     if (currentUser.role !== 'walikelas') {
        document.getElementById('student_classSelect').value = ''; 
     }
     
     document.getElementById('student_password').required = true;
     document.getElementById('student_password_hint').classList.add('hidden');
     
     document.getElementById('student_statusContainer').classList.add('hidden');
     
  } else {
     title.innerHTML = '<i class="fas fa-edit mr-2"></i>Edit Data Siswa';
     
     document.getElementById('student_nis').value = nis;
     document.getElementById('student_nis').readOnly = true; 
     document.getElementById('student_nis').classList.add('bg-slate-100');
     
     document.getElementById('student_name').value = name;
     
     // Set nilai kelas sesuai data siswa yang diedit
     // Karena data kelas sudah ada (dari cache), value ini akan langsung terpilih
     document.getElementById('student_classSelect').value = classId;
     
     document.getElementById('student_password').required = false;
     document.getElementById('student_password_hint').classList.remove('hidden');
     
     document.getElementById('student_status').value = status;
     document.getElementById('student_statusContainer').classList.remove('hidden');
  }

  // Tampilkan Modal
  modal.classList.remove('hidden');
}
    function closeStudentModal() {
      document.getElementById('studentModal').classList.add('hidden');
      // Hapus styling readonly saat tutup agar reset bersih
      document.getElementById('student_nis').classList.remove('bg-slate-100'); 
    }

    // HANDLE SUBMIT FORM SISWA
// HANDLE SUBMIT FORM SISWA
document.getElementById('studentForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const mode = document.getElementById('student_mode').value;
  const userId = document.getElementById('student_userId').value;

  const nis = document.getElementById('student_nis').value;
  const name = document.getElementById('student_name').value;
  const classId = document.getElementById('student_classSelect').value;
  const password = document.getElementById('student_password').value;
  const status = document.getElementById('student_status').value;

  if (!classId) {
    showToast('Silakan pilih kelas terlebih dahulu', 'error');
    return;
  }

  closeStudentModal();
  showLoading();

  try {
    let result;

    if (mode === 'add') {
      // Params Backend: addUser(token, nis, name, password, role='siswa', schoolId, classId)
      result = await callServerFunction('addUser', authToken, nis, name, password, 'siswa', currentUser.schoolId, classId);
    } else {
      // Params Backend: updateUser(token, userId, name, password, classId, status)
      result = await callServerFunction('updateUser', authToken, userId, name, password, classId, status);
    }

    if (result.success) {
      showToast(mode === 'add' ? 'Siswa berhasil ditambahkan' : 'Data siswa diperbarui');

      // [PERBAIKAN] Reset cache agar data terbaru diambil dari server saat refresh tabel
      if (typeof appCache !== 'undefined') {
        appCache.students = null;
      }

      loadStudentManagement(); // Refresh Tabel
    } else {
      showToast(result.error, 'error');
    }
  } catch (error) {
    showToast('Gagal memproses: ' + error, 'error');
  } finally {
    hideLoading();
  }
});
// ============================================
// HAPUS SISWA (DENGAN SWEET ALERT)
// ============================================

function deleteStudent(userId) {
  Swal.fire({
    title: 'Yakin ingin menghapus siswa ini?',
    text: "Data akun dan seluruh riwayat ibadah siswa ini akan dihapus permanen dan tidak bisa dikembalikan.",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#ef4444', // Merah (Red-500)
    cancelButtonColor: '#64748b',  // Abu-abu (Slate-500)
    confirmButtonText: '<i class="fas fa-trash-alt mr-2"></i>Ya, Hapus',
    cancelButtonText: 'Batal',
    background: '#fff',
    customClass: {
      popup: 'rounded-2xl',
      title: 'text-slate-800 font-bold',
      confirmButton: 'rounded-xl px-4 py-2 font-bold shadow-lg shadow-red-500/30',
      cancelButton: 'rounded-xl px-4 py-2 font-medium hover:bg-slate-100'
    }
  }).then((result) => {
    if (result.isConfirmed) {
      processDeleteStudent(userId);
    }
  });
}

async function processDeleteStudent(userId) {
  showLoading();
  try {
    // Panggil fungsi backend 'deleteUser'
    const res = await callServerFunction('deleteUser', authToken, userId);
    
    hideLoading();

    if(res.success) {
       await Swal.fire({
         title: 'Terhapus!',
         text: 'Data siswa berhasil dihapus.',
         icon: 'success',
         confirmButtonColor: '#10b981', // Emerald
         timer: 1500,
         showConfirmButton: false,
         customClass: { popup: 'rounded-2xl' }
       });
       
       // [PERBAIKAN] Reset cache agar data terbaru diambil dari server
       if (typeof appCache !== 'undefined') {
         appCache.students = null;
       }
       
       // Refresh Tabel Siswa
       loadStudentManagement();
    } else {
       // Jika gagal (misal validasi role/sekolah)
       Swal.fire({
         title: 'Gagal',
         text: res.error,
         icon: 'error',
         confirmButtonColor: '#ef4444',
         customClass: { popup: 'rounded-2xl' }
       });
    }
  } catch(err) { 
     hideLoading();
     showToast(err, 'error'); 
  }
}

async function loadWaliKelasDashboard() {
  showLoading();

  try {
    const result = await callServerFunction('getWaliKelasDashboard', authToken);
  
    if (!result.success) {
        showToast(result.error, 'error');
        return;
    }
  
    const data = result.data;
    const content = document.getElementById('contentArea');
  
    content.innerHTML = `
        <div id="prayerTimesContainer" class="mb-6 animate-fade-in-up">
           <div class="bg-white rounded-2xl p-6 shadow-lg flex items-center justify-center">
              <div class="spinner border-t-emerald-500 border-4 w-8 h-8 rounded-full animate-spin"></div>
              <span class="ml-3 text-slate-500 text-sm">Memuat Jadwal Sholat...</span>
           </div>
        </div>

        <div class="mb-6 bg-emerald-600 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
            <div class="relative z-10">
                <h2 class="text-2xl font-bold">Wali Kelas: ${data.className}</h2>
                <p class="text-emerald-100">Pantau perkembangan ibadah siswa kelas Anda.</p>
            </div>
            <i class="fas fa-chalkboard-teacher absolute -right-4 -bottom-4 text-9xl text-emerald-500/30"></i>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-6 text-white shadow-lg card-hover">
            <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                <i class="fas fa-users text-2xl"></i>
            </div>
            <span class="text-4xl font-bold">${data.totalStudents}</span>
            </div>
            <p class="text-blue-100">Jumlah Siswa</p>
        </div>
        
        <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl p-6 text-white shadow-lg card-hover">
            <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                <i class="fas fa-star text-2xl"></i>
            </div>
            <span class="text-4xl font-bold">${data.totalPoin}</span>
            </div>
            <p class="text-orange-100">Total Poin Kelas</p>
        </div>
        </div>
        
        <div class="bg-white rounded-2xl p-6 shadow-lg">
        <h3 class="text-lg font-bold text-slate-800 mb-4">
            <i class="fas fa-medal text-yellow-500 mr-2"></i>Top 5 Siswa Terbaik
        </h3>
        <div class="overflow-x-auto">
            <table class="w-full">
            <thead>
                <tr class="border-b border-slate-200 text-sm text-slate-500">
                <th class="text-left py-3 px-4">Rank</th>
                <th class="text-left py-3 px-4">Nama</th>
                <th class="text-right py-3 px-4">Poin</th>
                </tr>
            </thead>
            <tbody>
                ${data.top5.length > 0 ? data.top5.map((student, index) => `
                <tr class="border-b border-slate-100 hover:bg-slate-50">
                    <td class="py-3 px-4 font-bold text-slate-600">#${index + 1}</td>
                    <td class="py-3 px-4 font-medium text-slate-800">${student.name}</td>
                    <td class="py-3 px-4 text-right">
                    <span class="inline-flex items-center px-3 py-1 rounded-full bg-emerald-100 text-emerald-600 font-bold text-xs">
                        ${student.totalPoin}
                    </span>
                    </td>
                </tr>
                `).join('') : '<tr><td colspan="3" class="text-center py-4 italic text-slate-400">Belum ada data</td></tr>'}
            </tbody>
            </table>
        </div>
        </div>
    `;

    // [PENTING] Panggil Widget Sholat Global
    if (typeof initPrayerWidget === 'function') {
        initPrayerWidget();
    }

  } catch (error) {
    showToast('Terjadi kesalahan: ' + error, 'error');
  } finally {
    hideLoading();
  }
}
    // ============================================
    // SCHOOL MANAGEMENT (Super Admin)
    // ============================================
async function loadSchoolManagement() {
      showLoading();
      
      try {
        let schools;
        
        // [BARU] LOGIKA CEK CACHE
        // Cek apakah data sekolah sudah tersedia di cache global
        if (appCache.schools) {
            schools = appCache.schools;
        } else {
            // Jika tidak ada di cache, ambil dari server (Fallback)
            const result = await callServerFunction('getSchools', authToken);
            
            if (!result.success) {
                showToast(result.error, 'error');
                return;
            }
            schools = result.data;
        }
        
        // Render HTML
        const content = document.getElementById('contentArea');
        content.innerHTML = `
          <div class="bg-white rounded-2xl p-6 shadow-lg">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-lg font-bold text-slate-800">
                <i class="fas fa-school text-emerald-500 mr-2"></i>Daftar Sekolah
              </h3>
              <button onclick="openSchoolModal('add')" class="btn-primary text-white px-6 py-2 rounded-xl shadow-md hover:shadow-lg transition transform hover:-translate-y-1">
                <i class="fas fa-plus mr-2"></i>Tambah Sekolah
              </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              ${schools.map(school => `
                <div class="border border-slate-200 rounded-xl p-6 hover:shadow-lg transition bg-slate-50/50 group">
                  <div class="flex items-center justify-between mb-3">
                    <h4 class="font-bold text-slate-800 text-lg group-hover:text-emerald-600 transition">${school.name}</h4>
                    <span class="text-xs ${school.status === 'active' ? 'bg-emerald-100 text-emerald-600 border border-emerald-200' : 'bg-red-100 text-red-600 border border-red-200'} px-3 py-1 rounded-full font-bold uppercase tracking-wider">
                      ${school.status}
                    </span>
                  </div>
                  <p class="text-sm text-slate-600 mb-2 h-10 line-clamp-2"><i class="fas fa-map-marker-alt mr-2 text-slate-400"></i>${school.address}</p>
                  <p class="text-xs text-slate-400 mb-4 font-mono">${school.schoolId}</p>
                  
                  <div class="flex space-x-2 pt-2 border-t border-slate-200">
                    <button onclick="openSchoolModal('edit', '${school.schoolId}', '${school.name}', '${school.address}', '${school.status}')" 
                      class="flex-1 bg-white border border-blue-200 text-blue-600 px-3 py-2 rounded-lg hover:bg-blue-50 transition font-medium text-sm">
                      <i class="fas fa-edit mr-1"></i>Edit
                    </button>
                    <button onclick="deleteSchool('${school.schoolId}')" 
                      class="flex-1 bg-white border border-red-200 text-red-600 px-3 py-2 rounded-lg hover:bg-red-50 transition font-medium text-sm">
                      <i class="fas fa-trash mr-1"></i>Hapus
                    </button>
                  </div>
                </div>
              `).join('')}
            </div>
            
            ${schools.length === 0 ? '<p class="text-center text-slate-500 py-10 italic">Belum ada data sekolah.</p>' : ''}
          </div>
        `;
      } catch (error) {
        showToast('Terjadi kesalahan: ' + error, 'error');
      } finally {
        hideLoading();
      }
    }

    // ============================================
    // MODAL LOGIC FOR SCHOOL
    // ============================================

    function openSchoolModal(mode, id = '', name = '', address = '', status = 'active') {
      const modal = document.getElementById('schoolModal');
      const title = document.getElementById('schoolModalTitle');
      const statusContainer = document.getElementById('modal_statusContainer');
      
      // Set Mode
      document.getElementById('modal_mode').value = mode;
      document.getElementById('modal_schoolId').value = id;

      if (mode === 'add') {
        // Mode Tambah: Reset Form, Sembunyikan Status
        title.innerHTML = '<i class="fas fa-plus-circle mr-2"></i>Tambah Sekolah Baru';
        document.getElementById('modal_schoolName').value = '';
        document.getElementById('modal_schoolAddress').value = '';
        document.getElementById('modal_schoolStatus').value = 'active';
        statusContainer.classList.add('hidden'); // Sembunyikan status saat tambah baru (default active)
        
      } else {
        // Mode Edit: Isi Form, Tampilkan Status
        title.innerHTML = '<i class="fas fa-edit mr-2"></i>Edit Data Sekolah';
        document.getElementById('modal_schoolName').value = name;
        document.getElementById('modal_schoolAddress').value = address;
        document.getElementById('modal_schoolStatus').value = status;
        statusContainer.classList.remove('hidden'); // Munculkan dropdown status
      }

      // Tampilkan Modal
      modal.classList.remove('hidden');
    }

    function closeSchoolModal() {
      document.getElementById('schoolModal').classList.add('hidden');
    }

    // Handle Form Submit (Satu fungsi handle Add & Edit)
    document.getElementById('schoolForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const mode = document.getElementById('modal_mode').value;
      const id = document.getElementById('modal_schoolId').value;
      const name = document.getElementById('modal_schoolName').value;
      const address = document.getElementById('modal_schoolAddress').value;
      const status = document.getElementById('modal_schoolStatus').value;

      closeSchoolModal(); // Tutup modal dulu agar UI responsif
      showLoading();

      try {
        let result;
        
        if (mode === 'add') {
          // Panggil fungsi Add
          result = await callServerFunction('addSchool', authToken, name, address);
        } else {
          // Panggil fungsi Update
          result = await callServerFunction('updateSchool', authToken, id, name, address, status);
        }

        if (result.success) {
          showToast(mode === 'add' ? 'Sekolah berhasil ditambahkan' : 'Data sekolah diperbarui');
          loadSchoolManagement(); // Refresh halaman
        } else {
          showToast(result.error, 'error');
        }
      } catch (error) {
        showToast('Gagal menyimpan: ' + error, 'error');
      } finally {
        hideLoading();
      }
    });

    function showAddSchoolModal() {
      const name = prompt('Nama Sekolah:');
      if (!name) return;
      
      const address = prompt('Alamat:');
      if (!address) return;
      
      addNewSchool(name, address);
    }

    async function addNewSchool(name, address) {
      showLoading();
      
      try {
        const result = await callServerFunction('addSchool', authToken, name, address);
        
        if (result.success) {
          showToast('Sekolah berhasil ditambahkan');
          loadSchoolManagement();
        } else {
          showToast(result.error, 'error');
        }
      } catch (error) {
        showToast('Terjadi kesalahan: ' + error, 'error');
      } finally {
        hideLoading();
      }
    }

    async function editSchool(schoolId, currentName, currentAddress, currentStatus) {
      const name = prompt('Nama Sekolah:', currentName);
      if (!name) return;
      
      const address = prompt('Alamat:', currentAddress);
      if (!address) return;
      
      const status = prompt('Status (active/inactive):', currentStatus);
      if (!status) return;
      
      showLoading();
      
      try {
        const result = await callServerFunction('updateSchool', authToken, schoolId, name, address, status);
        
        if (result.success) {
          showToast('Sekolah berhasil diupdate');
          loadSchoolManagement();
        } else {
          showToast(result.error, 'error');
        }
      } catch (error) {
        showToast('Terjadi kesalahan: ' + error, 'error');
      } finally {
        hideLoading();
      }
    }

// ============================================
    // FUNGSI HAPUS SEKOLAH (SWEET ALERT)
    // ============================================
    function deleteSchool(schoolId) {
      Swal.fire({
        title: 'Yakin ingin menghapus sekolah ini?',
        text: "Semua data terkait akan terhapus! Tindakan ini tidak dapat dibatalkan.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444', // Warna Merah (Red-500)
        cancelButtonColor: '#64748b', // Warna Abu (Slate-500)
        confirmButtonText: '<i class="fas fa-trash mr-1"></i> Ya, Hapus!',
        cancelButtonText: 'Batal',
        background: '#fff',
        customClass: {
          popup: 'rounded-2xl',
          title: 'text-slate-800 font-bold',
          confirmButton: 'rounded-xl px-4 py-2',
          cancelButton: 'rounded-xl px-4 py-2'
        }
      }).then((result) => {
        if (result.isConfirmed) {
          // Panggil Server
          processDeleteSchool(schoolId);
        }
      });
    }

    async function processDeleteSchool(schoolId) {
      showLoading();
      try {
        // Panggil fungsi backend 'deleteSchool'
        const result = await callServerFunction('deleteSchool', authToken, schoolId);
        
        hideLoading();
        
        if (result.success) {
          // Tampilkan Sukses dengan SweetAlert
          Swal.fire({
            title: 'Terhapus!',
            text: 'Data sekolah telah berhasil dihapus.',
            icon: 'success',
            confirmButtonColor: '#10b981', // Emerald
            confirmButtonText: 'Oke',
            timer: 2000,
            timerProgressBar: true
          });
          
          // Refresh Tabel Sekolah
          loadSchoolManagement();
          
        } else {
          showToast(result.error, 'error');
        }
      } catch (error) {
        hideLoading();
        showToast('Gagal menghapus: ' + error, 'error');
      }
    }

    // ============================================
    // ADMIN MANAGEMENT (Super Admin)
    // ============================================
async function loadAdminManagement() {
  showLoading();
  
  try {
    const result = await callServerFunction('getUsers', authToken, null, null);
    
    if (!result.success) {
      showToast(result.error, 'error');
      return;
    }
    
    // 1. Simpan data ke Global State & Filter Role 'admin' DAN 'walikelas'
    // [UPDATE PENTING DISINI]: Menambahkan || u.role === 'walikelas'
    globalAdminList = result.data.filter(u => u.role === 'admin' || u.role === 'walikelas');
    
    // 2. Reset State Halaman
    currentAdminPage = 1;
    adminSearchQuery = '';
    
    const content = document.getElementById('contentArea');
    content.innerHTML = `
      <div class="bg-white rounded-2xl p-6 shadow-lg">
        
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
          <div>
            <h3 class="text-lg font-bold text-slate-800">
              <i class="fas fa-users-cog text-emerald-500 mr-2"></i>Daftar Pengelola (Admin & Wali Kelas)
            </h3>
            <p class="text-sm text-slate-500">Total: ${globalAdminList.length} User</p>
          </div>
          <button onclick="openAdminModal('add')" class="btn-primary text-white px-6 py-2 rounded-xl text-sm shadow-md hover:shadow-lg transition">
            <i class="fas fa-plus mr-2"></i>Tambah Pengelola
          </button>
        </div>
        
        <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
          
          <div class="flex items-center space-x-2 text-sm text-slate-600">
            <span>Tampilkan</span>
            <select id="adminRowsSelect" onchange="handleAdminRowsChange(this.value)" class="border border-slate-300 rounded-lg px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white">
              <option value="10">10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
              <option value="all">Semua</option>
            </select>
            <span>data</span>
          </div>

          <div class="relative w-full md:w-64">
            <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-search text-slate-400"></i>
            </span>
            <input type="text" id="adminSearchInput" oninput="handleAdminSearch(this.value)" 
              class="w-full pl-10 pr-4 py-2 text-sm border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-shadow" 
              placeholder="Cari Username, Nama, Sekolah...">
          </div>
        </div>
        
        <div class="overflow-x-auto rounded-xl border border-slate-200">
          <table class="w-full text-sm">
            <thead>
              <tr class="bg-slate-50 border-b border-slate-200 text-slate-600 uppercase tracking-wider text-xs">
                <th class="text-left py-3 px-4 font-bold">Username</th>
                <th class="text-left py-3 px-4 font-bold">Nama Lengkap</th>
                <th class="text-left py-3 px-4 font-bold">Role</th>
                <th class="text-left py-3 px-4 font-bold">Detail Info</th>
                <th class="text-center py-3 px-4 font-bold">Status</th>
                <th class="text-center py-3 px-4 font-bold">Aksi</th>
              </tr>
            </thead>
            <tbody id="adminTableBody" class="divide-y divide-slate-100">
               </tbody>
          </table>
        </div>

        <div id="adminPagination" class="flex flex-col md:flex-row justify-between items-center mt-4 gap-4 text-sm text-slate-600">
           </div>

      </div>
    `;

    // 3. Render Tabel Pertama Kali
    renderAdminTable();

  } catch (error) {
    showToast('Terjadi kesalahan: ' + error, 'error');
  } finally {
    hideLoading();
  }
}
// ============================================
    // MODAL LOGIC FOR ADMIN
    // ============================================

async function openAdminModal(mode, userId='', username='', name='', schoolId='', status='active', role='admin', classId='') {
  // 1. TAMPILKAN LOADING AGAR TIDAK TERASA BERAT/MACET
  showLoading();

  try {
    const modal = document.getElementById('adminModal');
    const title = document.getElementById('adminModalTitle');
    const roleSelect = document.getElementById('admin_roleSelect');
    const schoolSelect = document.getElementById('admin_schoolSelect');
    
    // Reset Form
    document.getElementById('adminForm').reset();
    document.getElementById('admin_mode').value = mode;
    document.getElementById('admin_userId').value = userId;
    
    // 2. LOAD DATA SEKOLAH (Hanya jika belum ada di memori)
    // Ini mempercepat proses pembukaan modal kedua kalinya
    if (!schoolDataList || schoolDataList.length === 0) {
        try { 
          const res = await callServerFunction('getSchools', authToken); 
          if(res.success) schoolDataList = res.data; 
        } catch(e){
          console.error("Gagal load sekolah:", e);
        }
    }
    
    // Render Opsi Sekolah
    schoolSelect.innerHTML = '<option value="">-- Pilih Sekolah --</option>';
    if(schoolDataList) {
        schoolDataList.forEach(sch => {
            const opt = document.createElement('option');
            opt.value = sch.schoolId;
            opt.textContent = sch.name;
            schoolSelect.appendChild(opt);
        });
    }

    // Set Values Dasar
    document.getElementById('admin_username').value = username;
    document.getElementById('admin_name').value = name;
    schoolSelect.value = schoolId;
    roleSelect.value = role;
    document.getElementById('admin_status').value = status;
    
    // Toggle tampilan input kelas berdasarkan role saat ini
    toggleAdminClassInput(role);
    
    // 3. LOAD DATA KELAS (Khusus Wali Kelas)
    // Bagian ini yang biasanya bikin berat, kita pastikan hanya jalan jika perlu
    if(role === 'walikelas' && schoolId) {
        // Kita await di sini agar saat modal muncul, kelas sudah terpilih dengan benar
        await loadClassesForAdminModal(schoolId, classId);
    } else {
        // Reset dropdown kelas jika bukan wali kelas
        document.getElementById('admin_classSelect').innerHTML = '<option value="-">-- Pilih Kelas --</option>';
    }

    // 4. KONFIGURASI UI BERDASARKAN MODE
    if (mode === 'add') {
      // --- MODE TAMBAH ---
      title.innerHTML = '<i class="fas fa-plus-circle mr-2"></i>Tambah Pengelola Baru';
      document.getElementById('admin_username').readOnly = false;
      document.getElementById('admin_username').classList.remove('bg-slate-100');
      
      // FIX: Pastikan Role bisa dipilih
      roleSelect.disabled = false; 
      
      // Jika user bukan superadmin, kunci sekolah ke sekolah user sendiri
      if(currentUser.role !== 'superadmin') {
          schoolSelect.value = currentUser.schoolId;
          schoolSelect.disabled = true;
          // Trigger load classes otomatis jika admin nambah walikelas
          toggleAdminClassInput(roleSelect.value); 
      } else {
          schoolSelect.disabled = false;
      }
      
      document.getElementById('admin_password').required = true;
      document.getElementById('admin_password_hint').classList.add('hidden');
      document.getElementById('admin_statusContainer').classList.add('hidden');
      
    } else {
      // --- MODE EDIT ---
      title.innerHTML = '<i class="fas fa-edit mr-2"></i>Edit Data Pengelola';
      document.getElementById('admin_username').readOnly = true;
      document.getElementById('admin_username').classList.add('bg-slate-100');
      
      schoolSelect.disabled = true; // Sekolah tidak bisa diubah saat edit
      roleSelect.disabled = true; // Role sebaiknya tidak diubah agar data konsisten

      document.getElementById('admin_password').required = false;
      document.getElementById('admin_password_hint').classList.remove('hidden');
      document.getElementById('admin_statusContainer').classList.remove('hidden');
    }
    
    // 5. TAMPILKAN MODAL
    modal.classList.remove('hidden');

  } catch (error) {
    showToast("Terjadi kesalahan saat membuka form: " + error, 'error');
  } finally {
    // 6. SEMBUNYIKAN LOADING (Selesai)
    hideLoading();
  }
}



    function closeAdminModal() {
      document.getElementById('adminModal').classList.add('hidden');
    }
    
    // Alias untuk tombol Tambah agar kompatibel dengan kode lama/button di UI
    function showAddAdminModal() {
        openAdminModal('add');
    }

    // HANDLE SUBMIT FORM ADMIN
document.getElementById('adminForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  // 1. Ambil Value dari Form
  const mode = document.getElementById('admin_mode').value;
  const userId = document.getElementById('admin_userId').value;
  
  const username = document.getElementById('admin_username').value;
  const name = document.getElementById('admin_name').value;
  const schoolId = document.getElementById('admin_schoolSelect').value;
  const role = document.getElementById('admin_roleSelect').value;   // [BARU] Ambil Role
  let classId = document.getElementById('admin_classSelect').value; // [BARU] Ambil Kelas
  const password = document.getElementById('admin_password').value;
  const status = document.getElementById('admin_status').value;

  // 2. Validasi Khusus Wali Kelas
  // Jika role = walikelas, wajib pilih kelas valid (bukan '-' atau kosong)
  if (role === 'walikelas' && (!classId || classId === '-')) {
      showToast('Harap pilih kelas untuk Wali Kelas!', 'error');
      return;
  }
  
  // Jika role = admin, paksa classId jadi '-' agar database rapi
  if (role === 'admin') {
      classId = '-';
  }

  // 3. Proses UI (Tutup Modal & Loading)
  closeAdminModal();
  showLoading();

  try {
    let result;
    
    if (mode === 'add') {
       // [ADD MODE]
       // Panggil fungsi Backend: addUser(token, nis, name, password, role, schoolId, classId)
       // Kita kirimkan role dinamis (admin/walikelas) dan classId yang sesuai
       result = await callServerFunction('addUser', authToken, username, name, password, role, schoolId, classId);
    } else {
       // [EDIT MODE]
       // Panggil fungsi Backend: updateUser(token, userId, name, password, classId, status)
       // Kita kirimkan classId baru (untuk kasus wali kelas pindah kelas)
       result = await callServerFunction('updateUser', authToken, userId, name, password, classId, status);
    }

    // 4. Handle Response
    if (result.success) {
      showToast(mode === 'add' ? 'Pengelola berhasil ditambahkan' : 'Data berhasil diperbarui');
      loadAdminManagement(); // Refresh tabel admin
    } else {
      showToast(result.error, 'error');
    }
  } catch (error) {
    showToast('Gagal memproses: ' + error, 'error');
  } finally {
    hideLoading();
  }
});

// ============================================
    // REPORTS & LOGS (BULK ZIP VERSION)
    // ============================================
    async function loadReports() {
      showLoading();
      const content = document.getElementById('contentArea');
      
      try {
        // SCENARIO 1: TAMPILAN UNTUK SISWA (TETAP SAMA)
        if (currentUser.role === 'siswa') {
           content.innerHTML = `
            <div class="max-w-2xl mx-auto">
              <div class="bg-white rounded-2xl p-8 shadow-lg text-center border-t-4 border-emerald-500">
                <div class="w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-6">
                   <i class="fas fa-file-pdf text-4xl text-emerald-600"></i>
                </div>
                <h3 class="text-2xl font-bold text-slate-800 mb-2">Laporan Aktivitas Ramadhan</h3>
                <p class="text-slate-600 mb-8">Unduh rekapitulasi lengkap kegiatan ibadah dan kultum Anda dalam format PDF.</p>
                
                <button onclick="downloadStudentPdf('${currentUser.userId}')" class="btn-primary text-white px-8 py-4 rounded-xl font-bold shadow-xl hover:shadow-2xl transition transform hover:-translate-y-1 flex items-center justify-center mx-auto space-x-3">
                  <i class="fas fa-download text-xl"></i>
                  <span>Download Laporan Saya</span>
                </button>
                
                <p class="text-xs text-slate-400 mt-6">File PDF akan otomatis terunduh ke perangkat Anda.</p>
              </div>
            </div>
           `;
           hideLoading();
           return;
        }

        // SCENARIO 2: TAMPILAN UNTUK ADMIN (BULK DOWNLOAD)
        
        let students = [];
        // Fetch users (reuse existing API logic)
        const result = await callServerFunction('getUsers', authToken, currentUser.schoolId, null);
        if (result.success) {
           students = result.data.filter(u => u.role === 'siswa');
        }

        // Render Tabel Laporan dengan Checkbox
        content.innerHTML = `
          <div class="bg-white rounded-2xl p-6 shadow-lg relative">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
              <div>
                <h3 class="text-lg font-bold text-slate-800">
                  <i class="fas fa-file-archive text-emerald-500 mr-2"></i>Laporan Siswa
                </h3>
                <p class="text-sm text-slate-500">Pilih siswa untuk download laporan masal (ZIP)</p>
              </div>

              <div id="bulkActionContainer" class="hidden transition-all duration-300">
                 <button onclick="downloadBulkZip()" class="bg-emerald-600 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg hover:bg-emerald-700 hover:shadow-emerald-500/30 transition flex items-center space-x-2">
                    <i class="fas fa-file-zipper"></i>
                    <span>Download ZIP (<span id="selectedCount">0</span>)</span>
                 </button>
              </div>
            </div>

            <div class="relative w-full md:w-1/3 mb-4">
               <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i class="fas fa-search text-slate-400"></i>
               </span>
               <input type="text" id="reportSearch" oninput="filterReportTable(this.value)" 
                  class="w-full pl-10 pr-4 py-2 text-sm border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500" 
                  placeholder="Cari Nama / NIS...">
            </div>
            
            <div class="overflow-x-auto rounded-xl border border-slate-200">
              <table class="w-full text-sm">
                <thead>
                  <tr class="bg-slate-50 border-b border-slate-200 text-slate-600 uppercase tracking-wider text-xs">
                    <th class="py-3 px-4 text-center w-10">
                      <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)" 
                        class="w-4 h-4 text-emerald-600 rounded border-slate-300 focus:ring-emerald-500 cursor-pointer">
                    </th>
                    <th class="text-left py-3 px-4 font-bold">NIS</th>
                    <th class="text-left py-3 px-4 font-bold">Nama Lengkap</th>
                    <th class="text-left py-3 px-4 font-bold">Kelas</th>
                    <th class="text-center py-3 px-4 font-bold">Aksi</th>
                  </tr>
                </thead>
                <tbody id="reportTableBody" class="divide-y divide-slate-100">
                   ${generateReportRows(students)}
                </tbody>
              </table>
            </div>
          </div>
        `;
        
        // Simpan data di window object agar bisa difilter search & selection
        window.allReportStudents = students;
        window.selectedReportIds = new Set(); // Menggunakan Set untuk menyimpan ID unik

      } catch (error) {
        showToast('Terjadi kesalahan: ' + error, 'error');
        content.innerHTML = `<div class="p-4 text-red-500 text-center">Gagal memuat halaman: ${error}</div>`;
      } finally {
        hideLoading();
      }
    }

    // Helper: Generate Table Rows for Report (Updated with Checkbox)
    function generateReportRows(data) {
       if(data.length === 0) return `<tr><td colspan="5" class="py-6 text-center text-slate-400">Tidak ada data siswa.</td></tr>`;
       
       return data.map(s => `
          <tr class="hover:bg-slate-50 transition">
             <td class="py-3 px-4 text-center">
                <input type="checkbox" value="${s.userId}" onchange="toggleStudentSelection('${s.userId}')" 
                  class="student-checkbox w-4 h-4 text-emerald-600 rounded border-slate-300 focus:ring-emerald-500 cursor-pointer">
             </td>
             <td class="py-3 px-4 text-slate-600 font-mono">${s.nis}</td>
             <td class="py-3 px-4 font-medium text-slate-800">${s.name}</td>
             <td class="py-3 px-4 text-slate-500">${s.classId}</td>
             <td class="py-3 px-4 text-center">
                <button onclick="downloadStudentPdf('${s.userId}')" class="text-emerald-600 hover:text-emerald-800 hover:bg-emerald-50 px-3 py-1.5 rounded-lg text-xs font-bold transition" title="Download Individu">
                   <i class="fas fa-download"></i> PDF
                </button>
             </td>
          </tr>
       `).join('');
    }

    // Helper: Filter Search (Updated to preserve checkboxes)
    window.filterReportTable = function(query) {
       if(!window.allReportStudents) return;
       const lower = query.toLowerCase();
       const filtered = window.allReportStudents.filter(s => 
          s.name.toLowerCase().includes(lower) || s.nis.toString().includes(lower)
       );
       document.getElementById('reportTableBody').innerHTML = generateReportRows(filtered);
       
       // Re-check checkboxes based on selection state
       restoreCheckboxState();
    }


// ============================================
    // CHECKBOX SELECTION LOGIC
    // ============================================
    
    function toggleSelectAll(source) {
        const checkboxes = document.querySelectorAll('.student-checkbox');
        const isChecked = source.checked;
        
        checkboxes.forEach(cb => {
            // Hanya centang yang terlihat (hasil filter)
            cb.checked = isChecked;
            const userId = cb.value;
            if (isChecked) {
                window.selectedReportIds.add(userId);
            } else {
                window.selectedReportIds.delete(userId);
            }
        });
        updateBulkUI();
    }

    function toggleStudentSelection(userId) {
        if (window.selectedReportIds.has(userId)) {
            window.selectedReportIds.delete(userId);
        } else {
            window.selectedReportIds.add(userId);
        }
        
        // Update Select All Checkbox state
        const allCheckboxes = document.querySelectorAll('.student-checkbox');
        const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
        document.getElementById('selectAllCheckbox').checked = allChecked && allCheckboxes.length > 0;
        
        updateBulkUI();
    }

    function restoreCheckboxState() {
        const checkboxes = document.querySelectorAll('.student-checkbox');
        checkboxes.forEach(cb => {
            if (window.selectedReportIds.has(cb.value)) {
                cb.checked = true;
            }
        });
        updateBulkUI();
    }

    function updateBulkUI() {
        const count = window.selectedReportIds.size;
        const container = document.getElementById('bulkActionContainer');
        const countSpan = document.getElementById('selectedCount');
        
        countSpan.textContent = count;
        
        if (count > 0) {
            container.classList.remove('hidden');
        } else {
            container.classList.add('hidden');
        }
    }

    // ============================================
    // BULK ZIP DOWNLOAD LOGIC
    // ============================================
    
    async function downloadBulkZip() {
        const selectedIds = Array.from(window.selectedReportIds);
        if (selectedIds.length === 0) return;

        // 1. Inisialisasi JSZip
        const zip = new JSZip();
        
        // 2. Tampilkan Loading Progress Modal (Menggunakan SweetAlert2)
        let processedCount = 0;
        const totalCount = selectedIds.length;
        
        Swal.fire({
            title: 'Sedang Memproses...',
            html: `
                <div class="mb-2">Mengunduh & Mengompres Laporan</div>
                <div class="w-full bg-slate-200 rounded-full h-2.5 mb-4">
                  <div id="zipProgressBar" class="bg-emerald-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <div class="text-sm text-slate-500"><span id="zipProgressText">0</span> / ${totalCount} selesai</div>
            `,
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: async () => {
                
                try {
                    // 3. Loop ID dan Fetch PDF satu per satu
                    for (const userId of selectedIds) {
                        try {
                            // Panggil fungsi generate PDF yang sudah ada di Backend
                            const result = await callServerFunction('generateStudentDetailPDF', authToken, userId);
                            
                            if (result.success) {
                                // Tambahkan file PDF ke dalam folder virtual ZIP
                                // result.base64 adalah string PDF dari backend
                                zip.file(result.filename, result.base64, {base64: true});
                            } else {
                                console.error(`Gagal user ${userId}: ${result.error}`);
                            }
                        } catch (err) {
                            console.error(`Error fetch user ${userId}:`, err);
                        }

                        // Update Progress UI
                        processedCount++;
                        const percentage = Math.round((processedCount / totalCount) * 100);
                        
                        const bar = document.getElementById('zipProgressBar');
                        const text = document.getElementById('zipProgressText');
                        if (bar && text) {
                            bar.style.width = `${percentage}%`;
                            text.textContent = processedCount;
                        }
                    }

                    // 4. Generate File ZIP Akhir
                    Swal.update({ title: 'Finalisasi ZIP...', html: 'Sedang menyatukan file...' });
                    
                    const zipContent = await zip.generateAsync({type: "blob"});
                    
                    // 5. Simpan File (Trigger Download)
                    const timestamp = new Date().toISOString().slice(0,10);
                    saveAs(zipContent, `Laporan_Siswa_Bulk_${timestamp}.zip`);

                    // Tutup Loading & Reset
                    Swal.fire({
                        icon: 'success',
                        title: 'Selesai!',
                        text: `${processedCount} Laporan berhasil diunduh dalam ZIP.`,
                        confirmButtonColor: '#10b981'
                    });
                    
                    // Optional: Reset Selection
                    // window.selectedReportIds.clear();
                    // loadReports(); 

                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Gagal',
                        text: 'Terjadi kesalahan saat membuat ZIP: ' + error
                    });
                }
            }
        });
    }
    // ============================================
    // PDF DOWNLOAD LOGIC
    // ============================================
    async function downloadStudentPdf(targetUserId) {
       showLoading();
       try {
          const result = await callServerFunction('generateStudentDetailPDF', authToken, targetUserId);
          
          if(result.success) {
             // Convert Base64 string to Blob
             const byteCharacters = atob(result.base64);
             const byteNumbers = new Array(byteCharacters.length);
             for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
             }
             const byteArray = new Uint8Array(byteNumbers);
             const blob = new Blob([byteArray], {type: 'application/pdf'});
             
             // Create Download Link
             const link = document.createElement('a');
             link.href = window.URL.createObjectURL(blob);
             link.download = result.filename;
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
             
             showToast('Laporan berhasil diunduh!');
          } else {
             showToast(result.error, 'error');
          }
       } catch(e) {
          showToast('Gagal mengunduh: ' + e, 'error');
       } finally {
          hideLoading();
       }
    }

async function loadLogs() {
      showLoading();
      
      try {
        // Fetch data lebih banyak (misal 500) agar pagination berjalan efektif di sisi client
        const result = await callServerFunction('getActivityLog', authToken, currentUser.schoolId, 500);
        
        if (!result.success) {
          showToast(result.error, 'error');
          return;
        }
        
        // 1. Simpan ke Global State
        globalLogList = result.data;
        
        // 2. Reset State
        currentLogPage = 1;
        logSearchQuery = '';
        
        const content = document.getElementById('contentArea');
        content.innerHTML = `
          <div class="bg-white rounded-2xl p-6 shadow-lg">
            
            <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
              <div>
                <h3 class="text-lg font-bold text-slate-800">
                  <i class="fas fa-history text-emerald-500 mr-2"></i>Log Aktivitas
                </h3>
                <p class="text-sm text-slate-500">Total: ${globalLogList.length} Aktivitas Terakhir</p>
              </div>
            </div>
            
            <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
              
              <div class="flex items-center space-x-2 text-sm text-slate-600">
                <span>Tampilkan</span>
                <select id="logRowsSelect" onchange="handleLogRowsChange(this.value)" class="border border-slate-300 rounded-lg px-2 py-1.5 focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white">
                  <option value="10">10</option>
                  <option value="25">25</option>
                  <option value="50">50</option>
                  <option value="100">100</option>
                  <option value="all">Semua</option>
                </select>
                <span>data</span>
              </div>

              <div class="relative w-full md:w-64">
                <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <i class="fas fa-search text-slate-400"></i>
                </span>
                <input type="text" id="logSearchInput" oninput="handleLogSearch(this.value)" 
                  class="w-full pl-10 pr-4 py-2 text-sm border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-shadow" 
                  placeholder="Cari User, Aktivitas...">
              </div>
            </div>
            
            <div class="overflow-x-auto rounded-xl border border-slate-200">
              <table class="w-full text-sm">
                <thead>
                  <tr class="bg-slate-50 border-b border-slate-200 text-slate-600 uppercase tracking-wider text-xs">
                    <th class="text-left py-3 px-4 font-bold">Waktu</th>
                    <th class="text-left py-3 px-4 font-bold">User</th>
                    <th class="text-left py-3 px-4 font-bold">Aktivitas</th>
                    <th class="text-left py-3 px-4 font-bold">Detail</th>
                  </tr>
                </thead>
                <tbody id="logTableBody" class="divide-y divide-slate-100">
                   </tbody>
              </table>
            </div>

            <div id="logPagination" class="flex flex-col md:flex-row justify-between items-center mt-4 gap-4 text-sm text-slate-600">
               </div>

          </div>
        `;

        // 3. Render Tabel Pertama Kali
        renderLogTable();

      } catch (error) {
        showToast('Terjadi kesalahan: ' + error, 'error');
      } finally {
        hideLoading();
      }
    }

async function loadAnnouncementPage() {
  showLoading();
  const content = document.getElementById('contentArea');
  
  try {
    // 1. Load Data Kelas & History Pengumuman (Parallel)
    const [classRes, historyRes] = await Promise.all([
       callServerFunction('getClasses', authToken, currentUser.schoolId),
       callServerFunction('getSentAnnouncements', authToken)
    ]);
    
    const classes = classRes.success ? classRes.data : [];
    const history = historyRes.success ? historyRes.data : [];

    // Filter Kelas untuk Wali Kelas (Hanya kelas dia)
    let availableClasses = classes;
    if (currentUser.role === 'walikelas') {
       availableClasses = classes.filter(c => c.classId === currentUser.classId);
    }

    content.innerHTML = `
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <div class="lg:col-span-1">
           <div class="bg-white rounded-2xl p-6 shadow-lg border-t-4 border-orange-500">
              <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
                 <i class="fas fa-paper-plane text-orange-500 mr-2"></i>Buat Pengumuman
              </h3>
              
              <form id="announcementForm" class="space-y-4">
                 
                 <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Judul Pengumuman</label>
                    <input type="text" id="ann_title" required class="w-full px-4 py-2 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-orange-500 text-sm" placeholder="Contoh: Jadwal Libur">
                 </div>

                 <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Isi Pesan</label>
                    <textarea id="ann_content" rows="4" required class="w-full px-4 py-2 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-orange-500 text-sm" placeholder="Tulis pesan anda disini..."></textarea>
                 </div>

                 <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Jenis Tujuan</label>
                    <select id="ann_type" onchange="toggleAnnTarget(this.value)" class="w-full px-4 py-2 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-orange-500 bg-white text-sm">
                       <option value="class">Satu Kelas (Broadcast)</option>
                       <option value="personal">Personal (Satu Siswa)</option>
                    </select>
                 </div>

                 <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">Pilih Kelas</label>
                    <select id="ann_classId" onchange="loadStudentsForAnn(this.value)" class="w-full px-4 py-2 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-orange-500 bg-white text-sm">
                       <option value="">-- Pilih Kelas --</option>
                       ${availableClasses.map(c => `<option value="${c.classId}">${c.name}</option>`).join('')}
                    </select>
                 </div>

                 <div id="studentTargetContainer" class="hidden">
                    <label class="block text-xs font-bold text-slate-500 mb-1">Pilih Siswa</label>
                    <select id="ann_studentId" class="w-full px-4 py-2 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-orange-500 bg-white text-sm disabled:bg-slate-100" disabled>
                       <option value="">-- Pilih Kelas Terlebih Dahulu --</option>
                    </select>
                 </div>

                 <button type="submit" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-orange-500/30 transition transform active:scale-95 flex items-center justify-center space-x-2">
                    <i class="fas fa-bullhorn"></i>
                    <span>Kirim Pengumuman</span>
                 </button>

              </form>
           </div>
        </div>

        <div class="lg:col-span-2">
           <div class="bg-white rounded-2xl p-6 shadow-lg">
              <h3 class="text-lg font-bold text-slate-800 mb-4">
                 <i class="fas fa-history text-slate-400 mr-2"></i>Riwayat Terkirim
              </h3>
              
              <div class="space-y-4 max-h-[600px] overflow-y-auto custom-scrollbar">
                 ${history.length > 0 ? history.map(item => `
                    <div class="border border-slate-200 rounded-xl p-4 hover:bg-slate-50 transition relative group">
                       
                       <button onclick="deleteAnn('${item.id}')" class="absolute top-4 right-4 text-red-400 hover:text-red-600 opacity-0 group-hover:opacity-100 transition z-10" title="Hapus Pengumuman">
                          <i class="fas fa-trash"></i>
                       </button>

                       <div class="flex items-center space-x-2 mb-2">
                          <span class="text-xs font-bold px-2 py-0.5 rounded ${item.type === 'class' ? 'bg-blue-100 text-blue-600' : 'bg-purple-100 text-purple-600'} uppercase tracking-wider">
                             ${item.type === 'class' ? 'Kelas' : 'Personal'}
                          </span>
                          <span class="text-xs text-slate-400"> ${item.date}</span>
                       </div>
                       
                       <h4 class="font-bold text-slate-800">${item.title}</h4>
                       <p class="text-sm text-slate-600 mt-1 line-clamp-2">${item.content}</p>
                       
                       <div class="mt-3 flex items-center justify-between border-t border-slate-100 pt-2">
                          <div class="text-xs text-slate-400 flex items-center">
                             <i class="fas fa-user-circle mr-1"></i> Oleh: ${item.sender}
                          </div>
                          
                          <button onclick="showReaders('${item.id}', '${item.title}')" class="text-xs font-bold text-emerald-600 hover:text-emerald-800 flex items-center bg-emerald-50 px-3 py-1.5 rounded-lg border border-emerald-100 transition hover:bg-emerald-100">
                             <i class="fas fa-eye mr-1.5"></i> Lihat Status Baca
                          </button>
                       </div>

                    </div>
                 `).join('') : '<p class="text-center text-slate-400 italic py-8">Belum ada pengumuman terkirim.</p>'}
              </div>
           </div>
        </div>

      </div>
    `;

    // Handler Form
    document.getElementById('announcementForm').addEventListener('submit', handleAnnouncementSubmit);

  } catch (err) {
     showToast(err, 'error');
  } finally {
     hideLoading();
  }
}

// ============================================
// HELPER: POPUP LIHAT PEMBACA
// ============================================
window.showReaders = async function(id, title) {
   // Tampilkan Loading di dalam SweetAlert
   Swal.fire({
      title: 'Memuat Data...',
      didOpen: () => Swal.showLoading(),
      allowOutsideClick: false
   });

   try {
      const res = await callServerFunction('getAnnouncementReaders', authToken, id);
      Swal.close(); // Tutup loading

      if(res.success) {
         const readers = res.data;
         
         // Generate Tabel HTML
         let htmlTable = `
            <div class="overflow-y-auto max-h-60 text-left">
               <table class="w-full text-sm text-slate-600">
                  <thead class="bg-slate-100 text-xs font-bold uppercase sticky top-0 z-10">
                     <tr>
                        <th class="p-2 text-slate-700">Nama Siswa</th>
                        <th class="p-2 text-slate-700 text-right">Waktu Baca</th>
                     </tr>
                  </thead>
                  <tbody>
                     ${readers.length > 0 ? readers.map(r => `
                        <tr class="border-b border-slate-50 last:border-0 hover:bg-slate-50">
                           <td class="p-2">
                              <div class="font-bold text-slate-800 text-sm">${r.name}</div>
                              <div class="text-[10px] text-slate-400">${r.classId}  ${r.nis}</div>
                           </td>
                           <td class="p-2 text-xs font-mono text-right text-emerald-600">
                              ${r.readTime}
                           </td>
                        </tr>
                     `).join('') : `
                        <tr>
                           <td colspan="2" class="p-6 text-center italic text-slate-400">
                              <i class="fas fa-user-clock mb-1 block text-lg"></i>
                              Belum ada siswa yang membaca
                           </td>
                        </tr>
                     `}
                  </tbody>
               </table>
            </div>
         `;

         // Tampilkan Modal Hasil
         Swal.fire({
            title: `<span class="text-base font-bold text-slate-700">Status: "${title}"</span>`,
            html: htmlTable,
            width: '500px',
            showConfirmButton: false,
            showCloseButton: true,
            customClass: {
               popup: 'rounded-2xl',
               title: 'text-left'
            }
         });
      } else {
         showToast(res.error, 'error');
      }
   } catch(e) {
      Swal.close();
      showToast('Gagal memuat: '+e, 'error');
   }
}

// Helper Logic UI
window.toggleAnnTarget = function(type) {
   const studentDiv = document.getElementById('studentTargetContainer');
   if (type === 'personal') {
      studentDiv.classList.remove('hidden');
      document.getElementById('ann_studentId').setAttribute('required', 'true');
   } else {
      studentDiv.classList.add('hidden');
      document.getElementById('ann_studentId').removeAttribute('required');
   }
}

window.loadStudentsForAnn = async function(classId) {
   const studentSelect = document.getElementById('ann_studentId');
   
   if (!classId) {
      studentSelect.innerHTML = '<option value="">-- Pilih Kelas Dulu --</option>';
      studentSelect.disabled = true;
      return;
   }

   studentSelect.innerHTML = '<option value="">Memuat...</option>';
   
   try {
      const res = await callServerFunction('getUsers', authToken, currentUser.schoolId, classId);
      if (res.success) {
         const students = res.data.filter(u => u.role === 'siswa');
         studentSelect.innerHTML = '<option value="">-- Pilih Siswa --</option>';
         students.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.userId;
            opt.textContent = `${s.name} (${s.nis})`;
            studentSelect.appendChild(opt);
         });
         studentSelect.disabled = false;
      }
   } catch (e) { console.error(e); }
}

async function handleAnnouncementSubmit(e) {
   e.preventDefault();
   const title = document.getElementById('ann_title').value;
   const content = document.getElementById('ann_content').value;
   const type = document.getElementById('ann_type').value;
   const classId = document.getElementById('ann_classId').value;
   const studentId = document.getElementById('ann_studentId').value;

   if (!classId) { showToast('Pilih kelas terlebih dahulu', 'error'); return; }
   
   // Tentukan Target ID (Jika Class -> ClassID, Jika Personal -> StudentID)
   const targetId = (type === 'class') ? classId : studentId;

   showLoading();
   try {
      const res = await callServerFunction('createAnnouncement', authToken, title, content, type, targetId);
      if(res.success) {
         showToast('Pengumuman terkirim!');
         loadAnnouncementPage(); // Refresh
      } else {
         showToast(res.error, 'error');
      }
   } catch(err) { showToast(err, 'error'); } 
   finally { hideLoading(); }
}

window.deleteAnn = function(id) {
   Swal.fire({
     title: 'Hapus Pengumuman?',
     icon: 'warning',
     showCancelButton: true,
     confirmButtonText: 'Ya, Hapus'
   }).then(async (result) => {
     if(result.isConfirmed) {
        showLoading();
        try {
           const res = await callServerFunction('deleteAnnouncement', authToken, id);
           if(res.success) {
              showToast('Dihapus');
              loadAnnouncementPage();
           } else showToast(res.error, 'error');
        } catch(e) { showToast(e, 'error'); }
        finally { hideLoading(); }
     }
   });
}


    // ============================================
    // LOGIKA TOGGLE PASSWORD
    // ============================================
    document.getElementById('togglePassword').addEventListener('click', function() {
        // 1. Ambil elemen input password dan ikon mata
        const passwordInput = document.getElementById('passwordInput');
        const eyeIcon = document.getElementById('eyeIcon');
        
        // 2. Cek tipe saat ini (password atau text)
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        
        // 3. Ubah tipe input
        passwordInput.setAttribute('type', type);
        
        // 4. Ubah ikon (mata terbuka <-> mata dicoret)
        if (type === 'text') {
            eyeIcon.classList.remove('fa-eye');
            eyeIcon.classList.add('fa-eye-slash');
        } else {
            eyeIcon.classList.remove('fa-eye-slash');
            eyeIcon.classList.add('fa-eye');
        }
    });
    // ============================================
    // INITIALIZATION ON PAGE LOAD
    // ============================================
    window.onload = function() {
      // Check if already logged in
      const savedToken = sessionStorage.getItem('authToken');
      const savedUser = sessionStorage.getItem('currentUser');
      
      if (savedToken && savedUser) {
        authToken = savedToken;
        currentUser = JSON.parse(savedUser);
        
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('appContainer').classList.remove('hidden');
        
        initializeApp();
      } else {
        // Initialize login page
        initializeLogin();
      }
    };
  </script>
</body>
</html>